<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LawnConnect Demo</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .bg-lawn {
            background-color: #10B981; /* A nice green for the theme */
        }
        .text-lawn {
            color: #10B981;
        }
        .border-lawn {
            border-color: #10B981;
        }
        .nav-link {
            transition: all 0.2s ease-in-out;
            position: relative;
        }
        .nav-link::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -5px;
            width: 0;
            height: 2px;
            background-color: currentColor;
            transition: width 0.3s ease-in-out;
        }
        .nav-link:hover::after, .nav-link.active::after {
            width: 100%;
        }
        .star-rating {
            display: inline-block;
        }
        .star-rating .star {
            color: #ccc;
            cursor: pointer;
            font-size: 1.5rem;
            transition: color 0.2s;
        }
        .star-rating .star.filled {
            color: #ffc107;
        }
        .pagination-button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            background-color: white;
            transition: background-color 0.2s;
        }
        .pagination-button:hover:not(:disabled) {
            background-color: #f9fafb;
        }
        .pagination-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-button.active {
            background-color: #10B981;
            color: white;
            border-color: #10B981;
        }
        /* Custom modal styles */
        .modal {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 28rem; /* Equivalent to max-w-md */
            margin: 1rem; /* Equivalent to m-4 */
            position: relative;
            animation: slideIn 0.3s ease-out;
        }
        .modal-close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: #9ca3af; /* gray-400 */
            cursor: pointer;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Main Application Container -->
    <div id="app" class="relative">

        <!-- Mobile Menu (Hidden by default) -->
        <div id="mobile-menu" class="fixed top-0 left-0 w-full h-full bg-gray-900 bg-opacity-75 z-50 transform -translate-x-full transition-transform ease-in-out duration-300 md:hidden">
            <div class="h-full w-64 bg-white p-6 shadow-lg relative">
                <button id="close-menu-button" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <div class="flex flex-col space-y-4 mt-8">
                    <div id="mobile-nav-customer" class="hidden">
                        <a href="#" onclick="renderContent('customer-dashboard-view')" class="text-gray-800 hover:text-lawn font-medium py-2">Dashboard</a>
                        <a href="#" onclick="renderContent('customer-new-booking-view')" class="text-gray-800 hover:text-lawn font-medium py-2">New Booking</a>
                        <a href="#" onclick="renderContent('customer-bookings-view')" class="text-gray-800 hover:text-lawn font-medium py-2">My Bookings</a>
                        <a href="#" onclick="renderContent('customer-invoices-view')" class="text-gray-800 hover:text-lawn font-medium py-2">Invoices</a>
                        <a href="#" onclick="renderContent('customer-profile-view')" class="text-gray-800 hover:text-lawn font-medium py-2">My Profile</a>
                    </div>
                    <div id="mobile-nav-mower" class="hidden">
                        <a href="#" onclick="renderContent('mower-dashboard-view')" class="text-gray-800 hover:text-lawn font-medium py-2">Dashboard</a>
                        <a href="#" onclick="renderContent('mower-all-jobs-view')" class="text-gray-800 hover:text-lawn font-medium py-2">Jobs</a>
                        <a href="#" onclick="renderContent('mower-invoices-view')" class="text-gray-800 hover:text-lawn font-medium py-2">My Invoices</a>
                        <a href="#" onclick="renderContent('mower-profile-view')" class="text-gray-800 hover:text-lawn font-medium py-2">My Profile</a>
                    </div>
                    <div id="mobile-nav-admin" class="hidden">
                        <a href="#" onclick="renderContent('admin-dashboard-view')" class="text-gray-800 hover:text-lawn font-medium py-2">Dashboard</a>
                        <a href="#" onclick="renderContent('admin-users-view')" class="text-gray-800 hover:text-lawn font-medium py-2">Manage Users</a>
                        <a href="#" onclick="renderContent('admin-bookings-view')" class="text-gray-800 hover:text-lawn font-medium py-2">All Bookings</a>
                        <a href="#" onclick="renderContent('admin-invoices-view')" class="text-gray-800 hover:text-lawn font-medium py-2">Invoices</a>
                    </div>
                    <div id="mobile-nav-super_admin" class="hidden">
                        <a href="#" onclick="renderContent('super_admin-dashboard-view')" class="text-gray-800 hover:text-lawn font-medium py-2">Dashboard</a>
                        <a href="#" onclick="renderContent('admin-users-view')" class="text-gray-800 hover:text-lawn font-medium py-2">Manage Users</a>
                        <a href="#" onclick="renderContent('admin-bookings-view')" class="text-gray-800 hover:text-lawn font-medium py-2">All Bookings</a>
                        <a href="#" onclick="renderContent('admin-invoices-view')" class="text-gray-800 hover:text-lawn font-medium py-2">Invoices</a>
                        <a href="#" onclick="renderContent('super_admin-add-admin-view')" class="text-gray-800 hover:text-lawn font-medium py-2">Add Admin</a>
                    </div>
                    <a href="#" id="mobile-logout-button" class="text-red-500 hover:text-red-700 font-medium py-2">Logout</a>
                </div>
            </div>
        </div>

        <!-- Landing Page View -->
        <div id="landing-page-view" class="h-screen flex items-center justify-center bg-gray-100">
            <div class="w-full max-w-2xl bg-white rounded-xl shadow-lg p-8 m-4 text-center">
                   <div class="flex justify-center mb-4">
                    <span class="inline-block p-4 rounded-full bg-lawn text-white shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-leaf"><path d="M11 20A7 2 0 0 1 9.8 6.1C15.5 5 17 4.4 18 2c1 2.9-.6 5.8-2 7.6-2.2 2.8-4.7 2.8-7.5 5-.3.3-.6.6-.9.9l-4.5 4.5c-.8.8-2 .8-2.8 0s-.8-2 0-2.8l4.5-4.5c.3-.3.6-.5.9-.9C7.8 7.3 12 2 12 2l-2 2c-5.2 2.7-10 2.3-13.7 4.1a1.2 1.2 0 0 0 0 2.2C4 12.1 11 11.2 11 20z"/></svg>
                    </span>
                </div>
                <h1 class="text-4xl font-bold text-gray-800 mb-4">Welcome to LawnConnect</h1>
                <p class="text-xl text-gray-600 mb-8">Connecting you with local lawn care professionals for on-demand services, making lawn maintenance easier than ever.</p>
                
                <div class="mb-12">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-6">How It Works</h2>
                    <p class="text-lg text-gray-600 mb-8">LawnConnect is a simple, two-sided marketplace. Customers can easily request and schedule services, while providers can manage their jobs and grow their business.</p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bg-gray-50 p-6 rounded-lg shadow-sm">
                            <h3 class="font-semibold text-lg text-gray-900 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-user"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> For Customers</h3>
                            <ul class="list-disc list-inside text-left text-gray-700 space-y-2">
                                <li>Create a booking with your service needs.</li>
                                <li>Get matched with a nearby professional.</li>
                                <li>Rate the service after completion.</li>
                            </ul>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-lg shadow-sm">
                            <h3 class="font-semibold text-lg text-gray-900 flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shovel"><path d="M2 22v-5l5-5 5 5-5 5z"/><path d="M17 2L9.5 9.5"/><path d="M13.5 6.5l4 4"/></svg> For Providers</h3>
                            <ul class="list-disc list-inside text-left text-gray-700 space-y-2">
                                <li>Accept or reject job requests.</li>
                                <li>Manage your schedule and profile.</li>
                                <li>Grow your business with more ratings.</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <button onclick="showRegisterFormFromLanding()" class="w-full sm:w-auto bg-lawn text-white py-3 px-8 rounded-lg font-semibold hover:bg-green-600 transition-colors duration-200 shadow-md text-lg">Sign Up</button>
                    <button onclick="showLoginFormFromLanding()" class="w-full sm:w-auto bg-gray-200 text-gray-800 py-3 px-8 rounded-lg font-semibold hover:bg-gray-300 transition-colors duration-200 shadow-md text-lg">Log In</button>
                </div>
            </div>
        </div>

        <!-- Auth View (Hidden by default, shown by landing page buttons) -->
        <div id="auth-view" class="h-screen hidden flex items-center justify-center bg-gray-100">
            <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-8 m-4">
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">LawnConnect</h1>
                    <p class="text-gray-500">The On-Demand Lawn Mowing Service</p>
                </div>
                
                <h2 id="auth-title" class="text-xl font-semibold text-center mb-6 text-gray-700">Login</h2>

                <!-- Login Form -->
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="sr-only">Email</label>
                        <input type="email" id="login-email" name="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-lawn focus:border-transparent transition-colors duration-200" placeholder="Email Address">
                    </div>
                    <div class="relative">
                        <label for="login-password" class="sr-only">Password</label>
                        <input type="password" id="login-password" name="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-lawn focus:border-transparent transition-colors duration-200" placeholder="Password">
                        <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400" onclick="togglePasswordVisibility('login-password')">
                            <svg id="login-password-icon" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        </button>
                    </div>
                    <div id="login-error" class="text-red-500 text-sm text-center hidden"></div>
                    <button type="submit" class="w-full bg-lawn text-white py-3 rounded-lg font-semibold hover:bg-green-600 transition-colors duration-200 shadow-md">Login</button>
                </form>

                <!-- Register Form (Hidden by default) -->
                <form id="register-form" class="space-y-4 hidden">
                    <div>
                        <label for="register-name" class="sr-only">Full Name</label>
                        <input type="text" id="register-name" name="name" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Full Name">
                    </div>
                    <div>
                        <label for="register-email" class="sr-only">Email</label>
                        <input type="email" id="register-email" name="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Email Address">
                    </div>
                    <div class="relative">
                        <label for="register-password" class="sr-only">Password</label>
                        <input type="password" id="register-password" name="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Password">
                        <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400" onclick="togglePasswordVisibility('register-password')">
                            <svg id="register-password-icon" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        </button>
                    </div>
                    <div>
                        <label for="register-role" class="sr-only">Register as</label>
                        <select id="register-role" name="role" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="customer">Customer</option>
                            <option value="mower">Service Provider</option>
                        </select>
                    </div>
                    <!-- Mower specific fields -->
                    <div id="mower-fields-container" class="space-y-4 hidden">
                         <div>
                            <label class="block text-sm font-medium text-gray-700">Services Offered</label>
                            <div id="register-services-list" class="flex flex-wrap gap-2 mt-1">
                                <label class="inline-flex items-center"><input type="checkbox" name="services" value="Mowing" class="form-checkbox text-lawn rounded"><span class="ml-2">Mowing</span></label>
                                <label class="inline-flex items-center"><input type="checkbox" name="services" value="Weeding" class="form-checkbox text-lawn rounded"><span class="ml-2">Weeding</span></label>
                                <label class="inline-flex items-center"><input type="checkbox" name="services" value="Trimming" class="form-checkbox text-lawn rounded"><span class="ml-2">Trimming</span></label>
                            </div>
                            <div class="flex mt-2">
                                <input type="text" id="register-custom-service" class="w-full px-3 py-2 border border-gray-300 rounded-l-lg" placeholder="Add another service...">
                                <button type="button" id="add-custom-service-btn" class="bg-gray-200 px-4 rounded-r-lg hover:bg-gray-300">Add</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Availability</label>
                            <div id="register-availability-container" class="space-y-2">
                                <!-- Availability fields will be added here -->
                            </div>
                            <button type="button" id="add-availability-slot-btn" class="mt-2 text-sm text-lawn hover:underline">+ Add day/time</button>
                        </div>
                        <div>
                            <label for="register-hourly-rate" class="block text-sm font-medium text-gray-700">Hourly Rate (₦)</label>
                            <input type="number" id="register-hourly-rate" name="hourlyRate" class="mt-1 w-full px-4 py-2 border rounded-lg" placeholder="e.g., 5000" min="0" step="100">
                        </div>
                    </div>
                    <div id="register-error" class="text-red-500 text-sm text-center hidden"></div>
                    <button type="submit" class="w-full bg-lawn text-white py-3 rounded-lg font-semibold hover:bg-green-600 shadow-md">Register</button>
                </form>

                <!-- Admin Password Change Form (Hidden by default) -->
                <form id="admin-password-change-form" class="space-y-4 hidden">
                    <h2 class="text-xl font-semibold text-center mb-4 text-gray-700">Change Password</h2>
                    <p class="text-gray-500 text-center mb-4">Please change your default password to continue.</p>
                    <div class="relative">
                        <label for="new-password" class="sr-only">New Password</label>
                        <input type="password" id="new-password" name="new-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="New Password">
                        <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400" onclick="togglePasswordVisibility('new-password')">
                            <svg id="new-password-icon" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        </button>
                    </div>
                    <div class="relative">
                        <label for="confirm-password" class="sr-only">Confirm Password</label>
                        <input type="password" id="confirm-password" name="confirm-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Confirm New Password">
                        <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400" onclick="togglePasswordVisibility('confirm-password')">
                            <svg id="confirm-password-icon" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        </button>
                    </div>
                    <div id="password-change-error" class="text-red-500 text-sm text-center hidden"></div>
                    <button type="submit" class="w-full bg-lawn text-white py-3 rounded-lg font-semibold hover:bg-green-600 shadow-md">Set New Password</button>
                </form>

                <div class="mt-6 text-center text-gray-500">
                    <p id="toggle-auth-text">Don't have an account? <button type="button" id="toggle-auth-button" class="text-lawn hover:underline font-medium">Register</button></p>
                    <p class="mt-2">Forgot your password? <button type="button" id="forgot-password-button" class="text-lawn hover:underline font-medium">Reset here</button></p>
                </div>
            </div>
        </div>

        <!-- Dashboard View (Hidden by default) -->
        <div id="dashboard-view" class="h-screen hidden flex flex-col md:flex-row">
            
            <!-- Sidebar -->
            <aside class="w-full md:w-64 bg-white shadow-xl flex flex-col z-40">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800">LawnConnect</h2>
                </div>
                <nav class="flex-1 p-6 space-y-2 overflow-y-auto">
                    <!-- Customer Navigation -->
                    <div id="nav-customer" class="hidden">
                        <a href="#" onclick="renderContent('customer-dashboard-view')" class="flex items-center p-3 text-gray-600 rounded-lg hover:bg-gray-100 nav-link active">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                            Dashboard
                        </a>
                        <a href="#" onclick="renderContent('customer-new-booking-view')" class="flex items-center p-3 text-gray-600 rounded-lg hover:bg-gray-100 nav-link">
                           <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"></path></svg>
                            New Booking
                        </a>
                        <a href="#" onclick="renderContent('customer-bookings-view')" class="flex items-center p-3 text-gray-600 rounded-lg hover:bg-gray-100 nav-link">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            My Bookings
                        </a>
                        <a href="#" onclick="renderContent('customer-invoices-view')" class="flex items-center p-3 text-gray-600 rounded-lg hover:bg-gray-100 nav-link">
                           <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" ><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 2H7a2 2 0 01-2-2V5a2 2 0 012-2h10a2 2 0 012 2v14a2 2 0 01-2 2z"></path></svg>
                            Invoices
                        </a>
                        <a href="#" onclick="renderContent('customer-profile-view')" class="flex items-center p-3 text-gray-600 rounded-lg hover:bg-gray-100 nav-link">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            My Profile
                        </a>
                    </div>
                    <!-- Mower Navigation -->
                    <div id="nav-mower" class="hidden">
                        <a href="#" onclick="renderContent('mower-dashboard-view')" class="flex items-center p-3 text-gray-600 rounded-lg hover:bg-gray-100 nav-link active">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                            Dashboard
                        </a>
                        <a href="#" onclick="renderContent('mower-all-jobs-view')" class="flex items-center p-3 text-gray-600 rounded-lg hover:bg-gray-100 nav-link">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                            Jobs
                        </a>
                        <a href="#" onclick="renderContent('mower-invoices-view')" class="flex items-center p-3 text-gray-600 rounded-lg hover:bg-gray-100 nav-link">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 2H7a2 2 0 01-2-2V5a2 2 0 012-2h10a2 2 0 012 2v14a2 2 0 01-2 2z"></path></svg>
                            My Invoices
                        </a>
                        <a href="#" onclick="renderContent('mower-profile-view')" class="flex items-center p-3 text-gray-600 rounded-lg hover:bg-gray-100 nav-link">
                           <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            My Profile
                        </a>
                    </div>
                    <!-- Admin Navigation -->
                    <div id="nav-admin" class="hidden">
                        <a href="#" onclick="renderContent('admin-dashboard-view')" class="flex items-center p-3 text-gray-600 rounded-lg hover:bg-gray-100 nav-link active">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                            Dashboard
                        </a>
                        <a href="#" onclick="renderContent('admin-users-view')" class="flex items-center p-3 text-gray-600 rounded-lg hover:bg-gray-100 nav-link">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a4 4 0 0112 0v1zm-6-4a4 4 0 00-4 4v1"></path></svg>
                            Manage Users
                        </a>
                        <a href="#" onclick="renderContent('admin-bookings-view')" class="flex items-center p-3 text-gray-600 rounded-lg hover:bg-gray-100 nav-link">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            All Bookings
                        </a>
                        <a href="#" onclick="renderContent('admin-invoices-view')" class="flex items-center p-3 text-gray-600 rounded-lg hover:bg-gray-100 nav-link">
                           <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 2H7a2 2 0 01-2-2V5a2 2 0 012-2h10a2 2 0 012 2v14a2 2 0 01-2 2z"></path></svg>
                            Invoices
                        </a>
                    </div>
                    <!-- Super Admin Navigation -->
                    <div id="nav-super_admin" class="hidden">
                        <a href="#" onclick="renderContent('super_admin-dashboard-view')" class="flex items-center p-3 text-gray-600 rounded-lg hover:bg-gray-100 nav-link active">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                            Dashboard
                        </a>
                        <a href="#" onclick="renderContent('admin-users-view')" class="flex items-center p-3 text-gray-600 rounded-lg hover:bg-gray-100 nav-link">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a4 4 0 0112 0v1zm-6-4a4 4 0 00-4 4v1"></path></svg>
                            Manage Users
                        </a>
                        <a href="#" onclick="renderContent('admin-bookings-view')" class="flex items-center p-3 text-gray-600 rounded-lg hover:bg-gray-100 nav-link">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            All Bookings
                        </a>
                        <a href="#" onclick="renderContent('admin-invoices-view')" class="flex items-center p-3 text-gray-600 rounded-lg hover:bg-gray-100 nav-link">
                           <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 2H7a2 2 0 01-2-2V5a2 2 0 012-2h10a2 2 0 012 2v14a2 2 0 01-2 2z"></path></svg>
                            Invoices
                        </a>
                        <a href="#" onclick="renderContent('super_admin-add-admin-view')" class="flex items-center p-3 text-gray-600 rounded-lg hover:bg-gray-100 nav-link">
                           <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            Add Admin
                        </a>
                    </div>
                </nav>
                <div class="p-6 border-t border-gray-200">
                    <button id="logout-button" class="w-full flex items-center justify-center p-3 text-red-500 rounded-lg hover:bg-red-50 font-semibold">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1m0-10V4"></path></svg>
                        Logout
                    </button>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="flex-1 overflow-y-auto bg-gray-100 p-6 md:p-8">
                <header class="flex items-center justify-between pb-6 border-b border-gray-200 mb-6">
                    <h1 id="page-title" class="text-3xl font-bold text-gray-800">Dashboard</h1>
                    <div class="flex items-center space-x-4">
                        <span id="user-display-name" class="font-medium text-gray-700 hidden md:block"></span>
                        <div id="user-avatar" class="w-10 h-10 bg-lawn text-white flex items-center justify-center rounded-full font-bold text-lg overflow-hidden hidden md:flex">
                             <img id="user-avatar-img" src="" alt="User Avatar" class="w-full h-full object-cover hidden" onerror="this.classList.add('hidden'); this.parentElement.querySelector('span').classList.remove('hidden');">
                             <span id="user-avatar-initials" class="hidden"></span>
                        </div>
                        <button id="menu-button" class="text-gray-500 md:hidden hover:text-gray-700">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                    </div>
                </header>
                
                <!-- Content Sections -->
                <div id="content-container">
                    
                    <!-- Customer Dashboard -->
                    <div id="customer-dashboard-view" class="space-y-8 hidden">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Customer Dashboard</h2>
                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Upcoming Booking</h3>
                                <p id="customer-upcoming-booking" class="text-gray-500">No upcoming bookings.</p>
                            </div>
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Total Spent</h3>
                                <p id="customer-total-spent" class="text-2xl font-bold text-lawn">₦0.00</p>
                            </div>
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Completed Bookings</h3>
                                <p id="customer-completed-bookings" class="text-2xl font-bold text-lawn">0</p>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4">Quick Actions</h3>
                            <button onclick="renderContent('customer-new-booking-view')" class="bg-lawn text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-600 shadow-md">Book a Mowing Service</button>
                        </div>
                    </div>

                    <!-- Customer Profile View -->
                    <div id="customer-profile-view" class="space-y-8 hidden">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">My Profile</h2>
                            <form id="customer-profile-form" class="space-y-6">
                                <div class="flex items-center space-x-4">
                                    <div id="customer-profile-current-avatar" class="w-24 h-24 bg-gray-200 text-gray-600 flex items-center justify-center rounded-full text-4xl font-bold overflow-hidden">
                                        <img id="customer-profile-img" src="" alt="Profile Avatar" class="w-full h-full object-cover hidden" onerror="this.classList.add('hidden'); this.parentElement.querySelector('span').classList.remove('hidden');">
                                        <span id="customer-profile-initials"></span>
                                    </div>
                                    <div>
                                        <label for="customer-profile-picture" class="block text-sm font-medium text-gray-700 mb-1">Update Profile Picture</label>
                                        <input type="file" id="customer-profile-picture" name="profilePicture" accept="image/*" class="w-full text-sm text-gray-500
                                            file:mr-4 file:py-2 file:px-4
                                            file:rounded-full file:border-0
                                            file:text-sm file:font-semibold
                                            file:bg-lawn file:text-white
                                            hover:file:bg-green-600"/>
                                    </div>
                                </div>
                                <div>
                                    <label for="customer-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                                    <input type="text" id="customer-name" name="name" class="mt-1 w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label for="customer-phone-number" class="block text-sm font-medium text-gray-700">Phone Number</label>
                                    <input type="tel" id="customer-phone-number" name="phoneNumber" class="mt-1 w-full px-4 py-2 border rounded-lg" placeholder="e.g., +2348012345678">
                                </div>
                                <div id="customer-profile-error" class="text-red-500 text-sm text-center hidden"></div>
                                <button type="submit" class="w-full bg-lawn text-white py-3 rounded-lg font-semibold hover:bg-green-600 shadow-md">Update Profile</button>
                            </form>

                            <h3 class="text-xl font-bold text-gray-800 mt-8 mb-4">Change Password</h3>
                            <form id="customer-password-change-form" class="space-y-4">
                                <div class="relative">
                                    <label for="customer-new-password" class="sr-only">New Password</label>
                                    <input type="password" id="customer-new-password" name="new-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="New Password">
                                    <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400" onclick="togglePasswordVisibility('customer-new-password')">
                                        <svg id="customer-new-password-icon" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                    </button>
                                </div>
                                <div class="relative">
                                    <label for="customer-confirm-password" class="sr-only">Confirm Password</label>
                                    <input type="password" id="customer-confirm-password" name="confirm-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Confirm New Password">
                                    <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400" onclick="togglePasswordVisibility('customer-confirm-password')">
                                        <svg id="customer-confirm-password-icon" class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                                    </button>
                                </div>
                                <div id="customer-password-change-error" class="text-red-500 text-sm text-center hidden"></div>
                                <button type="submit" class="w-full bg-lawn text-white py-3 rounded-lg font-semibold hover:bg-green-600 shadow-md">Change Password</button>
                            </form>
                        </div>
                    </div>

                    <!-- Customer New Booking -->
                    <div id="customer-new-booking-view" class="space-y-8 hidden">
                        <h2 class="text-2xl font-bold text-gray-800">Available Providers</h2>
                        <div id="available-providers-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <!-- Provider cards will be rendered here -->
                        </div>
                    </div>
                    
                    <!-- Customer Bookings List -->
                    <div id="customer-bookings-view" class="space-y-4 hidden">
                         <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <input type="text" id="customer-bookings-search" placeholder="Search..." class="w-full px-4 py-2 border rounded-lg">
                                <select id="customer-bookings-status-filter" class="w-full px-4 py-2 border rounded-lg">
                                    <option value="all">All Statuses</option>
                                    <option value="pending">Pending</option>
                                    <option value="accepted">Accepted</option>
                                    <option value="ongoing">Ongoing</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                                <input type="date" id="customer-bookings-date-filter" class="w-full px-4 py-2 border rounded-lg">
                                <button onclick="renderCustomerBookingsTable()" class="bg-lawn text-white py-2 rounded-lg font-semibold hover:bg-green-600 col-span-full md:col-span-1">Filter</button>
                            </div>
                            <div class="flex justify-between items-center mb-4">
                                <label for="customer-bookings-items-per-page" class="text-sm font-medium text-gray-700">Items per page:</label>
                                <select id="customer-bookings-items-per-page" class="px-3 py-2 border rounded-lg">
                                    <option value="5">5</option>
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                </select>
                            </div>
                            <div id="customer-bookings-table-container" class="overflow-x-auto"></div>
                            <div id="customer-bookings-pagination" class="mt-4 flex justify-end space-x-2"></div>
                        </div>
                    </div>

                    <!-- Customer Invoices List -->
                    <div id="customer-invoices-view" class="space-y-4 hidden">
                         <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <input type="text" id="customer-invoices-search" placeholder="Search..." class="w-full px-4 py-2 border rounded-lg">
                                <select id="customer-invoices-status-filter" class="w-full px-4 py-2 border rounded-lg">
                                    <option value="all">All Statuses</option>
                                    <option value="billed">Pending Payment</option>
                                    <option value="paid">Paid</option>
                                    <option value="overdue">Overdue</option>
                                </select>
                                <input type="date" id="customer-invoices-date-filter" class="w-full px-4 py-2 border rounded-lg">
                                <button onclick="renderCustomerInvoicesTable()" class="bg-lawn text-white py-2 rounded-lg font-semibold hover:bg-green-600 col-span-full md:col-span-1">Filter</button>
                            </div>
                            <div class="flex justify-between items-center mb-4">
                                <label for="customer-invoices-items-per-page" class="text-sm font-medium text-gray-700">Items per page:</label>
                                <select id="customer-invoices-items-per-page" class="px-3 py-2 border rounded-lg">
                                    <option value="5">5</option>
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                </select>
                            </div>
                            <div id="customer-invoices-table-container" class="overflow-x-auto"></div>
                            <div id="customer-invoices-pagination" class="mt-4 flex justify-end space-x-2"></div>
                        </div>
                    </div>

                    <!-- Mower Dashboard -->
                    <div id="mower-dashboard-view" class="space-y-8 hidden">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Provider Dashboard</h2>
                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Jobs Accepted</h3>
                                <p id="mower-jobs-accepted" class="text-2xl font-bold text-lawn">0</p>
                            </div>
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Total Earnings</h3>
                                <p id="mower-total-earnings" class="text-2xl font-bold text-lawn">₦0.00</p>
                            </div>
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Avg. Completion Time</h3>
                                <p id="mower-avg-completion-time" class="text-2xl font-bold text-lawn">N/A</p>
                            </div>
                             <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Wallet Balance</h3>
                                <p id="mower-wallet-balance" class="text-2xl font-bold text-lawn">₦0.00</p>
                            </div>
                        </div>
                    </div>

                    <!-- Mower Combined Jobs -->
                    <div id="mower-all-jobs-view" class="space-y-4 hidden">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <input type="text" id="mower-all-jobs-search" placeholder="Search..." class="w-full px-4 py-2 border rounded-lg">
                                <select id="mower-all-jobs-status-filter" class="w-full px-4 py-2 border rounded-lg">
                                    <option value="all">All Statuses</option>
                                    <option value="pending">Pending</option>
                                    <option value="accepted">Accepted</option>
                                    <option value="ongoing">Ongoing</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                                <input type="date" id="mower-all-jobs-date-filter" class="w-full px-4 py-2 border rounded-lg">
                                <button onclick="renderMowerCombinedJobsTable()" class="bg-lawn text-white py-2 rounded-lg font-semibold hover:bg-green-600 col-span-full md:col-span-1">Filter</button>
                            </div>
                             <div class="flex justify-between items-center mb-4">
                                <label for="mower-all-jobs-items-per-page" class="text-sm font-medium text-gray-700">Items per page:</label>
                                <select id="mower-all-jobs-items-per-page" class="px-3 py-2 border rounded-lg">
                                    <option value="5">5</option>
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                </select>
                            </div>
                            <div id="mower-all-jobs-table-container" class="overflow-x-auto"></div>
                            <div id="mower-all-jobs-pagination" class="mt-4 flex justify-end space-x-2"></div>
                        </div>
                    </div>

                    <!-- Mower Invoices List -->
                    <div id="mower-invoices-view" class="space-y-4 hidden">
                         <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <input type="text" id="mower-invoices-search" placeholder="Search..." class="w-full px-4 py-2 border rounded-lg">
                                <select id="mower-invoices-status-filter" class="w-full px-4 py-2 border rounded-lg">
                                    <option value="all">All Statuses</option>
                                    <option value="billed">Billed</option>
                                    <option value="paid">Paid</option>
                                </select>
                                <input type="date" id="mower-invoices-date-filter" class="w-full px-4 py-2 border rounded-lg">
                                <button onclick="renderMowerInvoicesTable()" class="bg-lawn text-white py-2 rounded-lg font-semibold hover:bg-green-600 col-span-full md:col-span-1">Filter</button>
                            </div>
                            <div class="flex justify-between items-center mb-4">
                                <label for="mower-invoices-items-per-page" class="text-sm font-medium text-gray-700">Items per page:</label>
                                <select id="mower-invoices-items-per-page" class="px-3 py-2 border rounded-lg">
                                    <option value="5">5</option>
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                </select>
                            </div>
                            <div id="mower-invoices-table-container" class="overflow-x-auto"></div>
                            <div id="mower-invoices-pagination" class="mt-4 flex justify-end space-x-2"></div>
                        </div>
                    </div>

                    <!-- Mower Profile -->
                    <div id="mower-profile-view" class="space-y-8 hidden">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">My Profile</h2>
                            <form id="mower-profile-form" class="space-y-6">
                                <div class="flex items-center space-x-4">
                                    <div id="mower-profile-current-avatar" class="w-24 h-24 bg-gray-200 text-gray-600 flex items-center justify-center rounded-full text-4xl font-bold overflow-hidden">
                                        <img id="mower-profile-img" src="" alt="Profile Avatar" class="w-full h-full object-cover hidden" onerror="this.classList.add('hidden'); this.parentElement.querySelector('span').classList.remove('hidden');">
                                        <span id="mower-profile-initials"></span>
                                    </div>
                                    <div>
                                        <label for="mower-profile-picture" class="block text-sm font-medium text-gray-700 mb-1">Update Profile Picture</label>
                                        <input type="file" id="mower-profile-picture" name="profilePicture" accept="image/*" class="w-full text-sm text-gray-500
                                            file:mr-4 file:py-2 file:px-4
                                            file:rounded-full file:border-0
                                            file:text-sm file:font-semibold
                                            file:bg-lawn file:text-white
                                            hover:file:bg-green-600"/>
                                    </div>
                                </div>
                                <div>
                                    <label for="mower-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                                    <input type="text" id="mower-name" name="name" class="mt-1 w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label for="mower-business-address" class="block text-sm font-medium text-gray-700">Business Address</label>
                                    <input type="text" id="mower-business-address" name="address" class="mt-1 w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label for="mower-contact-person" class="block text-sm font-medium text-gray-700">Contact Person Name</label>
                                    <input type="text" id="mower-contact-person" name="contactPerson" class="mt-1 w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label for="mower-contact-person-email" class="block text-sm font-medium text-gray-700">Contact Person Email</label>
                                    <input type="email" id="mower-contact-person-email" name="contactPersonEmail" class="mt-1 w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label for="mower-contact-person-phone" class="block text-sm font-medium text-gray-700">Contact Person Phone Number</label>
                                    <input type="tel" id="mower-contact-person-phone" name="contactPersonPhone" class="mt-1 w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label for="mower-business-phone" class="block text-sm font-medium text-gray-700">Business Phone Number</label>
                                    <input type="tel" id="mower-business-phone" name="businessPhone" class="mt-1 w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label for="mower-business-email" class="block text-sm font-medium text-gray-700">Business Email</label>
                                    <input type="email" id="mower-business-email" name="businessEmail" class="mt-1 w-full px-4 py-2 border rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Services Offered</label>
                                    <div id="mower-services-list" class="flex flex-wrap gap-2 mt-1"></div>
                                    <div class="flex mt-2">
                                        <input type="text" id="mower-custom-service" class="w-full px-3 py-2 border rounded-l-lg" placeholder="Add another service...">
                                        <button type="button" id="mower-add-service-btn" class="bg-gray-200 px-4 rounded-r-lg hover:bg-gray-300">Add</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Availability</label>
                                    <div id="mower-availability-container" class="space-y-2"></div>
                                    <button type="button" id="mower-add-availability-btn" class="mt-2 text-sm text-lawn hover:underline">+ Add day/time</button>
                                </div>
                                <div>
                                    <label for="mower-hourly-rate" class="block text-sm font-medium text-gray-700">Hourly Rate (₦)</label>
                                    <input type="number" id="mower-hourly-rate" name="hourlyRate" class="mt-1 w-full px-4 py-2 border rounded-lg" min="0" step="100">
                                </div>
                                <div id="profile-update-error" class="text-red-500 text-sm text-center hidden"></div>
                                <button type="submit" class="w-full bg-lawn text-white py-3 rounded-lg font-semibold hover:bg-green-600 shadow-md">Update Profile</button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Admin Dashboard -->
                    <div id="admin-dashboard-view" class="space-y-8 hidden">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Admin Dashboard</h2>
                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Total Users</h3>
                                <p id="admin-total-users" class="text-2xl font-bold text-lawn">0</p>
                            </div>
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Total Bookings</h3>
                                <p id="admin-total-bookings" class="text-2xl font-bold text-lawn">0</p>
                            </div>
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Platform Revenue</h3>
                                <p id="admin-total-revenue" class="text-2xl font-bold text-lawn">₦0.00</p>
                            </div>
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Avg. Mower Completion Time</h3>
                                <p id="admin-avg-completion-time" class="text-2xl font-bold text-lawn">N/A</p>
                            </div>
                        </div>
                    </div>

                    <!-- Admin Users List -->
                    <div id="admin-users-view" class="space-y-4 hidden">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <input type="text" id="admin-users-search" placeholder="Search by name or email..." class="w-full px-4 py-2 border rounded-lg">
                                <select id="admin-users-filter-role" class="w-full px-4 py-2 border rounded-lg">
                                    <option value="all">All Roles</option>
                                    <option value="customer">Customer</option>
                                    <option value="mower">Service Provider</option>
                                    <!-- Admin role option is dynamically added for Super Admin -->
                                </select>
                                <button onclick="renderAdminUsersTable()" class="bg-lawn text-white py-2 rounded-lg font-semibold hover:bg-green-600">Filter</button>
                            </div>
                            <div class="flex justify-between items-center mb-4">
                                <label for="admin-users-items-per-page" class="text-sm font-medium text-gray-700">Items per page:</label>
                                <select id="admin-users-items-per-page" class="px-3 py-2 border rounded-lg">
                                    <option value="5">5</option>
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                </select>
                            </div>
                            <div id="admin-users-table-container" class="overflow-x-auto"></div>
                            <div id="admin-users-pagination" class="mt-4 flex justify-end space-x-2"></div>
                        </div>
                    </div>
                    
                    <!-- Admin Bookings List -->
                    <div id="admin-bookings-view" class="space-y-4 hidden">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <input type="text" id="admin-bookings-search" placeholder="Search..." class="w-full px-4 py-2 border rounded-lg">
                                <select id="admin-bookings-status-filter" class="w-full px-4 py-2 border rounded-lg">
                                    <option value="all">All Statuses</option>
                                    <option value="pending">Pending</option>
                                    <option value="accepted">Accepted</option>
                                    <option value="ongoing">Ongoing</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                    <option value="rejected">Rejected</option>
                                    <option value="billed">Billed</option>
                                    <option value="paid">Paid</option>
                                </select>
                                <input type="date" id="admin-bookings-date-filter" class="w-full px-4 py-2 border rounded-lg">
                                <button onclick="renderAdminBookingsTable()" class="bg-lawn text-white py-2 rounded-lg font-semibold hover:bg-green-600">Filter</button>
                            </div>
                             <div class="flex justify-between items-center mb-4">
                                <label for="admin-bookings-items-per-page" class="text-sm font-medium text-gray-700">Items per page:</label>
                                <select id="admin-bookings-items-per-page" class="px-3 py-2 border rounded-lg">
                                    <option value="5">5</option>
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                </select>
                            </div>
                            <div id="admin-bookings-table-container" class="overflow-x-auto"></div>
                            <div id="admin-bookings-pagination" class="mt-4 flex justify-end space-x-2"></div>
                        </div>
                    </div>

                    <!-- Admin Invoices List -->
                    <div id="admin-invoices-view" class="space-y-4 hidden">
                         <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <input type="text" id="admin-invoices-search" placeholder="Search..." class="w-full px-4 py-2 border rounded-lg">
                                <select id="admin-invoices-status-filter" class="w-full px-4 py-2 border rounded-lg">
                                    <option value="all">All Statuses</option>
                                    <option value="billed">Billed (Pending Payment)</option>
                                    <option value="paid">Paid</option>
                                    <option value="overdue">Overdue</option>
                                </select>
                                <input type="date" id="admin-invoices-date-filter" class="w-full px-4 py-2 border rounded-lg">
                                <button onclick="renderAdminInvoicesTable()" class="bg-lawn text-white py-2 rounded-lg font-semibold hover:bg-green-600 col-span-full md:col-span-1">Filter</button>
                            </div>
                            <div class="flex justify-between items-center mb-4">
                                <label for="admin-invoices-items-per-page" class="text-sm font-medium text-gray-700">Items per page:</label>
                                <select id="admin-invoices-items-per-page" class="px-3 py-2 border rounded-lg">
                                    <option value="5">5</option>
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                </select>
                            </div>
                            <div id="admin-invoices-table-container" class="overflow-x-auto"></div>
                            <div id="admin-invoices-pagination" class="mt-4 flex justify-end space-x-2"></div>
                        </div>
                    </div>

                    <!-- Super Admin Dashboard -->
                    <div id="super_admin-dashboard-view" class="space-y-8 hidden">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Super Admin Dashboard</h2>
                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                             <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Total Admins</h3>
                                <p id="super-admin-total-admins" class="text-2xl font-bold text-lawn">0</p>
                            </div>
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Total Users</h3>
                                <p id="super-admin-total-users" class="text-2xl font-bold text-lawn">0</p>
                            </div>
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Total Bookings</h3>
                                <p id="super-admin-total-bookings" class="text-2xl font-bold text-lawn">0</p>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-semibold text-gray-700 mb-4">Quick Actions</h3>
                            <button onclick="renderContent('super_admin-add-admin-view')" class="bg-lawn text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-600 shadow-md">Add New Admin</button>
                        </div>
                    </div>

                    <!-- Super Admin Manage Admins View -->
                    <div id="super_admin-users-view" class="space-y-4 hidden">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Manage Admins</h2>
                        <div class="bg-white rounded-xl shadow-lg p-6">
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <input type="text" id="super-admin-users-search" placeholder="Search by name or email..." class="w-full px-4 py-2 border rounded-lg">
                                <button onclick="renderSuperAdminUsersTable()" class="bg-lawn text-white py-2 rounded-lg font-semibold hover:bg-green-600">Filter</button>
                            </div>
                            <div class="flex justify-between items-center mb-4">
                                <label for="super-admin-users-items-per-page" class="text-sm font-medium text-gray-700">Items per page:</label>
                                <select id="super-admin-users-items-per-page" class="px-3 py-2 border rounded-lg">
                                    <option value="5">5</option>
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">5</option>
                                </select>
                            </div>
                            <div id="super-admin-users-table-container" class="overflow-x-auto"></div>
                            <div id="super-admin-users-pagination" class="mt-4 flex justify-end space-x-2"></div>
                        </div>
                    </div>

                    <!-- Super Admin Add Admin View -->
                    <div id="super_admin-add-admin-view" class="space-y-8 hidden">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Add New Admin</h2>
                            <form id="add-admin-form" class="space-y-4">
                                <div>
                                    <label for="admin-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                                    <input type="text" id="admin-name" name="name" class="mt-1 w-full px-4 py-2 border rounded-lg" placeholder="Admin Full Name">
                                </div>
                                <div>
                                    <label for="admin-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                                    <input type="email" id="admin-email" name="email" class="mt-1 w-full px-4 py-2 border rounded-lg" placeholder="Admin Email">
                                </div>
                                <div id="add-admin-error" class="text-red-500 text-sm text-center hidden"></div>
                                <button type="submit" class="w-full bg-lawn text-white py-3 rounded-lg font-semibold hover:bg-green-600 shadow-md">Create Admin</button>
                            </form>
                        </div>
                    </div>

                </div>
            </main>

        </div>
    </div>

    <!-- Modals -->
    <div id="booking-modal" class="fixed inset-0 z-50 modal bg-gray-900 bg-opacity-50 hidden">
        <div class="modal-content">
            <button type="button" onclick="closeBookingModal()" class="modal-close-button">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Book Service</h3>
            <form id="new-booking-form" class="space-y-4">
                <input type="hidden" id="booking-provider-id">
                <input type="hidden" id="booking-original-id"> <!-- New hidden field for reassign -->
                <div>
                    <label for="booking-date" class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="date" id="booking-date" name="date" class="mt-1 w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label for="booking-time" class="block text-sm font-medium text-gray-700">Time</label>
                    <input type="time" id="booking-time" name="time" class="mt-1 w-full px-4 py-2 border rounded-lg">
                </div>
                <div>
                    <label for="booking-address" class="block text-sm font-medium text-gray-700">Address</label>
                    <input type="text" id="booking-address" name="address" class="mt-1 w-full px-4 py-2 border rounded-lg" placeholder="e.g., 123 Maple Street">
                </div>
                <div>
                    <label for="booking-description" class="block text-sm font-medium text-gray-700">Description (Optional)</label>
                    <textarea id="booking-description" name="description" rows="3" class="mt-1 w-full px-4 py-2 border rounded-lg" placeholder="e.g., Back yard only, needs extra weeding."></textarea>
                </div>
                <div id="booking-error" class="text-red-500 text-sm text-center hidden"></div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeBookingModal()" class="px-4 py-2 rounded-lg border">Cancel</button>
                    <button type="submit" class="bg-lawn text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600">Confirm Booking</button>
                </div>
            </form>
        </div>
    </div>

    <div id="provider-details-modal" class="fixed inset-0 z-50 modal bg-gray-900 bg-opacity-50 hidden">
        <div class="modal-content max-w-xl">
            <button type="button" onclick="closeProviderDetailsModal()" class="modal-close-button">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 id="provider-details-name" class="text-2xl font-bold text-gray-800 mb-4"></h3>
            <div id="provider-details-content" class="space-y-4 overflow-y-auto max-h-96"></div>
        </div>
    </div>

    <div id="rating-modal" class="fixed inset-0 z-50 modal bg-gray-900 bg-opacity-50 hidden">
        <div class="modal-content">
            <button type="button" onclick="closeRatingModal()" class="modal-close-button">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Rate Your Service</h3>
            <form id="rating-form" class="space-y-4">
                <input type="hidden" id="rating-booking-id">
                <div class="text-center">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Rating</label>
                    <div id="stars" class="star-rating text-center text-4xl">
                        <span class="star" data-rating="1">&#9733;</span>
                        <span class="star" data-rating="2">&#9733;</span>
                        <span class="star" data-rating="3">&#9733;</span>
                        <span class="star" data-rating="4">&#9733;</span>
                        <span class="star" data-rating="5">&#9733;</span>
                    </div>
                </div>
                <div>
                    <label for="rating-comment" class="block text-sm font-medium text-gray-700">Comments (Optional)</label>
                    <textarea id="rating-comment" rows="4" class="mt-1 w-full px-4 py-2 border rounded-lg" placeholder="Add your comments..."></textarea>
                </div>
                 <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeRatingModal()" class="px-4 py-2 rounded-lg border">Cancel</button>
                    <button type="submit" class="bg-lawn text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600">Submit Rating</button>
                </div>
            </form>
        </div>
    </div>

    <div id="proof-completion-modal" class="fixed inset-0 z-50 modal bg-gray-900 bg-opacity-50 hidden">
        <div class="modal-content">
            <button type="button" onclick="closeProofCompletionModal()" class="modal-close-button">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Complete Booking</h3>
            <form id="proof-completion-form" class="space-y-4">
                <input type="hidden" id="completion-booking-id">
                <div>
                    <label for="proof-completion-file" class="block text-sm font-medium text-gray-700">Proof of Completion (Optional)</label>
                    <input type="file" id="proof-completion-file" name="proofFile" accept="image/*" class="w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-gray-200 file:text-gray-700
                        hover:file:bg-gray-300"/>
                </div>
                <div>
                    <label for="completion-comment" class="block text-sm font-medium text-gray-700">Comments (Optional)</label>
                    <textarea id="completion-comment" rows="4" class="mt-1 w-full px-4 py-2 border rounded-lg" placeholder="Add comments about the completion..."></textarea>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeProofCompletionModal()" class="px-4 py-2 rounded-lg border">Cancel</button>
                    <button type="submit" class="bg-lawn text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600">Submit Completion</button>
                </div>
            </form>
        </div>
    </div>

    <div id="reject-reason-modal" class="fixed inset-0 z-50 modal bg-gray-900 bg-opacity-50 hidden">
        <div class="modal-content">
            <button type="button" onclick="closeRejectReasonModal()" class="modal-close-button">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Reject Booking</h3>
            <form id="reject-reason-form" class="space-y-4">
                <input type="hidden" id="reject-booking-id">
                <div>
                    <label for="rejection-reason" class="block text-sm font-medium text-gray-700">Reason for Rejection</label>
                    <textarea id="rejection-reason" rows="4" class="mt-1 w-full px-4 py-2 border rounded-lg" placeholder="Please provide a reason for rejecting this booking..."></textarea>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeRejectReasonModal()" class="px-4 py-2 rounded-lg border">Cancel</button>
                    <button type="submit" class="bg-red-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-600">Reject Booking</button>
                </div>
            </form>
        </div>
    </div>

    <div id="forgot-password-modal" class="fixed inset-0 z-50 modal bg-gray-900 bg-opacity-50 hidden">
        <div class="modal-content">
            <button type="button" onclick="closeForgotPasswordModal()" class="modal-close-button">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Forgot Password</h3>
            <form id="forgot-password-form" class="space-y-4">
                <div>
                    <label for="forgot-password-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="forgot-password-email" name="email" class="mt-1 w-full px-4 py-2 border rounded-lg" placeholder="Enter your email">
                </div>
                <div id="forgot-password-error" class="text-red-500 text-sm text-center hidden"></div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeForgotPasswordModal()" class="px-4 py-2 rounded-lg border">Cancel</button>
                    <button type="submit" class="bg-lawn text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600">Reset Password</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Booking Details Modal -->
    <div id="booking-details-modal" class="fixed inset-0 z-50 modal bg-gray-900 bg-opacity-50 hidden">
        <div class="modal-content max-w-2xl max-h-[90vh] overflow-y-auto">
            <button type="button" onclick="closeBookingDetailsModal()" class="modal-close-button">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h3 class="text-2xl font-bold text-gray-800 mb-4">Booking Details <span id="booking-details-id-display"></span></h3>
            
            <div id="booking-details-content" class="space-y-6">
                <!-- Booking Information -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-lg text-gray-700 mb-2">Booking Information</h4>
                    <p><strong>Date:</strong> <span id="detail-date"></span></p>
                    <p><strong>Time:</strong> <span id="detail-time"></span></p>
                    <p><strong>Address:</strong> <span id="detail-address"></span></p>
                    <p><strong>Description:</strong> <span id="detail-description"></span></p>
                    <p><strong>Status:</strong> <span id="detail-status"></span></p>
                    <p><strong>Price:</strong> <span id="detail-price"></span></p>
                </div>

                <!-- Customer Information -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-lg text-gray-700 mb-2">Customer Information</h4>
                    <p><strong>Name:</strong> <span id="detail-customer-name"></span></p>
                    <p><strong>Email:</strong> <span id="detail-customer-email"></span></p>
                    <p><strong>Phone:</strong> <span id="detail-customer-phone"></span></p>
                </div>

                <!-- Service Provider Information -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-lg text-gray-700 mb-2">Service Provider Information</h4>
                    <p><strong>Name:</strong> <span id="detail-mower-name"></span></p>
                    <p><strong>Email:</strong> <span id="detail-mower-email"></span></p>
                    <p><strong>Hourly Rate:</strong> <span id="detail-mower-hourly-rate"></span></p>
                </div>

                <!-- Billing & Completion Information -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-lg text-gray-700 mb-2">Billing & Completion</h4>
                    <p><strong>Billing Status:</strong> <span id="detail-billing-status"></span></p>
                    <div id="detail-proof-completion-container" class="mt-2 hidden">
                        <p class="font-semibold mb-1">Proof of Completion:</p>
                        <img id="detail-proof-completion-img" src="" alt="Proof of Completion" class="w-full h-auto rounded-lg shadow-md max-h-64 object-contain mb-2"/>
                        <p id="detail-completion-comment" class="text-gray-600 italic"></p>
                    </div>
                     <div id="detail-rejection-reason-container" class="mt-2 hidden">
                        <p class="font-semibold text-red-600">Rejection Reason:</p>
                        <p id="detail-rejection-reason" class="text-red-500 italic"></p>
                    </div>
                     <button id="detail-rate-service-button" onclick="showRatingModalFromDetails()" class="bg-lawn text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-600 mt-4 hidden">Rate Service</button>
                </div>

                <!-- Comments Section -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-semibold text-lg text-gray-700 mb-2">Comments</h4>
                    <div id="booking-comments-list" class="space-y-3 mb-4 max-h-48 overflow-y-auto">
                        <!-- Comments will be loaded here -->
                    </div>
                    <div id="add-comment-section">
                        <textarea id="new-comment-text" rows="3" class="mt-1 w-full px-4 py-2 border rounded-lg" placeholder="Add a new comment..."></textarea>
                        <button onclick="addCommentToBooking(document.getElementById('booking-details-id-holder').value, document.getElementById('new-comment-text').value)" class="bg-lawn text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-600 mt-2">Post Comment</button>
                    </div>
                    <input type="hidden" id="booking-details-id-holder">
                </div>
            </div>
        </div>
    </div>


    <script>
        // --- State Management ---
        const state = {
            users: [],
            bookings: [],
            currentUser: null,
            isLoggedIn: false,
            systemRevenue: 0, // New field for system's accumulated revenue
            pagination: {
                customerBookings: { currentPage: 1, itemsPerPage: 5 },
                customerInvoices: { currentPage: 1, itemsPerPage: 5 },
                mowerAllJobs: { currentPage: 1, itemsPerPage: 5 },
                mowerInvoices: { currentPage: 1, itemsPerPage: 5 },
                adminUsers: { currentPage: 1, itemsPerPage: 5 },
                adminBookings: { currentPage: 1, itemsPerPage: 5 },
                adminInvoices: { currentPage: 1, itemsPerPage: 5 }, // New pagination config
                superAdminUsers: { currentPage: 1, itemsPerPage: 5 },
            }
        };

        const OVERDUE_THRESHOLD_MS = 10 * 60 * 1000; // 10 minutes for overdue calculation
        const SYSTEM_COMMISSION_RATE = 0.10; // 10% commission for the system

        // --- Data Management (Mock Data for this demo) ---
        function seedInitialData() {
            state.users = [
                { id: 'u1', name: 'Alice Customer', email: 'alice@example.com', password: 'password', role: 'customer', isVerified: true, imageUrl: 'https://placehold.co/100x100/A0DC94/000000?text=AC', phoneNumber: '+2348011112222' },
                { id: 'u2', name: 'Bob Mower', email: 'bob@example.com', password: 'password', role: 'mower', isVerified: true, isApproved: true, isAvailable: true, ratings: [], services: ['Mowing', 'Fertilizing'], availability: [{day: 'Mon', fromTime: '09:00', toTime: '17:00'}, {day: 'Wed', fromTime: '09:00', toTime: '17:00'}], hourlyRate: 2500, imageUrl: 'https://placehold.co/100x100/94BBDC/000000?text=BM', contactPerson: 'Bob Mower', contactPersonEmail: 'bob.contact@example.com', contactPersonPhone: '555-123-4567', businessPhoneNumber: '555-987-6543', businessEmail: 'bob.biz@example.com', walletBalance: 0 },
                { id: 'u3', name: 'Charlie Admin', email: 'charlie@example.com', password: 'password', role: 'admin', isVerified: true, defaultPassword: true },
                { id: 'u4', name: 'David Customer', email: 'david@example.com', password: 'password', role: 'customer', isVerified: true, imageUrl: 'https://placehold.co/100x100/F0B987/000000?text=DC', phoneNumber: '+2349033334444' },
                { id: 'u5', name: 'Eve Mower', email: 'eve@example.com', password: 'password', role: 'mower', isVerified: true, isApproved: false, isAvailable: false, ratings: [], services: ['Weeding', 'Trimming'], availability: [{day: 'Tue', fromTime: '10:00', toTime: '18:00'}, {day: 'Thu', fromTime: '10:00', toTime: '18:00'}], hourlyRate: 3000, imageUrl: 'https://placehold.co/100x100/DCCB94/000000?text=EM', contactPerson: 'Eve Mower', contactPersonEmail: 'eve.contact@example.com', contactPersonPhone: '555-222-3333', businessPhoneNumber: '555-444-5555', businessEmail: 'eve.biz@example.com', walletBalance: 0 },
                { id: 'u6', name: 'Super Admin', email: 'super_admin@example.com', password: 'super_password', role: 'super_admin', isVerified: true },
                { id: 'u7', name: 'Frank Admin', email: 'frank@example.com', password: 'password', role: 'admin', isVerified: true },
            ];

            state.bookings = Array.from({ length: 20 }, (_, i) => {
                const booking = {
                    id: `BK-200${i + 1}-${String.fromCharCode(65 + (i % 2))}${String.fromCharCode(74 + (i % 2))}`, // e.g., BK-2001-AJ
                    customerId: i % 2 === 0 ? 'u1' : 'u4',
                    mowerId: i % 3 === 0 ? 'u2' : (i % 3 === 1 ? 'u5' : null),
                    date: `2025-08-${15 + (i % 5)}`,
                    time: `${10 + (i % 8)}:00`,
                    address: i % 2 === 0 ? '123 Oak Ave' : '456 Pine Ln',
                    description: i % 2 === 0 ? 'Front yard only, careful with flowers.' : 'Large backyard, needs extra trimming around edges.',
                    status: i % 4 === 0 ? 'completed' : (i % 4 === 1 ? 'accepted' : (i % 4 === 2 ? 'pending' : 'cancelled')),
                    price: i % 4 === 0 ? ((i % 2 === 0 ? 2500 : 3000) * (1 + (i % 2))) : 0, // Simulate some prices for completed
                    billingStatus: i % 4 === 0 ? 'paid' : (i % 4 === 1 ? 'billed' : 'pending'), // New billing status
                    rating: null, // Initial rating
                    comments: [], // New array for comments
                    acceptedTime: i % 3 === 0 ? new Date(`2025-08-${15 + (i % 5)}T09:00:00`).toISOString() : null,
                    ongoingTime: i % 3 === 0 && i % 4 !== 2 ? new Date(`2025-08-${15 + (i % 5)}T09:15:00`).toISOString() : null,
                    completedTime: i % 4 === 0 ? new Date(new Date().getTime() - (i % 2 === 0 ? 30 : 5) * 60 * 1000).toISOString() : null, // Simulate recent completion
                    proofOfCompletionUrl: i % 4 === 0 ? 'https://placehold.co/150x100/E0F2F1/000000?text=Proof' : null,
                    completionComment: i % 4 === 0 ? 'Lawn looks great after the service!' : null,
                    rejectionReason: i % 4 === 3 ? 'Mower unavailable on requested date.' : null,
                    paymentReminderSent: false
                };

                // Add initial rating and comment to comments array if applicable
                if (booking.status === 'completed' && booking.price > 0) {
                    const customer = state.users.find(u => u.id === booking.customerId);
                    const mower = state.users.find(u => u.id === booking.mowerId);
                    const ratingValue = 5 - (i % 3);
                    booking.rating = ratingValue;
                    booking.comments.push({
                        userId: customer.id,
                        userName: customer.name,
                        commentText: 'Good work, very satisfied!', // More generic initial comment
                        timestamp: new Date(new Date().getTime() - 12 * 60 * 60 * 1000).toISOString(),
                        isRating: true,
                        rating: ratingValue
                    });
                    if(mower && !mower.ratings.some(r => r.customerId === customer.id)) {
                         mower.ratings.push({ customerId: customer.id, rating: ratingValue, comment: 'Good work, very satisfied!' });
                    }
                }
                return booking;
            });

            // Initialize system revenue based on initial paid bookings
            state.systemRevenue = state.bookings
                .filter(b => b.billingStatus === 'paid')
                .reduce((sum, b) => sum + (b.price * SYSTEM_COMMISSION_RATE), 0);

             // Initialize provider wallet balances
            state.users.forEach(user => {
                if (user.role === 'mower') {
                    user.walletBalance = state.bookings
                        .filter(b => b.mowerId === user.id && b.billingStatus === 'paid')
                        .reduce((sum, b) => sum + (b.price * (1 - SYSTEM_COMMISSION_RATE)), 0);
                }
            });
        }

        function saveState() {
            localStorage.setItem('lawnconnectState', JSON.stringify(state));
        }

        function loadState() {
            const savedState = localStorage.getItem('lawnconnectState');
            if (savedState) {
                Object.assign(state, JSON.parse(savedState));
            } else {
                seedInitialData();
            }
        }
        
        // --- Utility for File Upload to Data URL ---
        function fileToBase64(file, callback) {
            const reader = new FileReader();
            reader.onload = function(e) {
                callback(e.target.result);
            };
            reader.onerror = function(e) {
                console.error("FileReader error: ", e);
                callback(null);
            };
            reader.readAsDataURL(file);
        }

        // --- Authentication ---
        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const user = state.users.find(u => u.email === email && u.password === password);
            const errorElement = document.getElementById('login-error');

            if (user) {
                if (!user.isVerified) {
                    showMessage('Please verify your email to log in.');
                    errorElement.textContent = 'Please verify your email to log in.'; // Redundant, but for immediate feedback
                    errorElement.classList.remove('hidden');
                    return;
                }
                
                state.currentUser = user;
                state.isLoggedIn = true;
                saveState();
                
                if (user.role === 'admin' && user.defaultPassword) {
                    showView('auth-view');
                    document.getElementById('login-form').classList.add('hidden');
                    document.getElementById('toggle-auth-text').classList.add('hidden');
                    document.getElementById('admin-password-change-form').classList.remove('hidden');
                } else {
                    checkAuthAndRoute();
                }

            } else {
                showMessage('Invalid email or password.');
                errorElement.textContent = 'Invalid email or password.';
                errorElement.classList.remove('hidden');
            }
        }

        function handleRegister(event) {
            event.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const role = document.getElementById('register-role').value;
            const errorElement = document.getElementById('register-error');

            if (state.users.find(u => u.email === email)) {
                errorElement.textContent = 'An account with this email already exists.';
                errorElement.classList.remove('hidden');
                return;
            }

            const newUser = {
                id: 'u' + (state.users.length + 1),
                name, email, password, role, isVerified: false, ratings: [], imageUrl: ''
            };

            if (role === 'mower') {
                const services = Array.from(document.querySelectorAll('#register-services-list input[name="services"]:checked')).map(cb => cb.value);
                const availability = [];
                document.querySelectorAll('#register-availability-container .availability-slot').forEach(slot => {
                    const day = slot.querySelector('select').value;
                    const fromTime = slot.querySelector('input[name="fromTime"]').value;
                    const toTime = slot.querySelector('input[name="toTime"]').value;
                    if (day && fromTime && toTime) {
                        availability.push({ day, fromTime, toTime });
                    }
                });
                const hourlyRate = parseFloat(document.getElementById('register-hourly-rate').value);
                Object.assign(newUser, { services, availability, hourlyRate, isApproved: false, isAvailable: false, walletBalance: 0 }); // Initialize walletBalance
            }

            state.users.push(newUser);
            saveState();

            showMessage('Registration successful! A verification link has been sent to your email. (Auto-verified for demo)');
            // For demo purposes, we auto-verify. In a real app, this would be an an email flow.
            state.users.find(u => u.email === email).isVerified = true;
            saveState();

            toggleAuthForm();
        }
        
        function handleAddAdmin(event) {
            event.preventDefault();
            const name = document.getElementById('admin-name').value;
            const email = document.getElementById('admin-email').value;
            const errorElement = document.getElementById('add-admin-error');

            if (state.users.find(u => u.email === email)) {
                errorElement.textContent = 'An account with this email already exists.';
                errorElement.classList.remove('hidden');
                return;
            }
            
            const defaultPassword = 'defaultpassword';
            const newAdmin = {
                id: 'u' + (state.users.length + 1), name, email,
                password: defaultPassword, role: 'admin', isVerified: true, defaultPassword: true
            };
            state.users.push(newAdmin);
            saveState();
            
            showMessage(`Admin '${name}' created with default password: '${defaultPassword}'. They will be prompted to change it on first login.`);
            document.getElementById('add-admin-form').reset();
            renderSuperAdminUsersTable(); // Refresh the admin list
        }

        function handleChangeAdminPassword(event) {
            event.preventDefault();
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const errorElement = document.getElementById('password-change-error');

            if (newPassword !== confirmPassword) {
                errorElement.textContent = 'Passwords do not match.';
                errorElement.classList.remove('hidden');
                return;
            }
            
            const user = state.currentUser;
            user.password = newPassword;
            user.defaultPassword = false;
            saveState();
            
            showMessage('Password changed successfully! Redirecting to dashboard.');
            checkAuthAndRoute();
        }

        function handleLogout() {
            state.currentUser = null;
            state.isLoggedIn = false;
            saveState();
            checkAuthAndRoute();
        }

        function checkAuthAndRoute() {
            loadState();
            if (state.isLoggedIn && state.currentUser) {
                showView('dashboard-view');
                setupDashboard();
                renderContent(`${state.currentUser.role}-dashboard-view`);
            } else {
                // If not logged in, show the landing page
                showView('landing-page-view');
            }
        }
        
        function showForgotPasswordModal() {
            document.getElementById('forgot-password-modal').classList.remove('hidden');
            document.getElementById('forgot-password-email').value = '';
            document.getElementById('forgot-password-error').classList.add('hidden');
        }

        function closeForgotPasswordModal() {
            document.getElementById('forgot-password-modal').classList.add('hidden');
        }

        function handleForgotPasswordSubmit(event) {
            event.preventDefault();
            const email = document.getElementById('forgot-password-email').value;
            const errorElement = document.getElementById('forgot-password-error');
            const userExists = state.users.some(u => u.email === email);

            if (userExists) {
                showMessage('If an account with that email exists, a password reset link has been sent.');
                closeForgotPasswordModal();
            } else {
                errorElement.textContent = 'No account found with that email address.';
                errorElement.classList.remove('hidden');
            }
        }


        // --- UI Setup and Rendering ---
        function showView(viewId) {
            // Hide all main views first
            document.getElementById('landing-page-view').classList.add('hidden');
            document.getElementById('auth-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.add('hidden');
            
            // Show the requested view
            document.getElementById(viewId).classList.remove('hidden');
        }
        
        function toggleAuthForm() {
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const authTitle = document.getElementById('auth-title');
            const toggleText = document.getElementById('toggle-auth-text');

            if (loginForm.classList.contains('hidden')) {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                authTitle.textContent = 'Login';
                toggleText.innerHTML = `Don't have an account? <button type="button" id="toggle-auth-button" class="text-lawn hover:underline font-medium">Register</button>`;
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                authTitle.textContent = 'Register';
                toggleText.innerHTML = `Already have an account? <button type="button" id="toggle-auth-button" class="text-lawn hover:underline font-medium">Login</button>`;
            }
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('register-error').classList.add('hidden');
            // Re-attach event listener as innerHTML replaces it
            document.getElementById('toggle-auth-button').addEventListener('click', toggleAuthForm);
        }

        function showLoginFormFromLanding() {
            showView('auth-view');
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('register-form').classList.add('hidden');
            document.getElementById('auth-title').textContent = 'Login';
            document.getElementById('toggle-auth-text').innerHTML = `Don't have an account? <button type="button" id="toggle-auth-button" class="text-lawn hover:underline font-medium">Register</button>`;
            document.getElementById('toggle-auth-button').addEventListener('click', toggleAuthForm);
        }

        function showRegisterFormFromLanding() {
            showView('auth-view');
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('register-form').classList.remove('hidden');
            document.getElementById('auth-title').textContent = 'Register';
            document.getElementById('toggle-auth-text').innerHTML = `Already have an account? <button type="button" id="toggle-auth-button" class="text-lawn hover:underline font-medium">Login</button>`;
            document.getElementById('toggle-auth-button').addEventListener('click', toggleAuthForm);
        }


        function toggleMobileMenu() {
            document.getElementById('mobile-menu').classList.toggle('-translate-x-full');
        }

        function setupDashboard() {
            const user = state.currentUser;
            if (!user) return;

            const displayName = document.getElementById('user-display-name');
            const userAvatarDiv = document.getElementById('user-avatar');
            const userAvatarImg = document.getElementById('user-avatar-img');
            const userAvatarInitials = document.getElementById('user-avatar-initials');

            if (displayName) {
                 displayName.textContent = user.name;
                 displayName.classList.remove('hidden');
            }
            if (userAvatarDiv) {
                if (user.imageUrl) {
                    userAvatarImg.src = user.imageUrl;
                    userAvatarImg.classList.remove('hidden');
                    userAvatarInitials.classList.add('hidden');
                } else {
                    userAvatarInitials.textContent = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
                    userAvatarInitials.classList.remove('hidden');
                    userAvatarImg.classList.add('hidden');
                }
                userAvatarDiv.classList.remove('hidden');
            }

            // Hide all navigation roles first
            ['customer', 'mower', 'admin', 'super_admin'].forEach(role => {
                document.getElementById(`nav-${role}`)?.classList.add('hidden');
                document.getElementById(`mobile-nav-${role}`)?.classList.add('hidden');
            });

            // Show current user's navigation
            document.getElementById(`nav-${user.role}`)?.classList.remove('hidden');
            document.getElementById(`mobile-nav-${user.role}`)?.classList.remove('hidden');

            // Special handling for Super Admin to ensure 'Manage Users' and 'All Bookings' from admin are shown
            if (user.role === 'super_admin') {
                const superAdminNav = document.getElementById('nav-super_admin');
                const mobileSuperAdminNav = document.getElementById('mobile-nav-super_admin');

                // Check and add "Manage Users" if not already present
                if (!superAdminNav.querySelector('a[onclick*="admin-users-view"]')) {
                    const manageUsersLink = document.createElement('a');
                    manageUsersLink.href = "#";
                    manageUsersLink.onclick = () => renderContent('admin-users-view');
                    manageUsersLink.className = "flex items-center p-3 text-gray-600 rounded-lg hover:bg-gray-100 nav-link";
                    manageUsersLink.innerHTML = `<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a4 4 0 0112 0v1zm-6-4a4 4 0 00-4 4v1"></path></svg> Manage Users`;
                    superAdminNav.insertBefore(manageUsersLink, superAdminNav.children[1]); // Insert before Add Admin
                }
                 if (!mobileSuperAdminNav.querySelector('a[onclick*="admin-users-view"]')) {
                    const mobileManageUsersLink = document.createElement('a');
                    mobileManageUsersLink.href = "#";
                    mobileManageUsersLink.onclick = () => renderContent('admin-users-view');
                    mobileManageUsersLink.className = "text-gray-800 hover:text-lawn font-medium py-2";
                    mobileManageUsersLink.textContent = "Manage Users";
                    mobileSuperAdminNav.insertBefore(mobileManageUsersLink, mobileSuperAdminNav.children[1]); // Insert before Add Admin
                }


                // Check and add "All Bookings" if not already present
                if (!superAdminNav.querySelector('a[onclick*="admin-bookings-view"]')) {
                    const allBookingsLink = document.createElement('a');
                    allBookingsLink.href = "#";
                    allBookingsLink.onclick = () => renderContent('admin-bookings-view');
                    allBookingsLink.className = "flex items-center p-3 text-gray-600 rounded-lg hover:bg-gray-100 nav-link";
                    allBookingsLink.innerHTML = `<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg> All Bookings`;
                     superAdminNav.insertBefore(allBookingsLink, superAdminNav.children[2]); // Insert before Add Admin
                }
                if (!mobileSuperAdminNav.querySelector('a[onclick*="admin-bookings-view"]')) {
                    const mobileAllBookingsLink = document.createElement('a');
                    mobileAllBookingsLink.href = "#";
                    mobileAllBookingsLink.onclick = () => renderContent('admin-bookings-view');
                    mobileAllBookingsLink.className = "text-gray-800 hover:text-lawn font-medium py-2";
                    mobileAllBookingsLink.textContent = "All Bookings";
                    mobileSuperAdminNav.insertBefore(mobileAllBookingsLink, mobileSuperAdminNav.children[2]); // Insert before Add Admin
                }

                // Check and add "Invoices" if not already present
                if (!superAdminNav.querySelector('a[onclick*="admin-invoices-view"]')) {
                    const adminInvoicesLink = document.createElement('a');
                    adminInvoicesLink.href = "#";
                    adminInvoicesLink.onclick = () => renderContent('admin-invoices-view');
                    adminInvoicesLink.className = "flex items-center p-3 text-gray-600 rounded-lg hover:bg-gray-100 nav-link";
                    adminInvoicesLink.innerHTML = `<svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 2H7a2 2 0 01-2-2V5a2 2 0 012-2h10a2 2 0 012 2v14a2 2 0 01-2 2z"></path></svg> Invoices`;
                    superAdminNav.insertBefore(adminInvoicesLink, superAdminNav.children[3]); // Insert before Add Admin
                }
                 if (!mobileSuperAdminNav.querySelector('a[onclick*="admin-invoices-view"]')) {
                    const mobileAdminInvoicesLink = document.createElement('a');
                    mobileAdminInvoicesLink.href = "#";
                    mobileAdminInvoicesLink.onclick = () => renderContent('admin-invoices-view');
                    mobileAdminInvoicesLink.className = "text-gray-800 hover:text-lawn font-medium py-2";
                    mobileAdminInvoicesLink.textContent = "Invoices";
                    mobileSuperAdminNav.insertBefore(mobileAdminInvoicesLink, mobileSuperAdminNav.children[3]); // Insert before Add Admin
                }
            }
        }

        // --- Dashboard Content Rendering ---
        function calculateAverageRating(ratings) {
            // Filter for only comments that are actual ratings (to differentiate from general comments)
            const ratingComments = ratings ? ratings.filter(r => r.isRating) : [];
            if (ratingComments.length === 0) return 0;
            const total = ratingComments.reduce((sum, r) => sum + r.rating, 0);
            return (total / ratingComments.length).toFixed(1);
        }

        function calculateAverageCompletionTime() {
            const completedBookings = state.bookings.filter(b => b.status === 'completed' && b.ongoingTime && b.completedTime);
            if (completedBookings.length === 0) return 'N/A';

            let totalDuration = 0; // in milliseconds
            completedBookings.forEach(b => {
                const ongoing = new Date(b.ongoingTime);
                const completed = new Date(b.completedTime);
                totalDuration += (completed.getTime() - ongoing.getTime());
            });

            const avgDurationMs = totalDuration / completedBookings.length;
            const avgDurationMinutes = Math.round(avgDurationMs / (1000 * 60));

            const hours = Math.floor(avgDurationMinutes / 60);
            const minutes = avgDurationMinutes % 60;

            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m`;
            }
        }
        
        function renderDashboardContent(role) {
            const user = state.currentUser;
            
            switch(role) {
                case 'customer':
                    const upcomingBooking = state.bookings.find(b => b.customerId === user.id && ['pending', 'accepted', 'ongoing'].includes(b.status));
                    document.getElementById('customer-upcoming-booking').textContent = upcomingBooking ? `On ${upcomingBooking.date} at ${upcomingBooking.time} (Status: ${upcomingBooking.status})` : 'No upcoming bookings.';
                    const totalSpent = state.bookings.filter(b => b.customerId === user.id && b.status === 'completed' && b.billingStatus === 'paid').reduce((sum, b) => sum + b.price, 0);
                    document.getElementById('customer-total-spent').textContent = `₦${totalSpent.toFixed(2)}`;
                    const completedCustomerBookings = state.bookings.filter(b => b.customerId === user.id && b.status === 'completed').length;
                    document.getElementById('customer-completed-bookings').textContent = completedCustomerBookings;
                    break;
                case 'mower':
                    const acceptedJobs = state.bookings.filter(b => b.mowerId === user.id && ['accepted', 'ongoing'].includes(b.status)).length;
                    const earnings = state.bookings.filter(b => b.mowerId === user.id && b.billingStatus === 'paid').reduce((sum, b) => sum + (b.price * (1 - SYSTEM_COMMISSION_RATE)), 0);
                    document.getElementById('mower-jobs-accepted').textContent = acceptedJobs;
                    document.getElementById('mower-total-earnings').textContent = `₦${earnings.toFixed(2)}`;
                    document.getElementById('mower-avg-completion-time').textContent = calculateAverageCompletionTime();
                    document.getElementById('mower-wallet-balance').textContent = `₦${(user.walletBalance || 0).toFixed(2)}`; // Display wallet balance
                    break;
                case 'admin':
                    document.getElementById('admin-total-users').textContent = state.users.length;
                    document.getElementById('admin-total-bookings').textContent = state.bookings.length;
                    document.getElementById('admin-total-revenue').textContent = `₦${state.systemRevenue.toFixed(2)}`; // Use actual system revenue
                    document.getElementById('admin-avg-completion-time').textContent = calculateAverageCompletionTime();
                    break;
                case 'super_admin':
                     document.getElementById('super-admin-total-admins').textContent = state.users.filter(u => u.role === 'admin' || u.role === 'super_admin').length;
                     document.getElementById('super-admin-total-users').textContent = state.users.length;
                     document.getElementById('super-admin-total-bookings').textContent = state.bookings.length;
                    break;
            }
        }

        // --- Table & Pagination Logic ---
        function paginate(items, page, perPage) {
            return items.slice((page - 1) * perPage, page * perPage);
        }

        function renderPaginationControls(containerId, totalItems, configKey) {
            const { currentPage, itemsPerPage } = state.pagination[configKey];
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';

            if (totalPages <= 1) return;

            const prevButton = document.createElement('button');
            prevButton.textContent = 'Previous';
            prevButton.className = 'pagination-button';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => {
                state.pagination[configKey].currentPage--;
                rerenderCurrentTable();
            };
            container.appendChild(prevButton);

            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.className = `pagination-button ${i === currentPage ? 'active' : ''}`;
                pageButton.onclick = () => {
                    state.pagination[configKey].currentPage = i;
                    rerenderCurrentTable();
                };
                container.appendChild(pageButton);
            }

            const nextButton = document.createElement('button');
            nextButton.textContent = 'Next';
            nextButton.className = 'pagination-button';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => {
                state.pagination[configKey].currentPage++;
                rerenderCurrentTable();
            };
            container.appendChild(nextButton);
        }

        function rerenderCurrentTable() {
            const visibleContent = document.querySelector('#content-container > div:not(.hidden)');
            if (visibleContent) {
                // Determine which rendering function to call based on the visible view
                switch (visibleContent.id) {
                    case 'customer-bookings-view': renderCustomerBookingsTable(); break;
                    case 'customer-invoices-view': renderCustomerInvoicesTable(); break;
                    case 'mower-all-jobs-view': renderMowerCombinedJobsTable(); break;
                    case 'mower-invoices-view': renderMowerInvoicesTable(); break;
                    case 'admin-users-view': renderAdminUsersTable(); break;
                    case 'admin-bookings-view': renderAdminBookingsTable(); break;
                    case 'admin-invoices-view': renderAdminInvoicesTable(); break; // New case
                    case 'super_admin-users-view': renderSuperAdminUsersTable(); break;
                    // Add other cases if new tables are introduced
                }
            }
        }

        function createTable(data, columns, actions = null) {
            if (!data || data.length === 0) {
                return '<p class="text-center text-gray-500 py-8">No data matches your criteria.</p>';
            }

            let tableHTML = `<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>`;
            columns.forEach(col => {
                tableHTML += `<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${col.header}</th>`;
            });
            if (actions) tableHTML += `<th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th>`;
            tableHTML += `</tr></thead><tbody class="bg-white divide-y divide-gray-200">`;

            data.forEach(item => {
                tableHTML += `<tr>`;
                columns.forEach(col => {
                    const value = col.render ? col.render(item) : (item[col.key] || 'N/A');
                    tableHTML += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">${value}</td>`;
                });
                if (actions) {
                    tableHTML += `<td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">`;
                    actions.forEach(action => {
                         if (!action.condition || action.condition(item)) {
                            tableHTML += `<button onclick="${action.onclick}(event, '${item.id}')" class="text-lawn hover:text-green-700 mr-4">${action.label}</button>`;
                        }
                    });
                    tableHTML += `</td>`;
                }
                tableHTML += `</tr>`;
            });

            tableHTML += `</tbody></table>`;
            return tableHTML;
        }

        function applyFilters(data, searchInputId, dateInputId, statusFilterId, extraFilterKey = null) {
            const searchQuery = document.getElementById(searchInputId)?.value.toLowerCase() || '';
            const dateFilter = document.getElementById(dateInputId)?.value || '';
            const statusFilter = document.getElementById(statusFilterId)?.value || 'all';

            return data.filter(item => {
                const searchMatch = searchQuery ? (item.address?.toLowerCase().includes(searchQuery) || item.id?.toLowerCase().includes(searchQuery) || item.description?.toLowerCase().includes(searchQuery)) : true;
                const dateMatch = dateFilter ? item.date === dateFilter : true;
                
                let statusMatch = true;
                if (statusFilter !== 'all') {
                    if (extraFilterKey) { // For invoices, status is based on billingStatus or 'overdue'
                        statusMatch = item[extraFilterKey] === statusFilter;
                        if (statusFilter === 'overdue') {
                            statusMatch = isBookingOverdue(item);
                        } else if (statusFilter === 'billed' && isBookingOverdue(item)) {
                            statusMatch = false; // Billed items that are overdue should not show as 'billed'
                        }
                    } else { // For bookings, status is based on booking.status
                        statusMatch = item.status === statusFilter;
                    }
                }
                return searchMatch && dateMatch && statusMatch;
            });
        }
        
        // --- Specific Table Renderers ---
        function renderCustomerBookingsTable() {
            const configKey = 'customerBookings';
            const user = state.currentUser;
            let bookings = state.bookings.filter(b => b.customerId === user.id);
            
            bookings = applyFilters(bookings, 'customer-bookings-search', 'customer-bookings-date-filter', 'customer-bookings-status-filter');
            
            // Sort bookings: pending first, then accepted, then ongoing, then completed, then rejected/cancelled
            const statusOrder = { 'pending': 1, 'accepted': 2, 'ongoing': 3, 'completed': 4, 'rejected': 5, 'cancelled': 6 };
            bookings.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (dateA.getTime() !== dateB.getTime()) {
                    return dateA.getTime() - dateB.getTime(); // Sort by date
                }
                return statusOrder[a.status] - statusOrder[b.status]; // Then by status
            });

            state.pagination[configKey].itemsPerPage = parseInt(document.getElementById('customer-bookings-items-per-page').value, 10);
            const paginatedData = paginate(bookings, state.pagination[configKey].currentPage, state.pagination[configKey].itemsPerPage);

            const columns = [
                { header: 'Booking ID', key: 'id' },
                { header: 'Date', key: 'date' }, { header: 'Time', key: 'time' }, { header: 'Address', key: 'address' },
                { header: 'Status', render: item => `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-${item.status === 'completed' ? 'green' : item.status === 'cancelled' || item.status === 'rejected' ? 'red' : 'yellow'}-100 text-${item.status === 'completed' ? 'green' : item.status === 'cancelled' || item.status === 'rejected' ? 'red' : 'yellow'}-800">${item.status}</span>`},
                { header: 'Billing Status', key: 'billingStatus' },
                { header: 'Price', render: item => `₦${item.price.toFixed(2)}` },
                { header: 'Mower', render: item => state.users.find(u => u.id === item.mowerId)?.name || 'Unassigned' },
            ];
            const actions = [
                { label: 'View Details', onclick: 'showBookingDetailsModal' }, // Changed to view details
                { label: 'Cancel', onclick: 'cancelBooking', condition: item => ['pending', 'accepted'].includes(item.status) },
                { label: 'Reassign', onclick: 'reassignBooking', condition: item => item.status === 'rejected' }
            ];
            
            document.getElementById('customer-bookings-table-container').innerHTML = createTable(paginatedData, columns, actions);
            renderPaginationControls('customer-bookings-pagination', bookings.length, configKey);
        }

        function isBookingOverdue(booking) {
            // An invoice is overdue if it's billed, completed, and 10 minutes have passed since completion.
            return booking.billingStatus === 'billed' && 
                   booking.status === 'completed' && 
                   booking.completedTime && 
                   (new Date().getTime() - new Date(booking.completedTime).getTime()) > OVERDUE_THRESHOLD_MS;
        }

        function renderCustomerInvoicesTable() {
            const configKey = 'customerInvoices';
            const user = state.currentUser;
            let invoices = state.bookings.filter(b => b.customerId === user.id && ['billed', 'paid'].includes(b.billingStatus));

            // Apply filters, using 'billingStatus' as the extraFilterKey
            invoices = applyFilters(invoices, 'customer-invoices-search', 'customer-invoices-date-filter', 'customer-invoices-status-filter', 'billingStatus');
            
            // Re-label status for display and sort
            invoices.forEach(inv => {
                inv._displayStatus = inv.billingStatus;
                if (isBookingOverdue(inv)) {
                    inv._displayStatus = 'overdue';
                }
            });

            // Sort invoices by status: overdue, then billed, then paid
            const invoiceStatusOrder = { 'overdue': 1, 'billed': 2, 'paid': 3 };
            invoices.sort((a, b) => {
                 const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (dateA.getTime() !== dateB.getTime()) {
                    return dateA.getTime() - dateB.getTime(); // Sort by date
                }
                return invoiceStatusOrder[a._displayStatus] - invoiceStatusOrder[b._displayStatus]; // Then by status
            });


            state.pagination[configKey].itemsPerPage = parseInt(document.getElementById('customer-invoices-items-per-page').value, 10);
            const paginatedData = paginate(invoices, state.pagination[configKey].currentPage, state.pagination[configKey].itemsPerPage);

            const columns = [
                { header: 'Invoice ID', key: 'id' },
                { header: 'Date', key: 'date' },
                { header: 'Service Provider', render: item => state.users.find(u => u.id === item.mowerId)?.name || 'N/A' },
                { header: 'Amount', render: item => `₦${item.price.toFixed(2)}` },
                { header: 'Status', render: item => {
                    let statusText = item._displayStatus;
                    let bgColor = 'gray';
                    let textColor = 'gray';
                    if (statusText === 'paid') { bgColor = 'green'; textColor = 'green'; }
                    else if (statusText === 'overdue') { bgColor = 'red'; textColor = 'red'; }
                    else if (statusText === 'billed') { bgColor = 'yellow'; textColor = 'yellow'; }
                    return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-${bgColor}-100 text-${textColor}-800">${statusText.charAt(0).toUpperCase() + statusText.slice(1)}</span>`;
                }},
            ];

            const actions = [
                { label: 'View Details', onclick: 'showBookingDetailsModal' },
                { label: 'Pay Now', onclick: 'payBooking', condition: item => item._displayStatus === 'billed' || item._displayStatus === 'overdue' },
            ];
            
            document.getElementById('customer-invoices-table-container').innerHTML = createTable(paginatedData, columns, actions);
            renderPaginationControls('customer-invoices-pagination', invoices.length, configKey);
        }

        function renderMowerInvoicesTable() {
            const configKey = 'mowerInvoices';
            const user = state.currentUser;
            let invoices = state.bookings.filter(b => b.mowerId === user.id && ['billed', 'paid'].includes(b.billingStatus));
            
            invoices = applyFilters(invoices, 'mower-invoices-search', 'mower-invoices-date-filter', 'mower-invoices-status-filter', 'billingStatus');

             // Sort invoices by status: billed first, then paid
            const invoiceStatusOrder = { 'billed': 1, 'paid': 2 };
            invoices.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (dateA.getTime() !== dateB.getTime()) {
                    return dateA.getTime() - dateB.getTime(); // Sort by date
                }
                return invoiceStatusOrder[a.billingStatus] - invoiceStatusOrder[b.billingStatus]; // Then by status
            });

            state.pagination[configKey].itemsPerPage = parseInt(document.getElementById('mower-invoices-items-per-page').value, 10);
            const paginatedData = paginate(invoices, state.pagination[configKey].currentPage, state.pagination[configKey].itemsPerPage);

            const columns = [
                { header: 'Invoice ID', key: 'id' },
                { header: 'Date', key: 'date' },
                { header: 'Customer', render: item => state.users.find(u => u.id === item.customerId)?.name || 'N/A' },
                { header: 'Amount', render: item => `₦${item.price.toFixed(2)}` },
                { header: 'Status', render: item => {
                    let statusText = item.billingStatus;
                    let bgColor = 'gray';
                    let textColor = 'gray';
                    if (statusText === 'paid') { bgColor = 'green'; textColor = 'green'; }
                    else if (statusText === 'billed') { bgColor = 'yellow'; textColor = 'yellow'; }
                    return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-${bgColor}-100 text-${textColor}-800">${statusText.charAt(0).toUpperCase() + statusText.slice(1)}</span>`;
                }},
            ];
            const actions = [
                { label: 'View Details', onclick: 'showBookingDetailsModal' },
            ];
            
            document.getElementById('mower-invoices-table-container').innerHTML = createTable(paginatedData, columns, actions);
            renderPaginationControls('mower-invoices-pagination', invoices.length, configKey);
        }


        function renderMowerCombinedJobsTable() {
            const configKey = 'mowerAllJobs';
            const user = state.currentUser;
            let jobs = state.bookings.filter(b => b.mowerId === user.id || b.mowerId === null); // All jobs relevant to mower

            const searchQuery = document.getElementById('mower-all-jobs-search').value.toLowerCase();
            const statusFilter = document.getElementById('mower-all-jobs-status-filter').value;
            const dateFilter = document.getElementById('mower-all-jobs-date-filter').value;

            jobs = jobs.filter(item => {
                const searchMatch = searchQuery ? (item.address || '').toLowerCase().includes(searchQuery) || (item.id || '').toLowerCase().includes(searchQuery) : true;
                const statusMatch = statusFilter === 'all' ? true : item.status === statusFilter;
                const dateMatch = dateFilter ? item.date === dateFilter : true;
                return searchMatch && statusMatch && dateMatch;
            });
            // Sort jobs: pending first, then accepted, then ongoing, then completed, then rejected/cancelled
            const statusOrder = { 'pending': 1, 'accepted': 2, 'ongoing': 3, 'completed': 4, 'rejected': 5, 'cancelled': 6 };
            jobs.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (dateA.getTime() !== dateB.getTime()) {
                    return dateA.getTime() - dateB.getTime(); // Sort by date
                }
                return statusOrder[a.status] - statusOrder[b.status]; // Then by status
            });
            
            state.pagination[configKey].itemsPerPage = parseInt(document.getElementById('mower-all-jobs-items-per-page').value, 10);
            const paginatedData = paginate(jobs, state.pagination[configKey].currentPage, state.pagination[configKey].itemsPerPage);

            const columns = [
                { header: 'Booking ID', key: 'id' },
                { header: 'Date', key: 'date' }, { header: 'Time', key: 'time' }, { header: 'Address', key: 'address' },
                { header: 'Description', key: 'description' },
                { header: 'Status', render: item => `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-${item.status === 'completed' ? 'green' : item.status === 'cancelled' || item.status === 'rejected' ? 'red' : 'yellow'}-100 text-${item.status === 'completed' ? 'green' : item.status === 'cancelled' || item.status === 'rejected' ? 'red' : 'yellow'}-800">${item.status}</span>`},
                { header: 'Billing Status', key: 'billingStatus' },
                { header: 'Price', render: item => `₦${item.price.toFixed(2)}` },
                { header: 'Customer', render: item => state.users.find(u => u.id === item.customerId)?.name || 'Unknown' },
            ];
            const actions = [
                { label: 'View Details', onclick: 'showBookingDetailsModal' },
                { label: 'Accept', onclick: 'acceptJob', condition: item => item.status === 'pending' && item.mowerId === null && user.isApproved && user.isAvailable },
                { label: 'Set Ongoing', onclick: 'setBookingToOngoing', condition: item => item.status === 'accepted' && item.mowerId === user.id },
                { label: 'Complete', onclick: 'showProofCompletionModal', condition: item => item.status === 'ongoing' && item.mowerId === user.id },
                { label: 'Reject', onclick: 'showRejectReasonModal', condition: item => item.status === 'pending' }, // Mower can only reject pending jobs
            ];

            document.getElementById('mower-all-jobs-table-container').innerHTML = createTable(paginatedData, columns, actions);
            renderPaginationControls('mower-all-jobs-pagination', jobs.length, configKey);
        }


        function renderAdminUsersTable() {
            const configKey = 'adminUsers';
            let users = [...state.users];
            const searchQuery = document.getElementById('admin-users-search').value.toLowerCase();
            const roleFilter = document.getElementById('admin-users-filter-role').value;

            // Dynamically add/remove Admin role option for Super Admin
            const adminUsersFilterRoleSelect = document.getElementById('admin-users-filter-role');
            if (state.currentUser.role === 'super_admin') {
                if (!adminUsersFilterRoleSelect.querySelector('option[value="admin"]')) {
                    const adminOption = document.createElement('option');
                    adminOption.value = 'admin';
                    adminOption.textContent = 'Admin';
                    adminUsersFilterRoleSelect.appendChild(adminOption);
                }
                 if (!adminUsersFilterRoleSelect.querySelector('option[value="super_admin"]')) {
                    const superAdminOption = document.createElement('option');
                    superAdminOption.value = 'super_admin';
                    superAdminOption.textContent = 'Super Admin';
                    adminUsersFilterRoleSelect.appendChild(superAdminOption);
                }
            } else {
                // For normal admin, remove 'admin' and 'super_admin' options if they exist
                let adminOption = adminUsersFilterRoleSelect.querySelector('option[value="admin"]');
                if (adminOption) adminOption.remove();
                let superAdminOption = adminUsersFilterRoleSelect.querySelector('option[value="super_admin"]');
                if (superAdminOption) superAdminOption.remove();
            }

            if (searchQuery) {
                users = users.filter(u => u.name.toLowerCase().includes(searchQuery) || u.email.toLowerCase().includes(searchQuery));
            }
            if (roleFilter !== 'all') {
                users = users.filter(u => u.role === roleFilter);
            }
            // Admins should only see customers and mowers. Super admin can see all users.
            if (state.currentUser.role === 'admin') {
                users = users.filter(u => u.role === 'customer' || u.role === 'mower');
            }


            state.pagination[configKey].itemsPerPage = parseInt(document.getElementById('admin-users-items-per-page').value, 10);
            const paginatedData = paginate(users, state.pagination[configKey].currentPage, state.pagination[configKey].itemsPerPage);
            const columns = [
                { header: 'Name', key: 'name' }, { header: 'Email', key: 'email' }, { header: 'Role', key: 'role' },
                { header: 'Verified', render: item => item.isVerified ? 'Yes' : 'No' },
                { header: 'Approved', render: item => item.role === 'mower' ? (item.isApproved ? 'Yes' : 'No') : 'N/A' },
                { header: 'Available', render: item => item.role === 'mower' ? (item.isAvailable ? 'Yes' : 'No') : 'N/A' },
            ];

            const actions = [
                { label: 'Approve', onclick: 'toggleProviderApproval', condition: item => item.role === 'mower' && !item.isApproved },
                { label: 'Unapprove', onclick: 'toggleProviderApproval', condition: item => item.role === 'mower' && item.isApproved },
                { label: 'Set Available', onclick: 'toggleProviderAvailability', condition: item => item.role === 'mower' && item.isApproved && !item.isAvailable },
                { label: 'Set Unavailable', onclick: 'toggleProviderAvailability', condition: item => item.role === 'mower' && item.isApproved && item.isAvailable }
            ];

            document.getElementById('admin-users-table-container').innerHTML = createTable(paginatedData, columns, actions);
            renderPaginationControls('admin-users-pagination', users.length, configKey);
        }

        function toggleProviderApproval(event, userId) {
            const user = state.users.find(u => u.id === userId);
            if (user && user.role === 'mower') {
                user.isApproved = !user.isApproved;
                if (!user.isApproved) { // If unapproved, also make unavailable
                    user.isAvailable = false;
                }
                saveState();
                showMessage(`Provider ${user.name} ${user.isApproved ? 'approved' : 'unapproved'}.`);
                renderAdminUsersTable();
            }
        }

        function toggleProviderAvailability(event, userId) {
            const user = state.users.find(u => u.id === userId);
            if (user && user.role === 'mower' && user.isApproved) {
                user.isAvailable = !user.isAvailable;
                saveState();
                showMessage(`Provider ${user.name} set to ${user.isAvailable ? 'available' : 'unavailable'}.`);
                renderAdminUsersTable();
            } else if (user && user.role === 'mower' && !user.isApproved) {
                showMessage('Provider must be approved before setting availability.');
            }
        }

        function renderSuperAdminUsersTable() {
            const configKey = 'superAdminUsers';
            let users = [...state.users].filter(u => u.role === 'admin' || u.role === 'super_admin');
            const searchQuery = document.getElementById('super-admin-users-search').value.toLowerCase();

            if (searchQuery) {
                users = users.filter(u => u.name.toLowerCase().includes(searchQuery) || u.email.toLowerCase().includes(searchQuery));
            }

            state.pagination[configKey].itemsPerPage = parseInt(document.getElementById('super-admin-users-items-per-page').value, 10);
            const paginatedData = paginate(users, state.pagination[configKey].currentPage, state.pagination[configKey].itemsPerPage);
            const columns = [
                { header: 'Name', key: 'name' }, { header: 'Email', key: 'email' }, { header: 'Role', key: 'role' },
                { header: 'Verified', render: item => item.isVerified ? 'Yes' : 'No' },
                { header: 'Default Password', render: item => item.defaultPassword ? 'Yes' : 'No' }
            ];
            document.getElementById('super-admin-users-table-container').innerHTML = createTable(paginatedData, columns);
            renderPaginationControls('super-admin-users-pagination', users.length, configKey);
        }


        function renderAdminBookingsTable() {
            const configKey = 'adminBookings';
            let bookings = [...state.bookings];

            bookings = applyFilters(bookings, 'admin-bookings-search', 'admin-bookings-date-filter', 'admin-bookings-status-filter');

            state.pagination[configKey].itemsPerPage = parseInt(document.getElementById('admin-bookings-items-per-page').value, 10);
            const paginatedData = paginate(bookings, state.pagination[configKey].currentPage, state.pagination[configKey].itemsPerPage);
            const columns = [
                { header: 'Booking ID', key: 'id' }, { header: 'Date', key: 'date' }, { header: 'Customer', render: item => state.users.find(u => u.id === item.customerId)?.name || 'N/A' },
                { header: 'Mower', render: item => state.users.find(u => u.id === item.mowerId)?.name || 'Unassigned' },
                { header: 'Status', key: 'status' },
                { header: 'Billing Status', key: 'billingStatus' },
                { header: 'Price', render: item => `₦${item.price.toFixed(2)}` },
            ];
            const actions = [
                { label: 'View Details', onclick: 'showBookingDetailsModal' },
            ];

            document.getElementById('admin-bookings-table-container').innerHTML = createTable(paginatedData, columns, actions);
            renderPaginationControls('admin-bookings-pagination', bookings.length, configKey);
        }

        function renderAdminInvoicesTable() {
            const configKey = 'adminInvoices';
            // Filter for only completed bookings that have been billed or paid
            let invoices = state.bookings.filter(b => b.status === 'completed' && ['billed', 'paid'].includes(b.billingStatus));

            // Apply filters, using 'billingStatus' as the extraFilterKey for the status filter
            invoices = applyFilters(invoices, 'admin-invoices-search', 'admin-invoices-date-filter', 'admin-invoices-status-filter', 'billingStatus');
            
            // Add _displayStatus for overdue logic and sorting
            invoices.forEach(inv => {
                inv._displayStatus = inv.billingStatus;
                if (isBookingOverdue(inv)) {
                    inv._displayStatus = 'overdue';
                }
            });

            // Sort invoices by status: overdue, then billed, then paid
            const invoiceStatusOrder = { 'overdue': 1, 'billed': 2, 'paid': 3 };
            invoices.sort((a, b) => {
                 const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                if (dateA.getTime() !== dateB.getTime()) {
                    return dateA.getTime() - dateB.getTime(); // Sort by date
                }
                return invoiceStatusOrder[a._displayStatus] - invoiceStatusOrder[b._displayStatus]; // Then by status
            });


            state.pagination[configKey].itemsPerPage = parseInt(document.getElementById('admin-invoices-items-per-page').value, 10);
            const paginatedData = paginate(invoices, state.pagination[configKey].currentPage, state.pagination[configKey].itemsPerPage);

            const columns = [
                { header: 'Invoice ID', key: 'id' },
                { header: 'Date', key: 'date' },
                { header: 'Customer', render: item => state.users.find(u => u.id === item.customerId)?.name || 'N/A' },
                { header: 'Provider', render: item => state.users.find(u => u.id === item.mowerId)?.name || 'N/A' },
                { header: 'Total Amount', render: item => `₦${item.price.toFixed(2)}` },
                { header: 'To Provider (90%)', render: item => `₦${(item.price * (1 - SYSTEM_COMMISSION_RATE)).toFixed(2)}` },
                { header: 'To System (10%)', render: item => `₦${(item.price * SYSTEM_COMMISSION_RATE).toFixed(2)}` },
                { header: 'Status', render: item => {
                    let statusText = item._displayStatus;
                    let bgColor = 'gray';
                    let textColor = 'gray';
                    if (statusText === 'paid') { bgColor = 'green'; textColor = 'green'; }
                    else if (statusText === 'overdue') { bgColor = 'red'; textColor = 'red'; }
                    else if (statusText === 'billed') { bgColor = 'yellow'; textColor = 'yellow'; }
                    return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-${bgColor}-100 text-${textColor}-800">${statusText.charAt(0).toUpperCase() + statusText.slice(1)}</span>`;
                }},
            ];
            const actions = [
                { label: 'View Details', onclick: 'showBookingDetailsModal' },
            ];
            
            document.getElementById('admin-invoices-table-container').innerHTML = createTable(paginatedData, columns, actions);
            renderPaginationControls('admin-invoices-pagination', invoices.length, configKey);
        }

        // --- Booking & Provider Logic ---
        function renderAvailableProvidersList() {
            const container = document.getElementById('available-providers-container');
            container.innerHTML = '';
            const providers = state.users.filter(u => u.role === 'mower' && u.isApproved && u.isAvailable); // Only approved and available mowers

            if (providers.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 col-span-full">No service providers are currently available.</p>';
                return;
            }

            providers.forEach(provider => {
                const avgRating = calculateAverageRating(provider.ratings);
                const completedJobs = state.bookings.filter(b => b.mowerId === provider.id && b.status === 'completed').length;
                const card = document.createElement('div');
                card.className = 'bg-white rounded-xl shadow-lg p-6 flex flex-col justify-between';
                card.innerHTML = `
                    <div>
                        <h4 class="font-bold text-lg text-gray-800">${provider.name}</h4>
                        <p class="text-sm text-gray-600">${provider.services?.join(', ') || 'No services listed'}</p>
                        <p class="text-sm text-gray-600 font-semibold">Hourly Rate: ₦${provider.hourlyRate ? provider.hourlyRate.toFixed(2) : 'N/A'}</p>
                        <div class="flex items-center mt-2">
                            <span class="text-yellow-500">${'★'.repeat(Math.round(avgRating))}</span>
                            <span class="text-xs text-gray-500 ml-2">(${avgRating} / ${provider.ratings?.filter(r => r.isRating).length || 0} reviews)</span>
                        </div>
                        <p class="text-sm text-gray-500 mt-1">${completedJobs} completed bookings</p>
                    </div>
                    <div class="mt-4 flex space-x-2">
                         <button onclick="showProviderDetails(event, '${provider.id}')" class="flex-1 text-center bg-gray-200 text-gray-800 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300">Details</button>
                         <button onclick="showBookingModal('${provider.id}')" class="flex-1 text-center bg-lawn text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-600">Book Now</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function showBookingModal(providerId, originalBookingId = null) {
            document.getElementById('booking-provider-id').value = providerId;
            document.getElementById('booking-original-id').value = originalBookingId || ''; // Set original booking ID
            document.getElementById('booking-modal').classList.remove('hidden');

            // If it's a reassign, pre-fill the form
            if (originalBookingId) {
                const originalBooking = state.bookings.find(b => b.id === originalBookingId);
                if (originalBooking) {
                    document.getElementById('booking-date').value = originalBooking.date;
                    document.getElementById('booking-time').value = originalBooking.time;
                    document.getElementById('booking-address').value = originalBooking.address;
                    document.getElementById('booking-description').value = originalBooking.description;
                    document.querySelector('#booking-modal h3').textContent = 'Reassign Service'; // Change modal title
                }
            } else {
                document.querySelector('#booking-modal h3').textContent = 'Book Service'; // Reset title for new booking
                document.getElementById('new-booking-form').reset(); // Clear form for new booking
            }
             document.getElementById('booking-error').classList.add('hidden');
        }

        function closeBookingModal() {
            document.getElementById('booking-modal').classList.add('hidden');
            document.getElementById('new-booking-form').reset();
            document.getElementById('booking-error').classList.add('hidden');
            document.getElementById('booking-original-id').value = ''; // Clear original booking ID on close
        }

        function handleNewBooking(event) {
            event.preventDefault();
            const providerId = document.getElementById('booking-provider-id').value;
            const date = document.getElementById('booking-date').value;
            const time = document.getElementById('booking-time').value;
            const address = document.getElementById('booking-address').value;
            const description = document.getElementById('booking-description').value;
            const originalBookingId = document.getElementById('booking-original-id').value; // Get original booking ID
            const errorElement = document.getElementById('booking-error');

            if (!date || !time || !address) {
                errorElement.textContent = 'Date, Time, and Address are required.';
                errorElement.classList.remove('hidden');
                return;
            }
            
            if (originalBookingId) {
                // This is a re-assignment of an existing rejected booking
                const bookingToReassign = state.bookings.find(b => b.id === originalBookingId);
                if (bookingToReassign) {
                    bookingToReassign.mowerId = providerId;
                    bookingToReassign.date = date;
                    bookingToReassign.time = time;
                    bookingToReassign.address = address;
                    bookingToReassign.description = description;
                    bookingToReassign.status = 'pending'; // Set back to pending
                    bookingToReassign.rejectionReason = null; // Clear rejection reason
                    bookingToReassign.price = 0; // Reset price
                    bookingToReassign.billingStatus = 'pending'; // Reset billing status
                    bookingToReassign.acceptedTime = null; // Clear times
                    bookingToReassign.ongoingTime = null;
                    bookingToReassign.completedTime = null;
                    bookingToReassign.proofOfCompletionUrl = null;
                    bookingToReassign.completionComment = null;
                    // Reset comments specific to the previous interaction (e.g., any customer comments after rejection)
                    bookingToReassign.comments = []; 

                    saveState();
                    showMessage(`Booking ${originalBookingId} has been successfully re-assigned and is now pending with the new provider.`);
                    closeBookingModal();
                    renderContent('customer-bookings-view');
                } else {
                    showMessage('Error: Original booking not found for re-assignment.');
                }
            } else {
                // This is a new booking
                const newBooking = {
                    id: `BK-${new Date().getFullYear()}${String(state.bookings.length + 1).padStart(3, '0')}-${String.fromCharCode(65 + Math.floor(Math.random() * 26))}${String.fromCharCode(65 + Math.floor(Math.random() * 26))}`, // e.g., BK-2025021-AZ
                    customerId: state.currentUser.id,
                    mowerId: providerId,
                    date, time, address, description,
                    status: 'pending',
                    price: 0, // Price will be calculated on completion
                    billingStatus: 'pending', // Initial billing status
                    comments: [], // Initialize comments array for new booking
                    paymentReminderSent: false // Flag for invoice
                };
                state.bookings.push(newBooking);
                saveState();
                
                showMessage(`Booking request ${newBooking.id} sent to provider!`);
                closeBookingModal();
                renderContent('customer-bookings-view');
            }
        }

        function showProviderDetails(event, providerId) {
            event.preventDefault();
            const provider = state.users.find(u => u.id === providerId);
            if (!provider) return;

            const avgRating = calculateAverageRating(provider.ratings);
            // Filter for only comments that are actual ratings (to differentiate from general comments)
            const ratingComments = provider.ratings ? provider.ratings.filter(r => r.isRating) : [];
            const commentsHtml = ratingComments.length > 0 ?
                ratingComments.map(r => `
                    <div class="bg-gray-100 p-3 rounded-lg">
                        <p class="font-semibold">${state.users.find(u => u.id === r.customerId)?.name}: <span class="text-yellow-500">${'★'.repeat(r.rating)}</span></p>
                        <p class="text-sm text-gray-600 mt-1 italic">"${r.comment}"</p>
                    </div>`).join('') : '<p class="text-gray-500">No reviews yet.</p>';
            
            document.getElementById('provider-details-name').textContent = provider.name;
            document.getElementById('provider-details-content').innerHTML = `
                <p><strong>Rating:</strong> <span class="text-yellow-500">${'★'.repeat(Math.round(avgRating))}</span> (${avgRating})</p>
                <p><strong>Services:</strong> ${provider.services?.join(', ') || 'N/A'}</p>
                <p><strong>Hourly Rate:</strong> ₦${provider.hourlyRate ? provider.hourlyRate.toFixed(2) : 'N/A'}</p>
                <p><strong>Status:</strong> ${provider.isApproved ? 'Approved' : 'Pending Approval'} / ${provider.isAvailable ? 'Available' : 'Unavailable'}</p>
                <p><strong>Contact Person:</strong> ${provider.contactPerson || 'N/A'}</p>
                <p><strong>Contact Person Email:</strong> ${provider.contactPersonEmail || 'N/A'}</p>
                <p><strong>Contact Person Phone:</strong> ${provider.contactPersonPhone || 'N/A'}</p>
                <p><strong>Business Phone:</strong> ${provider.businessPhoneNumber || 'N/A'}</p>
                <p><strong>Business Email:</strong> ${provider.businessEmail || 'N/A'}</p>
                <p><strong>Business Address:</strong> ${provider.businessAddress || 'N/A'}</p>
                <p><strong>Availability:</strong></p>
                <ul class="list-disc list-inside">${provider.availability?.map(a => `<li>${a.day}: ${a.fromTime} - ${a.toTime}</li>`).join('') || '<li>Not specified</li>'}</ul>
                <hr class="my-4"><h4 class="font-semibold text-lg">Customer Reviews</h4>
                <div class="space-y-3 mt-2">${commentsHtml}</div>`;
            document.getElementById('provider-details-modal').classList.remove('hidden');
        }
        function closeProviderDetailsModal() { document.getElementById('provider-details-modal').classList.add('hidden'); }
        
        function cancelBooking(event, bookingId) {
            const booking = state.bookings.find(b => b.id === bookingId);
            if (booking) {
                // Using custom message box instead of native confirm
                const confirmCancellation = window.confirm('Are you sure you want to cancel this booking?');
                if (confirmCancellation) {
                    // Only allow cancellation of pending or accepted bookings
                    if (['pending', 'accepted'].includes(booking.status)) {
                        booking.status = 'cancelled';
                        saveState();
                        renderCustomerBookingsTable();
                        showMessage('Booking cancelled successfully.');
                    } else {
                        showMessage('This booking cannot be cancelled at its current status.');
                    }
                }
            }
        }

        function reassignBooking(event, bookingId) {
            const booking = state.bookings.find(b => b.id === bookingId);
            if (!booking) return;

            const confirmReassignment = window.confirm(`Are you sure you want to reassign booking ${booking.id}? This will make it available for other providers to accept.`);
            if (!confirmReassignment) {
                return;
            }

            // Call showBookingModal and pass the original booking ID and null provider to initiate selection
            // This will pre-fill the form, and the user will then select a new provider.
            showBookingModal(null, bookingId);
            
            // Note: The actual status update happens in handleNewBooking when the customer selects a new provider
            // For now, just a message that it's ready for re-assignment.
            showMessage(`Booking ${booking.id} is ready for re-assignment. Please select a new provider.`);
        }


        function showRatingModal(event, bookingId) {
            document.getElementById('rating-booking-id').value = bookingId;
            document.querySelectorAll('#stars .star').forEach(star => star.classList.remove('filled')); // Reset stars
            document.getElementById('rating-comment').value = ''; // Clear comment
            document.getElementById('rating-modal').classList.remove('hidden');
        }

        function showRatingModalFromDetails() {
            const bookingId = document.getElementById('booking-details-id-holder').value;
            closeBookingDetailsModal(); // Close details modal first
            showRatingModal(null, bookingId); // Open rating modal
        }

        function closeRatingModal() {
            document.getElementById('rating-modal').classList.add('hidden');
        }

        function submitRating(event) {
            event.preventDefault();
            const bookingId = document.getElementById('rating-booking-id').value;
            const rating = document.querySelectorAll('#stars .star.filled').length;
            const commentText = document.getElementById('rating-comment').value;

            const booking = state.bookings.find(b => b.id === bookingId);
            if (booking) {
                const provider = state.users.find(u => u.id === booking.mowerId);
                if (provider) {
                    // Add rating to provider's general ratings array (for average rating calculation)
                    if (!provider.ratings) provider.ratings = [];
                    // Ensure only one rating per customer per provider is counted for the overall average
                    if (!provider.ratings.some(r => r.customerId === state.currentUser.id && r.bookingId === bookingId)) {
                        provider.ratings.push({ customerId: state.currentUser.id, rating: rating, comment: commentText, bookingId: bookingId, isRating: true });
                    }
                }
                
                // Set the specific rating on the booking (for display in details)
                booking.rating = rating; 

                // Add the comment to the booking's comments array
                addCommentToBooking(bookingId, commentText, rating, true); // Add rating comment
                
                saveState();
                closeRatingModal();
                renderCustomerBookingsTable(); // Refresh table
                showMessage('Rating submitted successfully!');
            }
        }

        function payBooking(event, bookingId) {
            const booking = state.bookings.find(b => b.id === bookingId);
            if (booking && ['billed', 'overdue'].includes(booking._displayStatus)) {
                const confirmPayment = window.confirm(`Confirm payment of ₦${booking.price.toFixed(2)} for invoice ${booking.id}?`);
                if (confirmPayment) {
                    const provider = state.users.find(u => u.id === booking.mowerId);
                    if (provider) {
                        const providerShare = booking.price * (1 - SYSTEM_COMMISSION_RATE);
                        const systemShare = booking.price * SYSTEM_COMMISSION_RATE;
                        
                        provider.walletBalance = (provider.walletBalance || 0) + providerShare;
                        state.systemRevenue += systemShare;

                        booking.billingStatus = 'paid'; // Mark booking as paid
                        saveState();
                        renderCustomerInvoicesTable(); // Re-render customer invoices
                        renderDashboardContent(state.currentUser.role); // Update dashboard for revenue/wallet
                        showMessage(`Payment for invoice ${booking.id} successful! ₦${providerShare.toFixed(2)} credited to ${provider.name}.`);
                    } else {
                         showMessage('Error: Provider not found for this booking.');
                    }
                }
            }
        }

        // --- Mower Actions & Profile ---
        function acceptJob(event, bookingId) {
            const booking = state.bookings.find(b => b.id === bookingId);
            if (booking) {
                const confirmAcceptance = window.confirm('Are you sure you want to accept this job?');
                if (confirmAcceptance) {
                    booking.mowerId = state.currentUser.id;
                    booking.status = 'accepted';
                    booking.acceptedTime = new Date().toISOString(); // Record acceptance time
                    saveState();
                    renderMowerCombinedJobsTable();
                    showMessage('Job accepted!');
                }
            }
        }
        
        function setBookingToOngoing(event, bookingId) {
            const booking = state.bookings.find(b => b.id === bookingId);
            if (booking && booking.mowerId === state.currentUser.id && booking.status === 'accepted') {
                const confirmOngoing = window.confirm('Are you sure you want to set this booking to ongoing?');
                if (confirmOngoing) {
                    booking.status = 'ongoing';
                    booking.ongoingTime = new Date().toISOString(); // Record ongoing time
                    saveState();
                    renderMowerCombinedJobsTable();
                    showMessage('Booking set to ongoing!');
                }
            }
        }

        function showRejectReasonModal(event, bookingId) {
            document.getElementById('reject-booking-id').value = bookingId;
            document.getElementById('rejection-reason').value = ''; // Clear previous reason
            document.getElementById('reject-reason-modal').classList.remove('hidden');
        }

        function closeRejectReasonModal() {
            document.getElementById('reject-reason-modal').classList.add('hidden');
        }

        function submitRejectReason(event) {
            event.preventDefault();
            const bookingId = document.getElementById('reject-booking-id').value;
            const rejectionReason = document.getElementById('rejection-reason').value;

            if (!rejectionReason) {
                showMessage('Please provide a reason for rejection.');
                return;
            }

            const booking = state.bookings.find(b => b.id === bookingId);
            // Mower can only reject pending bookings, regardless of whether it's assigned to them or in the general pool
            if (booking && booking.status === 'pending') {
                booking.mowerId = null; // Unassign mower if it was assigned
                booking.status = 'rejected';
                booking.rejectionReason = rejectionReason;
                saveState();
                closeRejectReasonModal();
                renderMowerCombinedJobsTable();
                showMessage('Booking rejected.');
            } else {
                showMessage('This booking cannot be rejected at its current status.');
            }
        }

        function showProofCompletionModal(event, bookingId) {
            document.getElementById('completion-booking-id').value = bookingId;
            document.getElementById('proof-completion-file').value = ''; // Clear file input
            document.getElementById('completion-comment').value = ''; // Clear comment
            document.getElementById('proof-completion-modal').classList.remove('hidden');
        }

        function closeProofCompletionModal() {
            document.getElementById('proof-completion-modal').classList.add('hidden');
        }

        function submitCompletion(event) {
            event.preventDefault();
            const bookingId = document.getElementById('completion-booking-id').value;
            const completionComment = document.getElementById('completion-comment').value;
            const proofFile = document.getElementById('proof-completion-file').files[0];

            const booking = state.bookings.find(b => b.id === bookingId);
            const provider = state.users.find(u => u.id === booking.mowerId);

            if (booking && provider) {
                // Calculate duration and price
                const ongoingTime = new Date(booking.ongoingTime);
                const completedTime = new Date(); // Use current time for completion
                const durationMs = completedTime.getTime() - ongoingTime.getTime();
                const durationHours = durationMs / (1000 * 60 * 60); // Duration in hours

                // Assuming a minimum charge of 1 hour if duration is very short
                const billedHours = Math.max(1, Math.ceil(durationHours * 2) / 2); // Round up to nearest 0.5 hour
                booking.price = billedHours * (provider.hourlyRate || 0); // Calculate price based on hourly rate

                booking.status = 'completed';
                booking.completedTime = completedTime.toISOString(); // Record completion time
                booking.completionComment = completionComment;
                booking.billingStatus = 'billed'; // Set billing status to 'billed'

                if (proofFile) {
                    fileToBase64(proofFile, (base64Url) => {
                        if (base64Url) {
                            booking.proofOfCompletionUrl = base64Url;
                        }
                        saveState();
                        closeProofCompletionModal();
                        renderMowerCombinedJobsTable();
                        showMessage(`Booking completed! Invoice sent to customer for ₦${booking.price.toFixed(2)}.`);
                    });
                } else {
                    saveState();
                    closeProofCompletionModal();
                    renderMowerCombinedJobsTable();
                    showMessage(`Booking completed! Invoice sent to customer for ₦${booking.price.toFixed(2)}.`);
                }
            } else {
                showMessage('Error completing booking: Provider or booking not found.');
            }
        }

        // --- Booking Details Modal functions ---
        function showBookingDetailsModal(event, bookingId) {
            const booking = state.bookings.find(b => b.id === bookingId);
            if (!booking) return;

            const customer = state.users.find(u => u.id === booking.customerId);
            const mower = state.users.find(u => u.id === booking.mowerId);

            // Populate Booking Info
            document.getElementById('booking-details-id-display').textContent = `(${booking.id})`;
            document.getElementById('booking-details-id-holder').value = booking.id; // Store booking ID for comments
            document.getElementById('detail-date').textContent = booking.date || 'N/A';
            document.getElementById('detail-time').textContent = booking.time || 'N/A';
            document.getElementById('detail-address').textContent = booking.address || 'N/A';
            document.getElementById('detail-description').textContent = booking.description || 'N/A';
            document.getElementById('detail-status').textContent = booking.status || 'N/A';
            document.getElementById('detail-price').textContent = `₦${(booking.price || 0).toFixed(2)}`;

            // Populate Customer Info
            document.getElementById('detail-customer-name').textContent = customer?.name || 'N/A';
            document.getElementById('detail-customer-email').textContent = customer?.email || 'N/A';
            document.getElementById('detail-customer-phone').textContent = customer?.phoneNumber || 'N/A';

            // Populate Mower Info
            document.getElementById('detail-mower-name').textContent = mower?.name || 'Unassigned';
            document.getElementById('detail-mower-email').textContent = mower?.email || 'N/A';
            document.getElementById('detail-mower-hourly-rate').textContent = mower?.hourlyRate ? `₦${mower.hourlyRate.toFixed(2)}` : 'N/A';

            // Populate Billing & Completion Info
            document.getElementById('detail-billing-status').textContent = booking.billingStatus || 'N/A';
            
            const proofContainer = document.getElementById('detail-proof-completion-container');
            const proofImg = document.getElementById('detail-proof-completion-img');
            const completionCommentElem = document.getElementById('detail-completion-comment');
            if (booking.proofOfCompletionUrl) {
                proofImg.src = booking.proofOfCompletionUrl;
                completionCommentElem.textContent = booking.completionComment || '';
                proofContainer.classList.remove('hidden');
            } else {
                proofContainer.classList.add('hidden');
            }

            const rejectionReasonContainer = document.getElementById('detail-rejection-reason-container');
            const rejectionReasonElem = document.getElementById('detail-rejection-reason');
            if (booking.rejectionReason) {
                rejectionReasonElem.textContent = booking.rejectionReason;
                rejectionReasonContainer.classList.remove('hidden');
            } else {
                rejectionReasonContainer.classList.add('hidden');
            }

            // Show Rate Service button if applicable (customer role, completed, and not yet rated)
            const rateServiceButton = document.getElementById('detail-rate-service-button');
            if (state.currentUser.role === 'customer' && booking.status === 'completed' && booking.rating === null) {
                rateServiceButton.classList.remove('hidden');
            } else {
                rateServiceButton.classList.add('hidden');
            }


            // Populate Comments Section
            const commentsList = document.getElementById('booking-comments-list');
            commentsList.innerHTML = '';
            if (booking.comments && booking.comments.length > 0) {
                booking.comments.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)); // Sort by time
                booking.comments.forEach(comment => {
                    const commentElement = document.createElement('div');
                    commentElement.className = 'bg-white p-3 rounded-lg shadow-sm border border-gray-200';
                    let commentHeader = `<span class="font-semibold text-gray-800">${comment.userName}</span> <span class="text-sm text-gray-500 ml-2">${new Date(comment.timestamp).toLocaleString()}</span>`;
                    if (comment.isRating) {
                        commentHeader += `<div class="text-yellow-500 inline-block ml-2">${'★'.repeat(comment.rating)}</div>`;
                    }
                    commentElement.innerHTML = `
                        <p>${commentHeader}</p>
                        <p class="text-gray-700 mt-1">${comment.commentText}</p>
                    `;
                    commentsList.appendChild(commentElement);
                });
            } else {
                commentsList.innerHTML = '<p class="text-gray-500 text-center">No comments yet.</p>';
            }

            // Clear new comment input
            document.getElementById('new-comment-text').value = '';

            document.getElementById('booking-details-modal').classList.remove('hidden');
        }

        function closeBookingDetailsModal() {
            document.getElementById('booking-details-modal').classList.add('hidden');
        }

        function addCommentToBooking(bookingId, commentText, rating = null, isRating = false) {
            const booking = state.bookings.find(b => b.id === bookingId);
            if (!booking || !commentText.trim()) {
                showMessage('Comment cannot be empty.');
                return;
            }

            if (!state.currentUser) {
                showMessage('You must be logged in to add a comment.');
                return;
            }

            const newComment = {
                userId: state.currentUser.id,
                userName: state.currentUser.name,
                commentText: commentText.trim(),
                timestamp: new Date().toISOString(),
                isRating: isRating, // Flag to indicate if this comment is part of a rating
                rating: isRating ? rating : null // Store rating if it's a rating comment
            };

            if (!booking.comments) {
                booking.comments = [];
            }
            booking.comments.push(newComment);
            saveState();
            showMessage('Comment added!');
            showBookingDetailsModal(null, bookingId); // Re-render the modal to show the new comment
        }
        
        function populateMowerProfileForm() {
            const user = state.currentUser;
            if (!user || user.role !== 'mower') return;

            document.getElementById('mower-name').value = user.name || '';
            document.getElementById('mower-business-address').value = user.businessAddress || '';
            document.getElementById('mower-contact-person').value = user.contactPerson || '';
            document.getElementById('mower-contact-person-email').value = user.contactPersonEmail || '';
            document.getElementById('mower-contact-person-phone').value = user.contactPersonPhone || '';
            document.getElementById('mower-business-phone').value = user.businessPhoneNumber || '';
            document.getElementById('mower-business-email').value = user.businessEmail || '';
            document.getElementById('mower-hourly-rate').value = user.hourlyRate || '';

            const mowerProfileImg = document.getElementById('mower-profile-img');
            const mowerProfileInitials = document.getElementById('mower-profile-initials');
            if (user.imageUrl) {
                mowerProfileImg.src = user.imageUrl;
                mowerProfileImg.classList.remove('hidden');
                mowerProfileInitials.classList.add('hidden');
            } else {
                mowerProfileInitials.textContent = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
                mowerProfileInitials.classList.remove('hidden');
                mowerProfileImg.classList.add('hidden');
            }
            
            const servicesList = document.getElementById('mower-services-list');
            servicesList.innerHTML = '';
            user.services?.forEach(service => addServiceCheckbox(service, servicesList, true));

            const availabilityContainer = document.getElementById('mower-availability-container');
            availabilityContainer.innerHTML = '';
            user.availability?.forEach(slot => addAvailabilitySlot(availabilityContainer, slot.day, slot.fromTime, slot.toTime));
        }

        function handleMowerProfileUpdate(event) {
            event.preventDefault();
            const user = state.currentUser;
            user.name = document.getElementById('mower-name').value;
            user.businessAddress = document.getElementById('mower-business-address').value;
            user.contactPerson = document.getElementById('mower-contact-person').value;
            user.contactPersonEmail = document.getElementById('mower-contact-person-email').value;
            user.contactPersonPhone = document.getElementById('mower-contact-person-phone').value;
            user.businessPhoneNumber = document.getElementById('mower-business-phone').value;
            user.businessEmail = document.getElementById('mower-business-email').value;
            user.hourlyRate = parseFloat(document.getElementById('mower-hourly-rate').value);

            user.services = Array.from(document.querySelectorAll('#mower-services-list input:checked')).map(cb => cb.value);
            user.availability = [];
            document.querySelectorAll('#mower-availability-container .availability-slot').forEach(slot => {
                const day = slot.querySelector('select').value;
                const fromTime = slot.querySelector('input[name="fromTime"]').value;
                const toTime = slot.querySelector('input[name="toTime"]').value;
                if (day && fromTime && toTime) {
                    user.availability.push({ day, fromTime, toTime });
                }
            });

            const profilePictureFile = document.getElementById('mower-profile-picture').files[0];
            if (profilePictureFile) {
                fileToBase64(profilePictureFile, (base64Url) => {
                    if (base64Url) {
                        user.imageUrl = base64Url;
                    }
                    saveState();
                    showMessage('Profile updated successfully!');
                    renderContent('mower-profile-view'); // Re-render to show new image/data
                    setupDashboard(); // Update top avatar
                });
            } else {
                saveState();
                showMessage('Profile updated successfully!');
                renderContent('mower-profile-view'); // Re-render to show new data
                setupDashboard(); // Update top avatar
            }
        }

        // --- Customer Profile ---
        function populateCustomerProfileForm() {
            const user = state.currentUser;
            if (!user || user.role !== 'customer') return;

            document.getElementById('customer-name').value = user.name || '';
            document.getElementById('customer-phone-number').value = user.phoneNumber || '';
            
            const customerProfileImg = document.getElementById('customer-profile-img');
            const customerProfileInitials = document.getElementById('customer-profile-initials');
            if (user.imageUrl) {
                customerProfileImg.src = user.imageUrl;
                customerProfileImg.classList.remove('hidden');
                customerProfileInitials.classList.add('hidden');
            } else {
                customerProfileInitials.textContent = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
                customerProfileInitials.classList.remove('hidden');
                customerProfileImg.classList.add('hidden');
            }
        }

        function handleCustomerProfileUpdate(event) {
            event.preventDefault();
            const user = state.currentUser;
            user.name = document.getElementById('customer-name').value;
            user.phoneNumber = document.getElementById('customer-phone-number').value;
            
            const profilePictureFile = document.getElementById('customer-profile-picture').files[0];
            if (profilePictureFile) {
                fileToBase64(profilePictureFile, (base64Url) => {
                    if (base64Url) {
                        user.imageUrl = base64Url;
                    }
                    saveState();
                    showMessage('Profile updated successfully!');
                    renderContent('customer-profile-view'); // Re-render to show new image/data
                    setupDashboard(); // Update top avatar
                });
            } else {
                saveState();
                showMessage('Profile updated successfully!');
                renderContent('customer-profile-view'); // Re-render to show new data
                setupDashboard(); // Update top avatar
            }
        }

        function handleChangeCustomerPassword(event) {
            event.preventDefault();
            const newPassword = document.getElementById('customer-new-password').value;
            const confirmPassword = document.getElementById('customer-confirm-password').value;
            const errorElement = document.getElementById('customer-password-change-error');

            if (newPassword !== confirmPassword) {
                errorElement.textContent = 'Passwords do not match.';
                errorElement.classList.remove('hidden');
                return;
            }
            
            const user = state.currentUser;
            user.password = newPassword; // In a real app, this would be hashed and stored securely.
            saveState();
            
            showMessage('Password changed successfully!');
            document.getElementById('customer-password-change-form').reset();
            errorElement.classList.add('hidden');
        }
        
        // --- Dynamic Form Helpers ---
        function addServiceCheckbox(serviceName, container, isChecked = true) {
            const label = document.createElement('label');
            label.className = 'inline-flex items-center bg-gray-100 p-2 rounded-md';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = 'services';
            checkbox.value = serviceName;
            checkbox.checked = isChecked;
            checkbox.className = 'form-checkbox text-lawn rounded';
            label.appendChild(checkbox);
            const span = document.createElement('span');
            span.className = 'ml-2';
            span.textContent = serviceName;
            label.appendChild(span);
            container.appendChild(label);
        }

        function addAvailabilitySlot(container, day = '', fromTime = '', toTime = '') {
            const slot = document.createElement('div');
            slot.className = 'flex items-center space-x-2 availability-slot';
            const daySelect = document.createElement('select');
            daySelect.className = 'w-1/3 px-3 py-2 border rounded-lg';
            ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].forEach(d => {
                const option = document.createElement('option');
                option.value = d;
                option.textContent = d;
                if (d === day) option.selected = true;
                daySelect.appendChild(option);
            });
            const fromTimeInput = document.createElement('input');
            fromTimeInput.type = 'time'; // Changed to time input
            fromTimeInput.name = 'fromTime';
            fromTimeInput.className = 'w-1/3 px-3 py-2 border rounded-lg';
            fromTimeInput.value = fromTime;

            const toTimeInput = document.createElement('input');
            toTimeInput.type = 'time'; // Changed to time input
            toTimeInput.name = 'toTime';
            toTimeInput.className = 'w-1/3 px-3 py-2 border rounded-lg';
            toTimeInput.value = toTime;

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.textContent = '✖';
            removeBtn.className = 'text-red-500 hover:text-red-700';
            removeBtn.onclick = () => slot.remove();

            slot.appendChild(daySelect);
            slot.appendChild(fromTimeInput);
            slot.appendChild(toTimeInput);
            slot.appendChild(removeBtn);
            container.appendChild(slot);
        }

        // --- Custom Message Box (replacing alert/confirm for better UX) ---
        function showMessage(message) {
            const messageBox = document.createElement('div');
            messageBox.className = 'fixed bottom-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg z-50';
            messageBox.textContent = message;
            document.body.appendChild(messageBox);
            setTimeout(() => {
                messageBox.remove();
            }, 3000);
        }

        function togglePasswordVisibility(fieldId) {
            const field = document.getElementById(fieldId);
            const iconButton = field.nextElementSibling; // The button is the next sibling
            const icon = iconButton.querySelector('svg');

            if (field.type === 'password') {
                field.type = 'text';
                icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .99-3.044 2.981-5.46 5.337-6.918L12 12m0 0l-1.423-1.423m-4.595-4.595L21 21"></path>`; // Eye with slash (hide)
            } else {
                field.type = 'password';
                icon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>`; // Open eye (show)
            }
        }

        // --- Initial setup and event listeners ---
        function initializeEventListeners() {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            // Re-attach toggle-auth-button listener if it's rendered.
            const toggleAuthButton = document.getElementById('toggle-auth-button');
            if (toggleAuthButton) {
                toggleAuthButton.addEventListener('click', toggleAuthForm);
            }

            document.getElementById('logout-button').addEventListener('click', handleLogout);
            document.getElementById('mobile-logout-button').addEventListener('click', handleLogout);
            document.getElementById('menu-button').addEventListener('click', toggleMobileMenu);
            document.getElementById('close-menu-button').addEventListener('click', toggleMobileMenu);
            document.getElementById('new-booking-form').addEventListener('submit', handleNewBooking);
            document.getElementById('mower-profile-form').addEventListener('submit', handleMowerProfileUpdate);
            document.getElementById('customer-profile-form').addEventListener('submit', handleCustomerProfileUpdate);
            document.getElementById('customer-password-change-form').addEventListener('submit', handleChangeCustomerPassword);
            document.getElementById('add-admin-form').addEventListener('submit', handleAddAdmin);
            document.getElementById('admin-password-change-form').addEventListener('submit', handleChangeAdminPassword);
            document.getElementById('rating-form').addEventListener('submit', submitRating);
            document.getElementById('proof-completion-form').addEventListener('submit', submitCompletion);
            document.getElementById('reject-reason-form').addEventListener('submit', submitRejectReason);
            document.getElementById('forgot-password-button').addEventListener('click', showForgotPasswordModal);
            document.getElementById('forgot-password-form').addEventListener('submit', handleForgotPasswordSubmit);


            // Dynamic forms setup
            document.getElementById('register-role').addEventListener('change', e => {
                document.getElementById('mower-fields-container').classList.toggle('hidden', e.target.value !== 'mower');
            });
            document.getElementById('add-custom-service-btn').addEventListener('click', () => {
                const input = document.getElementById('register-custom-service');
                if (input.value) {
                    addServiceCheckbox(input.value, document.getElementById('register-services-list'));
                    input.value = '';
                }
            });
            document.getElementById('add-availability-slot-btn').addEventListener('click', () => addAvailabilitySlot(document.getElementById('register-availability-container')));
            
            document.getElementById('mower-add-service-btn').addEventListener('click', () => {
                const input = document.getElementById('mower-custom-service');
                if(input.value) {
                    addServiceCheckbox(input.value, document.getElementById('mower-services-list'));
                    input.value = '';
                }
            });
            document.getElementById('mower-add-availability-btn').addEventListener('click', () => addAvailabilitySlot(document.getElementById('mower-availability-container')));

            // Star rating interaction
            document.getElementById('stars').addEventListener('click', e => {
                if (e.target.classList.contains('star')) {
                    const rating = e.target.dataset.rating;
                    document.querySelectorAll('#stars .star').forEach(star => {
                        star.classList.toggle('filled', star.dataset.rating <= rating);
                    });
                }
            });

            // Pagination items per page listeners
            document.getElementById('customer-bookings-items-per-page').addEventListener('change', rerenderCurrentTable);
            document.getElementById('customer-invoices-items-per-page').addEventListener('change', rerenderCurrentTable);
            document.getElementById('mower-all-jobs-items-per-page').addEventListener('change', rerenderCurrentTable);
            document.getElementById('mower-invoices-items-per-page').addEventListener('change', rerenderCurrentTable);
            document.getElementById('admin-users-items-per-page').addEventListener('change', rerenderCurrentTable);
            document.getElementById('admin-bookings-items-per-page').addEventListener('change', rerenderCurrentTable);
            document.getElementById('admin-invoices-items-per-page').addEventListener('change', rerenderCurrentTable); // New listener
            document.getElementById('super-admin-users-items-per-page').addEventListener('change', rerenderCurrentTable);

            // Filter listeners
            document.getElementById('customer-bookings-status-filter').addEventListener('change', rerenderCurrentTable);
            document.getElementById('customer-bookings-search').addEventListener('input', rerenderCurrentTable);
            document.getElementById('customer-bookings-date-filter').addEventListener('change', rerenderCurrentTable);

            document.getElementById('customer-invoices-status-filter').addEventListener('change', rerenderCurrentTable);
            document.getElementById('customer-invoices-search').addEventListener('input', rerenderCurrentTable);
            document.getElementById('customer-invoices-date-filter').addEventListener('change', rerenderCurrentTable);
            
            document.getElementById('mower-all-jobs-status-filter').addEventListener('change', rerenderCurrentTable);
            document.getElementById('mower-all-jobs-search').addEventListener('input', rerenderCurrentTable);
            document.getElementById('mower-all-jobs-date-filter').addEventListener('change', rerenderCurrentTable);

            document.getElementById('mower-invoices-status-filter').addEventListener('change', rerenderCurrentTable);
            document.getElementById('mower-invoices-search').addEventListener('input', rerenderCurrentTable);
            document.getElementById('mower-invoices-date-filter').addEventListener('change', rerenderCurrentTable);

            document.getElementById('admin-bookings-status-filter').addEventListener('change', rerenderCurrentTable);
            document.getElementById('admin-bookings-search').addEventListener('input', rerenderCurrentTable);
            document.getElementById('admin-bookings-date-filter').addEventListener('change', rerenderCurrentTable);


            document.getElementById('admin-invoices-status-filter').addEventListener('change', rerenderCurrentTable); // New listener
            document.getElementById('admin-invoices-search').addEventListener('input', rerenderCurrentTable);
            document.getElementById('admin-invoices-date-filter').addEventListener('change', rerenderCurrentTable);

            document.getElementById('admin-users-filter-role').addEventListener('change', rerenderCurrentTable);
            document.getElementById('admin-users-search').addEventListener('input', rerenderCurrentTable);
            document.getElementById('super-admin-users-search').addEventListener('input', rerenderCurrentTable);
        }

        window.addEventListener('load', () => {
            loadState();
            checkAuthAndRoute();
            initializeEventListeners(); // Initialize listeners after views are loaded and auth checked
        });
        
        function renderContent(contentId) {
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            // Find the active link based on the contentId and add the 'active' class
            const activeLink = document.querySelector(`a[onclick="renderContent('${contentId}')"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            
            document.querySelectorAll('#content-container > div').forEach(content => content.classList.add('hidden'));
            document.getElementById(contentId).classList.remove('hidden');
            
            const titleMap = {
                'customer-dashboard-view': 'Dashboard', 'customer-new-booking-view': 'New Booking', 'customer-bookings-view': 'My Bookings', 'customer-profile-view': 'My Profile', 'customer-invoices-view': 'Invoices',
                'mower-dashboard-view': 'Dashboard', 'mower-all-jobs-view': 'Jobs', 'mower-profile-view': 'My Profile', 'mower-invoices-view': 'My Invoices',
                'admin-dashboard-view': 'Dashboard', 'admin-users-view': 'Manage Users', 'admin-bookings-view': 'All Bookings', 'admin-invoices-view': 'Invoices',
                'super_admin-dashboard-view': 'Dashboard', 'super_admin-users-view': 'Manage Admins', 'super_admin-add-admin-view': 'Add New Admin'
            };
            document.getElementById('page-title').textContent = titleMap[contentId] || 'Dashboard';
            
            // Render specific content
            switch (contentId) {
                case 'customer-dashboard-view': renderDashboardContent('customer'); break;
                case 'customer-new-booking-view': renderAvailableProvidersList(); break;
                case 'customer-bookings-view': renderCustomerBookingsTable(); break;
                case 'customer-invoices-view': renderCustomerInvoicesTable(); break;
                case 'customer-profile-view': populateCustomerProfileForm(); break;
                case 'mower-dashboard-view': renderDashboardContent('mower'); break;
                case 'mower-all-jobs-view': renderMowerCombinedJobsTable(); break;
                case 'mower-invoices-view': renderMowerInvoicesTable(); break;
                case 'mower-profile-view': populateMowerProfileForm(); break;
                case 'admin-dashboard-view': renderDashboardContent('admin'); break;
                case 'admin-users-view': renderAdminUsersTable(); break;
                case 'admin-bookings-view': renderAdminBookingsTable(); break;
                case 'admin-invoices-view': renderAdminInvoicesTable(); break; // New case
                case 'super_admin-dashboard-view': renderDashboardContent('super_admin'); break;
                case 'super_admin-users-view': renderSuperAdminUsersTable(); break;
            }
        }
    </script>
</body>
</html>
