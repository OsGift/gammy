<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bible Quiz — Player Rounds</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#041026; --bg2:#071734; --card:#081226;
    --accent:#06b6d4; --accent-2:#7c3aed; --muted:#94a3b8;
    --glass:rgba(255,255,255,0.03)
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    background: linear-gradient(180deg,var(--bg1),var(--bg2));
    color:#e6eef6; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px;
  }
  .app{width:100%; max-width:1100px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  h1{margin:0;color:var(--accent);font-size:1.4rem}
  .sub{color:var(--muted);font-size:0.9rem}
  .layout{display:grid;grid-template-columns:360px 1fr;gap:18px}
  @media (max-width:900px){.layout{grid-template-columns:1fr}}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:14px;padding:14px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
  label{display:block;font-weight:600;margin:10px 0 6px;color:#dbeafe}
  textarea,input,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:14px}
  .btn{background:linear-gradient(90deg,var(--accent),#06b6b9);border:none;padding:10px 14px;border-radius:10px;color:#021025;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .players-list{margin-top:10px;padding:10px;border-radius:10px;background:var(--glass);min-height:120px;max-height:260px;overflow:auto}
  .player{display:flex;align-items:center;justify-content:space-between;padding:10px;margin-bottom:8px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.008));cursor:grab}
  .player.dragging{opacity:0.5;transform:scale(0.995)}
  .player .name{font-weight:700}
  .muted{color:var(--muted);font-size:0.9rem}
  /* Game area */
  .game-top{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .banner{display:flex;flex-direction:column}
  .category-badge{background:linear-gradient(90deg,var(--accent-2),var(--accent));padding:8px 12px;border-radius:999px;font-weight:800;color:#021025;display:inline-block}
  .current-player{font-weight:800;font-size:1.1rem;color:#dbeafe}
  .timer{font-weight:900;font-size:1.6rem;color:#ffb020}
  .progress{color:var(--muted);font-size:0.9rem}
  .clue-box{margin-top:18px;border-radius:12px;padding:22px;background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.008));box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);min-height:160px;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center}
  .clue{font-size:3.2rem;letter-spacing:6px}
  .hint{margin-top:12px;font-size:1.05rem;color:#fbbf24}
  .answer{margin-top:8px;font-size:1.05rem;color:#22c55e}
  .controls{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap;justify-content:center}
  .btn.big{padding:12px 20px;font-size:1rem;border-radius:12px}
  .btn.danger{background:linear-gradient(90deg,#ef4444,#f97316);color:white}
  .small-muted{font-size:0.9rem;color:var(--muted);margin-top:8px;text-align:center}
  .score-row{display:flex;justify-content:space-between;padding:12px;border-radius:10px;margin-bottom:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.008))}
  footer{margin-top:12px;color:var(--muted);font-size:0.9rem;text-align:center}
  .fade{animation:fade .28s ease}
  @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  .settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media (max-width:520px){.settings-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Bible Quiz — Player Rounds</h1>
        <div class="sub">Per-player rounds · set times for hint & reveal · persistent</div>
      </div>
      <div>
        <button id="clearStorageBtn" class="btn ghost">New Game (clear save)</button>
      </div>
    </header>

    <main class="layout">
      <!-- LEFT: Setup -->
      <section class="panel" id="setupPanel">
        <label>Participants (one per line)</label>
        <textarea id="namesInput" rows="6" placeholder="Alice
Bob
Chike"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="loadPlayersBtn" class="btn">Load Players</button>
          <button id="resetNamesBtn" class="btn ghost">Clear</button>
        </div>

        <label style="margin-top:12px">Starting Order (drag to reorder)</label>
        <div class="players-list" id="playersList" aria-label="Player order"></div>

        <label style="margin-top:10px">Main Category</label>
        <select id="mainCategorySelect">
        </select>

        <label style="margin-top:10px">Sub-Category</label>
        <select id="subCategorySelect">
        </select>

        <label style="margin-top:10px">Number of questions per player</label>
        <input id="numQuestions" type="number" min="1" value="6" />

        <label style="margin-top:10px">Timing (seconds)</label>
        <div class="settings-grid">
          <div>
            <label class="muted" style="font-weight:600">Time before hint</label>
            <input id="timeBeforeHint" type="number" min="1" value="5" />
          </div>
          <div>
            <label class="muted" style="font-weight:600">Time after hint (until reveal)</label>
            <input id="timeAfterHint" type="number" min="1" value="5" />
          </div>
        </div>

        <div style="display:flex;gap:10px;margin-top:12px">
          <button id="startBtn" class="btn">Start Round</button>
          <button id="resumeBtn" class="btn ghost">Resume Saved</button>
        </div>

        <div class="small-muted" style="margin-top:10px">Questions come from the selected category. The deck randomizes per category and won't repeat until exhausted. Refreshing doesn't lose progress.</div>
      </section>

      <!-- RIGHT: Game -->
      <section class="panel" id="gamePanel">
        <div id="gameInner"><div class="muted">No game running. Configure players and start a round.</div></div>
      </section>
    </main>

    <footer>Created for you — sounds enabled after first Start/Resume click.</footer>
  </div>

  <!-- Sounds -->
  <audio id="tickSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
  <audio id="revealSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>
  <audio id="endSound" src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" preload="auto"></audio>

<script>
/* =========================
   QUESTION DATA (same full sets)
   ========================= */
const BOOKS_QUESTIONS = [
  // Emoji Puzzles
  { clue: "🐑🕊️", hint: "A collection of sacred songs and poems", answer: "Psalms" },
  { clue: "🌾🍞🍷", hint: "Features stories of Jesus' miracles, including feeding thousands and the Last Supper", answer: "John / Gospels" },
  { clue: "🔥🏔️📜", hint: "Describes the liberation of Israelites from slavery and the giving of the Law on a mountain", answer: "Exodus" },
  { clue: "🐠➡️🚶‍♂️", hint: "This book tells the story of a prophet swallowed by a great fish and later preaching to Nineveh", answer: "Jonah" },
  { clue: "🐪💰👑", hint: "Begins with the genealogy of Jesus and includes the story of the wise men visiting baby Jesus", answer: "Matthew" },
  { clue: "⚖️🧑‍⚖️📜", hint: "Contains laws and speeches from Moses before the Israelites entered the Promised Land", answer: "Deuteronomy / Judges" },
  { clue: "🐍🍎🧑‍🤝‍🧑", hint: "The first book, describing creation, the fall, and early human history", answer: "Genesis" },
  { clue: "🏹🦌🏃‍♂️", hint: "Chronicles the life of Israel's first king and the rise of a young shepherd to kingship", answer: "1 Samuel" },
  { clue: "🕯️📖✡️", hint: "Focuses on the return of exiles from Babylon and the rebuilding of the Temple", answer: "Ezra" },
  { clue: "🛶🌊😴", hint: "One of the Gospels that features Jesus calming a storm while sleeping in a boat", answer: "Mark / Gospels" },
  { clue: "🕊️🩸⛪", hint: "An epistle emphasizing Jesus as the superior high priest and the new covenant", answer: "Hebrews" },
  { clue: "🏗️🧱🔔", hint: "Tells of the rebuilding of Jerusalem's walls after the exile", answer: "Nehemiah" },

  // Cryptic
  { clue: "Short letter by fisherman who saw the resurrected", hint: "An epistle from an apostle who denied Jesus but was restored", answer: "1 Peter" },
  { clue: "Its title means 'hidden' — dreams & fiery faith", hint: "Features visions and stories like the fiery furnace and the lion's den", answer: "Daniel" },
  { clue: "Courtroom drama where the innocent are tried", hint: "A book that explores themes of suffering and patience through the story of a righteous man", answer: "Job" },
  { clue: "'Vanity!' — practical advice for living", hint: "A philosophical book that reflects on the meaning of life and earthly pursuits", answer: "Ecclesiastes" },
  { clue: "Annals of kings — rise and fall", hint: "Historical books detailing the reigns of various kings in Israel and Judah", answer: "1 & 2 Chronicles" },
  { clue: "Named after a sea creature — lament & deliverance", hint: "This prophetic book recounts a prophet's journey to Nineveh after being swallowed by a large fish", answer: "Jonah" },
  { clue: "Missionary travel log by physician-historian", hint: "A New Testament book narrating the early church's spread and missionary journeys", answer: "Luke / Acts" },
  { clue: "Short prophetic flash vs a proud northern city", hint: "A minor prophet who foretold the destruction of Nineveh", answer: "Nahum" },
  { clue: "Encouragement letter from prison", hint: "An epistle written by Paul from prison, encouraging joy and unity", answer: "Philippians" },
  { clue: "A love poem doubling as allegory", hint: "A poetic book often interpreted as an allegory for God's love for His people", answer: "Song of Solomon" },
  { clue: "Oracle about a vineyard; image of judgment", hint: "A major prophet known for extensive prophecies about the Messiah and judgment", answer: "Isaiah" },
  { clue: "Starts with genealogy; ends with empty tomb", hint: "The first Gospel, beginning with Jesus' ancestry and concluding with his resurrection", answer: "Matthew" },

  // Riddles
  { clue: "Opens with creation; many families, one ancestor", hint: "This foundational book describes the beginning of the world and humanity", answer: "Genesis" },
  { clue: "Poetry for the heart — songs & laments", hint: "A collection of 150 lyrical compositions for worship and reflection", answer: "Psalms" },
  { clue: "Laws and wandering; people's second beginning", hint: "Contains Moses' farewell speeches and a reiteration of the Law before entering Canaan", answer: "Deuteronomy" },
  { clue: "Short prophet naming 'the day of the Lord'", hint: "A minor prophet who speaks of a coming 'Day of the Lord'", answer: "Joel" },
  { clue: "Born of exile; rebuilding walls & worship", hint: "Follows a cupbearer who leads the rebuilding of Jerusalem's walls", answer: "Nehemiah" },
  { clue: "Shepherd becomes king; covenant & temple plans", hint: "Details the transition from the first king to a shepherd who becomes a great king", answer: "1 Samuel / 2 Samuel" },
  { clue: "Logical writer tracing Jesus' teachings", hint: "A Gospel writer, known for his detailed historical accounts and focus on Jesus' humanity", answer: "Luke" },
  { clue: "Courtroom poem & childless couple rejoicing", hint: "Features stories of judges and a woman who prayed for a child", answer: "Judges / 1 Samuel" },
  { clue: "Visions of beasts, horns & a little scroll", hint: "Contains apocalyptic visions of future events and symbolic creatures", answer: "Daniel / Revelation" },
  { clue: "Practical maxims; father's short advice", hint: "A book of wisdom literature offering guidance for living a righteous life", answer: "Proverbs" },

  // Mini-Scenario
  { clue: "You kneel to wash feet at a last supper. Which book?", hint: "This Gospel uniquely describes Jesus washing his disciples' feet", answer: "John" },
  { clue: "You're told to build an ark; birds prove dryness", hint: "The story of a great flood and a family saved in a large boat", answer: "Genesis" },
  { clue: "A prophet is taken in a whirlwind into heaven", hint: "Describes a prophet's miraculous ascension in a fiery chariot", answer: "2 Kings" },
  { clue: "Stone rolled away; angels at the tomb", hint: "Accounts of Jesus' resurrection, including the empty tomb and angelic announcements", answer: "Gospels" },
  { clue: "Nehemiah planning a city wall — which book?", hint: "A historical book about the reconstruction of Jerusalem's fortifications", answer: "Nehemiah" },
  { clue: "Love letters in an ancient courtship song", hint: "A poetic book expressing romantic love, often interpreted allegorically", answer: "Song of Solomon" },
  { clue: "Valley of dry bones becomes warriors", hint: "A prophetic vision of dry bones being brought back to life", answer: "Ezekiel" },
  { clue: "A meek tax collector climbs a tree", hint: "The Gospel story of a short tax collector who wanted to see Jesus", answer: "Luke" },
  { clue: "A virgin told she'll bear a son: 'God with us'", hint: "Narratives of the announcement of Jesus' birth to his mother", answer: "Matthew / Luke" },
  { clue: "A prophet survives a den of predators", hint: "The account of a prophet miraculously preserved in a den of lions", answer: "Daniel" }
];

const CHARACTER_QUESTIONS = [
  { clue: "👨‍🌾🍎", hint: "The first man created, who lived in the Garden of Eden", answer: "Adam" },
  { clue: "👩‍🌾🍎", hint: "The first woman, created from a rib, who ate the forbidden fruit", answer: "Eve" },
  { clue: "🌧️🕊️🌈", hint: "Built an ark to save his family and animals from a great flood", answer: "Noah" },
  { clue: "🔥⭐→descendants", hint: "Considered the father of many nations, he received a covenant from God", answer: "Abraham" },
  { clue: "👵➡️🎯 (barrenness then laughter)", hint: "The wife of Abraham, who initially laughed at the promise of having a child in her old age", answer: "Sarah" },
  { clue: "🥖🥩→sacrifice", hint: "The son of Abraham, whom his father was commanded to sacrifice", answer: "Isaac" },
  { clue: "🧵�🛌→dreams", hint: "Sold into slavery by his brothers, he later rose to power in Egypt and interpreted dreams", answer: "Joseph" },
  { clue: "🔥🌊→leader", hint: "Led the Israelites out of slavery in Egypt and parted the Red Sea", answer: "Moses" },
  { clue: "👨‍⚖️📜→priest", hint: "The first high priest of the Israelites, brother of Moses", answer: "Aaron" },
  { clue: "🗡️🏹→judge & judge-slayer", hint: "An Israelite judge famous for his immense strength and long hair", answer: "Samson" },
  { clue: "🛡️👑→first king", hint: "The first king of Israel, chosen by God but later rejected for disobedience", answer: "Saul" },
  { clue: "🏹🎵👑", hint: "A shepherd boy who became king of Israel, known for his psalms and defeating a giant", answer: "David" },
  { clue: "🕊️⚖️👑", hint: "Known for his great wisdom and for building the first Temple in Jerusalem", answer: "Solomon" },
  { clue: "🔥🚒—hid in cave", hint: "A powerful prophet who challenged the prophets of Baal and was taken to heaven in a whirlwind", answer: "Elijah" },
  { clue: "🧑‍⚕️✍️→historian", hint: "A physician and Gentile writer who penned one of the Gospels and the Book of Acts", answer: "Luke" },
  { clue: "🌊🐳 (swallowed)", hint: "A prophet commanded to go to Nineveh, who was swallowed by a large fish after fleeing", answer: "Jonah" },
  { clue: "👰→queen (saved people)", hint: "A Jewish queen in Persia who risked her life to save her people from annihilation", answer: "Esther" },
  { clue: "👩‍🌾➡️loyal", hint: "A Moabite woman who showed great loyalty to her mother-in-law, Naomi", answer: "Ruth" },
  { clue: "✝️—teacher, miracles", hint: "The central figure of Christianity, known for his teachings, miracles, and resurrection", answer: "Jesus" },
  { clue: "🚶‍♂️👣—denied, restored", hint: "One of Jesus' main disciples, who denied him three times but was later restored", answer: "Peter" },
  { clue: "📜✍️→missionary", hint: "A former persecutor of Christians who became a prolific apostle and missionary to the Gentiles", answer: "Paul" },
  { clue: "🧔🔔—forerunner", hint: "A prophet who prepared the way for Jesus, baptizing people in the Jordan River", answer: "John the Baptist" },
  { clue: "🪢🏙️—faithful spy", hint: "A Canaanite woman who helped the Israelite spies in Jericho and was saved when the city fell", answer: "Rahab" },
  { clue: "🎻🎼(psalms)", hint: "Authored many of the psalms and was the second king of Israel", answer: "David" },
  { clue: "🪓🏛️→rebuild", hint: "A cupbearer to the Persian king who led the rebuilding of Jerusalem's walls", answer: "Nehemiah" },
  { clue: "👵➡️son miracle", hint: "A barren woman who prayed earnestly and gave birth to the prophet Samuel", answer: "Hannah" },
  { clue: "⚖️⚔️→judge", hint: "A prophet and judge who anointed both Saul and David as kings of Israel", answer: "Samuel" },
  { clue: "🧱→wisdom writer", hint: "A king of Israel renowned for his wisdom and credited with writing Proverbs and Ecclesiastes", answer: "Solomon" },
  { clue: "🕶️➡️vision (apostle)", hint: "The beloved disciple, who wrote a Gospel, epistles, and the Book of Revelation", answer: "John (the Apostle)" },
  { clue: "🧾➡️tax collector", hint: "A chief tax collector who climbed a tree to see Jesus and later repented", answer: "Zacchaeus" },
  { clue: "👑➡️wise woman", hint: "A wise and discerning woman who intervened to prevent David from committing revenge", answer: "Abigail" },
  { clue: "🇮🇱→messenger (prophet)", hint: "Known as the 'weeping prophet,' he prophesied Judah's destruction and exile", answer: "Jeremiah" },
  { clue: "📜→visions of dry bones", hint: "A prophet who had visions, including one of a valley of dry bones brought back to life", answer: "Ezekiel" }
];

const TECH_QUESTIONS = [
  { clue: "☁️💾", hint: "Storing data online rather than on a local device, accessible from anywhere", answer: "Cloud Storage" },
  { clue: "🐍💻", hint: "A versatile and popular programming language often used for web development, data analysis, and AI, named after a British comedy troupe", answer: "Python" },
  { clue: "📱🍎", hint: "Apple's flagship smartphone, renowned for its design and ecosystem", answer: "iPhone" },
  { clue: "🐳📦", hint: "A platform for developers to build, share, and run applications using lightweight, portable units called containers", answer: "Docker" },
  { clue: "👓🌐", hint: "Wearable technology that overlays digital information onto the real world, enhancing perception", answer: "Smart Glasses" },
  { clue: "⚙️📜", hint: "A sequence of instructions designed to automate repetitive tasks or processes on a computer", answer: "Automation Script" },
  { clue: "🔍🌐", hint: "The world's most widely used search engine, an essential tool for finding information online", answer: "Google" },
  { clue: "🛡️🔑", hint: "A security measure that requires users to provide two different forms of identification before gaining access", answer: "Two-Factor Authentication" },
  { clue: "🧠🤖", hint: "The broad field of computer science focused on creating machines that can perform tasks normally requiring human intelligence", answer: "Artificial Intelligence" },
  { clue: "🌐💻", hint: "A global system of interconnected computer networks that uses standard communication protocols to serve billions of users", answer: "Internet" },
  { clue: "🔗🧱", hint: "A decentralized, distributed ledger technology that underlies cryptocurrencies like Bitcoin", answer: "Blockchain" },
  { clue: "🎮👓", hint: "Technology that creates a simulated environment, immersing the user in a virtual world", answer: "Virtual Reality (VR)" },
  { clue: "💾💿", hint: "A portable storage device that uses flash memory to store data, replacing older floppy disks and CDs", answer: "USB Drive" },
  { clue: "📡📶", hint: "A technology that allows devices to connect to a network wirelessly, commonly found in homes and public places", answer: "Wi-Fi" },
  { clue: "🗣️📱", hint: "Software that understands and responds to voice commands, found in smartphones and smart speakers", answer: "Voice Assistant" },
  { clue: "🔋⚡", hint: "The ability of a device to operate without being plugged into a power source, crucial for mobile devices", answer: "Battery Life" },
  { clue: "🛒🛍️", hint: "The process of buying and selling goods or services over the internet", answer: "E-commerce" },
  { clue: "📈📊", hint: "The practice of collecting, processing, and analyzing large datasets to extract insights and inform decisions", answer: "Big Data" },
  { clue: "🏠💡", hint: "A system of interconnected devices and appliances that can be controlled remotely via the internet", answer: "Smart Home" },
  { clue: "🚀🌌", hint: "The privately funded industry focused on space exploration and commercial space activities", answer: "New Space" }
];

const COUNTRY_QUESTIONS = [
  { clue: "🗼🍣", hint: "An island nation known for its cherry blossoms, sushi, and ancient traditions", answer: "Japan" },
  { clue: "🦘🏄‍♂️", hint: "A vast continent and country famous for its unique wildlife and surfing beaches", answer: "Australia" },
  { clue: "🍕🍝", hint: "A European country shaped like a boot, famous for its pasta, pizza, and historical sites", answer: "Italy" },
  { clue: "🏰🍺", hint: "Known for its historical castles, beer festivals like Oktoberfest, and engineering", answer: "Germany" },
  { clue: "🕌🐪", hint: "A desert kingdom in the Middle East, home to holy cities of Islam", answer: "Saudi Arabia" },
  { clue: "🦁🏝️", hint: "A large island nation off the southeast coast of Africa, known for lemurs", answer: "Madagascar" },
  { clue: "🥨⛷️", hint: "An alpine nation famous for its precision watches, chocolates, and neutrality", answer: "Switzerland" },
  { clue: "🎭⚽", hint: "A South American country known for its vibrant carnival celebrations and football passion", answer: "Brazil" },
  { clue: "🗽🍔", hint: "A North American country known for its diverse landscapes, iconic landmarks, and fast food culture", answer: "USA" },
  { clue: "🥷🍵", hint: "The land of samurai, beautiful tea ceremonies, and modern technology", answer: "Japan" },
  { clue: "🍁🏒", hint: "North American country famous for maple syrup and ice hockey", answer: "Canada" },
  { clue: " pyramides 🇪🇬", hint: "Ancient civilization known for its pharaohs and massive desert structures", answer: "Egypt" },
  { clue: "🐘🌶️", hint: "A South Asian country known for its vibrant spices, diverse cultures, and large population", answer: "India" },
  { clue: "🍷🥖", hint: "European country famous for its fine wines, cheeses, and the Eiffel Tower", answer: "France" },
  { clue: "🐉万里", hint: "East Asian country with a rich history, known for the Great Wall and dragons", answer: "China" },
  { clue: "🇬🇧👑", hint: "An island nation, home to the Royal Family and famous for its historical landmarks", answer: "United Kingdom" },
  { clue: "❄️🌲", hint: "A large Northern European country known for its cold winters, vast forests, and unique folklore", answer: "Finland" },
  { clue: "🇳🇿🐑", hint: "An island nation in the Pacific Ocean, famous for its stunning natural landscapes and sheep farming", answer: "New Zealand" },
  { clue: "🇷🇺🐻", hint: "The world's largest country by land area, spanning Eastern Europe and Northern Asia", answer: "Russia" },
  { clue: "🇦🇷💃", hint: "A South American country known for its tango music and dance, and vast plains", answer: "Argentina" }
];

const POPCULTURE_QUESTIONS = [
  { clue: "⚡🧙‍♂️", hint: "A British orphan discovers he is a wizard and attends Hogwarts School of Witchcraft and Wizardry", answer: "Harry Potter" },
  { clue: "🦸‍♂️🛡️🇺🇸", hint: "A super-soldier from WWII who wields an indestructible shield and fights for justice", answer: "Captain America" },
  { clue: "👽📞🏠", hint: "A gentle alien stranded on Earth befriends a young boy and seeks to return to his home planet", answer: "E.T." },
  { clue: "🎮🍄", hint: "A popular Italian plumber video game character who rescues a princess in the Mushroom Kingdom", answer: "Mario" },
  { clue: "🧊👑", hint: "A Disney queen with magical powers to control ice and snow, whose kingdom is perpetually frozen", answer: "Elsa (Frozen)" },
  { clue: "🦖🏝️", hint: "A theme park where dinosaurs are brought back to life through cloning, leading to disastrous consequences", answer: "Jurassic Park" },
  { clue: "🎤👑", hint: "A legendary British rock band fronted by Freddie Mercury, known for their elaborate stage shows and anthemic songs", answer: "Queen" },
  { clue: "🛡️⚔️🐉", hint: "An epic fantasy television series about noble families battling for control of a fictional continent's Iron Throne", answer: "Game of Thrones" },
  { clue: "🚗💨💨", hint: "A long-running film franchise centered around street racing, heists, and themes of family loyalty", answer: "Fast & Furious" },
  { clue: "👩‍🚀🌌", hint: "An epic space opera saga involving a galaxy far, far away and the perennial struggle between the Jedi and the Sith", answer: "Star Wars" },
  { clue: "🕸️🕷️", hint: "A popular superhero known for his arachnid-like abilities and web-slinging across New York City", answer: "Spider-Man" },
  { clue: " detect 🕵️‍♀️", hint: "A fictional detective with extraordinary powers of observation and deduction, often accompanied by his loyal friend Dr. Watson", answer: "Sherlock Holmes" },
  { clue: " yellow 🟡 family 👨‍👩‍👧‍👦", hint: "A long-running animated sitcom about a dysfunctional, yellow-skinned family and their life in Springfield", answer: "The Simpsons" },
  { clue: " magic ✨ castle 🏰", hint: "A magical theme park created by Walt Disney, known for its iconic castle and beloved characters", answer: "Disneyland" },
  { clue: " zombie 🧟‍♀️ walk 🚶", hint: "A post-apocalyptic horror TV series about survivors navigating a world overrun by the undead", answer: "The Walking Dead" },
  { clue: " bat 🦇 signal 🔦", hint: "A dark knight superhero who protects Gotham City using advanced gadgets and martial arts skills", answer: "Batman" },
  { clue: " blue 🔵 box 📦", hint: "A British science fiction TV show about a Time Lord who travels through time and space in a police box-shaped spaceship", answer: "Doctor Who" },
  { clue: " wizard 🧙‍♂️ of Oz 🌈", hint: "A classic musical film about a young girl transported to a magical land, accompanied by a scarecrow, tin man, and cowardly lion", answer: "The Wizard of Oz" },
  { clue: " superhero 💪 team 🦸‍♂️", hint: "A team of superheroes from the Marvel Comics universe who unite to fight powerful threats", answer: "The Avengers" },
  { clue: " spy 🕵️‍♂️ licence 🍸", hint: "A British Secret Service agent known for his sophisticated gadgets, smooth demeanor, and signature shaken martini", answer: "James Bond" }
];

const FOOD_QUESTIONS = [
  { clue: "🍔🍟🥤", hint: "A classic combination often found at fast-food restaurants for a quick meal", answer: "Burger Meal" },
  { clue: "🍣🥢", hint: "A traditional Japanese dish consisting of vinegared rice, seafood, and vegetables, often served raw", answer: "Sushi" },
  { clue: "🌮🇲🇽", hint: "A traditional Mexican dish made of a corn or wheat tortilla folded or rolled around a filling, popular for its vibrant flavors", answer: "Taco" },
  { clue: "🥐☕", hint: "A popular French breakfast pairing of a buttery, flaky pastry and a hot beverage, often enjoyed in cafes", answer: "Croissant and Coffee" },
  { clue: "🍫🍓", hint: "Fresh fruit covered in a sweet, melted confection, often served as a romantic dessert or treat", answer: "Chocolate-Covered Strawberries" },
  { clue: "🍜🥟", hint: "A Japanese noodle soup dish, served with various toppings like sliced pork, seaweed, and eggs, known for its rich broth", answer: "Ramen" },
  { clue: "🍕🧀", hint: "A savory dish of Italian origin, consisting of a round, flattened base of dough topped with tomatoes, cheese, and often various other ingredients, baked in an oven", answer: "Pizza" },
  { clue: "🥗🥒", hint: "A healthy dish consisting of mixed green vegetables, often with other ingredients like fruits, nuts, or meat, typically served cold with dressing", answer: "Salad" },
  { clue: "🍦🍪", hint: "A dessert made by placing a scoop of frozen dessert between two biscuits or cookies, creating a sweet handheld treat", answer: "Ice Cream Sandwich" },
  { clue: "🍋🥤", hint: "A sweet and sour beverage made from lemon juice, sugar, and water, often served cold and refreshing in summer", answer: "Lemonade" },
  { clue: "🌶️🥘", hint: "A spicy stew, often containing meat, beans, and chili peppers, popular in Tex-Mex cuisine", answer: "Chili" },
  { clue: "🧇🥞", hint: "A breakfast food made from batter or dough cooked between two plates, often served with syrup and fruit", answer: "Waffles / Pancakes" },
  { clue: "🥖🧀", hint: "A classic French pairing, often served as an appetizer or light meal", answer: "Bread and Cheese" },
  { clue: "🍩☕", hint: "A popular fried dough confection, often sweet and glazed, paired with a hot morning beverage", answer: "Doughnut and Coffee" },
  { clue: "🍣🍚", hint: "A staple Asian food, the foundation of many meals, often served steamed or boiled", answer: "Rice" },
  { clue: "🥔🍟", hint: "Thin strips of potato, deep-fried until crispy, a common side dish in fast food", answer: "French Fries" },
  { clue: "🍗🌶️", hint: "Chicken pieces coated in a spicy batter and deep-fried, a popular comfort food", answer: "Fried Chicken" },
  { clue: "🍰🎂", hint: "A sweet baked dessert, often decorated and served at celebrations", answer: "Cake" },
  { clue: "🍇🍷", hint: "Fermented fruit juice, an alcoholic beverage often enjoyed with meals", answer: "Wine" },
  { clue: "🍜🍜", hint: "Quick-cooking dried noodles, often sold in individual packets with seasoning", answer: "Instant Noodles" }
];

const MOVIE_QUESTIONS = [
  { clue: "🦁👑", hint: "An animated classic set in the African savanna about a young lion's journey to claim his destiny", answer: "The Lion King" },
  { clue: "🤖👽", hint: "A sci-fi action film about a cyborg assassin sent from the future to kill a woman whose son will save humanity", answer: "The Terminator" },
  { clue: "🧙‍♂️💍", hint: "An epic fantasy adventure where a hobbit embarks on a perilous quest to destroy a powerful, corrupting ring", answer: "The Lord of the Rings" },
  { clue: "🦇🌃", hint: "A superhero film featuring a dark, brooding vigilante protecting a crime-ridden city from villains", answer: "The Dark Knight" },
  { clue: "🚢🧊💔", hint: "A dramatic romance set against the backdrop of a catastrophic maiden voyage of a luxurious ocean liner in the early 20th century", answer: "Titanic" },
  { clue: "🕷️🕸️🏙️", hint: "A superhero origin story about a teenager who gains extraordinary abilities after being bitten by a radioactive arachnid", answer: "Spider-Man" },
  { clue: "🍝 Godfather 🔫", hint: "A powerful crime drama revolving around an aging patriarch of a powerful Italian-American crime family and his successor", answer: "The Godfather" },
  { clue: "👻🚫", hint: "A comedy about a team of eccentric scientists who start a business catching supernatural apparitions in New York City", answer: "Ghostbusters" },
  { clue: "🚀🌌🌠", hint: "A landmark space opera that introduces iconic characters and a sweeping conflict between a heroic rebellion and an evil empire", answer: "Star Wars" },
  { clue: "🧸🐻", hint: "A beloved bear who loves honey and has gentle adventures with his friends in the Hundred Acre Wood", answer: "Winnie the Pooh" },
  { clue: "🏎️💨⚡", hint: "A Pixar animated film about a rookie race car eager to win the Piston Cup", answer: "Cars" },
  { clue: "🧜‍♀️🧜‍♂️", hint: "A Disney animated musical about a young mermaid princess who longs to be human", answer: "The Little Mermaid" },
  { clue: "🎄🎅🎁", hint: "A classic Christmas film about a man who learns the true meaning of the holiday from three spirits", answer: "A Christmas Carol" },
  { clue: "🕵️‍♂️🎩", hint: "A famous spy known for his gadgets, elegant suits, and catchphrases like 'shaken, not stirred'", answer: "James Bond" },
  { clue: "🧙‍♀️👠", hint: "A young girl is transported to a magical land of Munchkins and flying monkeys, following the Yellow Brick Road", answer: "The Wizard of Oz" },
  { clue: "🚢🏴‍☠️", hint: "A swashbuckling adventure film series about a quirky pirate captain and his crew", answer: "Pirates of the Caribbean" },
  { clue: "🦖🦕", hint: "A groundbreaking sci-fi adventure where scientists clone dinosaurs for a theme park that goes terribly wrong", answer: "Jurassic Park" },
  { clue: "🐼🥋", hint: "An animated film about a clumsy panda who dreams of becoming a kung fu master", answer: "Kung Fu Panda" },
  { clue: "👽🚲🌕", hint: "A young boy befriends an extraterrestrial being and helps him return to his home planet", answer: "E.T. the Extra-Terrestrial" },
  { clue: "🥕🐰", hint: "A classic animated character known for his mischievous nature and a fondness for a certain vegetable", answer: "Bugs Bunny" }
];

const ANIMAL_QUESTIONS = [
  { clue: "🐘🌿", hint: "The largest land mammal, known for its long trunk and tusks, often found in Africa and Asia", answer: "Elephant" },
  { clue: "🦒📏", hint: "The tallest living terrestrial animal, characterized by its extremely long neck and legs, native to Africa", answer: "Giraffe" },
  { clue: "🐧❄️", hint: "A flightless bird primarily found in the Southern Hemisphere, adapted for life in the water and known for its waddling walk", answer: "Penguin" },
  { clue: "🐅 stripes", hint: "A large carnivorous feline, easily recognized by its distinctive black stripes on orange fur, a powerful hunter", answer: "Tiger" },
  { clue: "🐬🌊", hint: "A highly intelligent marine mammal known for its playful behavior, echolocation, and often seen leaping out of water", answer: "Dolphin" },
  { clue: "🦉🌙", hint: "A nocturnal bird of prey with large, forward-facing eyes and a distinctive hoot, known for its silent flight", answer: "Owl" },
  { clue: "🐒🍌", hint: "A primate known for its agility in trees and a diet often including fruit, especially tropical ones", answer: "Monkey" },
  { clue: "🐍🌳", hint: "A legless reptile that moves by slithering, some species of which are venomous, found in diverse habitats", answer: "Snake" },
  { clue: "🐻🍯", hint: "A large omnivorous mammal, often associated with forests, hibernation, and a love for sweet treats like honey", answer: "Bear" },
  { clue: "🦊 cunning", hint: "A small to medium-sized carnivorous mammal belonging to the dog family, known for its slyness and bushy tail", answer: "Fox" },
  { clue: "🐴🐎", hint: "A domesticated hoofed mammal, often used for riding, racing, or farm work", answer: "Horse" },
  { clue: "🐱🐈", hint: "A small domesticated carnivorous mammal with soft fur, a short snout, and retractable claws, popular as a pet", answer: "Cat" },
  { clue: "🐶🐕", hint: "A domesticated carnivorous mammal, widely kept as a pet or for work purposes, known for loyalty", answer: "Dog" },
  { clue: "🐝🍯", hint: "A stinging winged insect known for producing honey and beeswax, and its role in pollination", answer: "Bee" },
  { clue: "🦋🌸", hint: "An insect with large, often brightly colored wings, that develops from a caterpillar", answer: "Butterfly" },
  { clue: "🐠🐡", hint: "A cold-blooded aquatic vertebrate with gills and fins, living in water", answer: "Fish" },
  { clue: "🕷️🕸️", hint: "An eight-legged arachnid known for spinning webs to catch prey", answer: "Spider" },
  { clue: "🐦🕊️", hint: "A warm-blooded egg-laying vertebrate distinguished by the possession of feathers, wings, and a beak", answer: "Bird" },
  { clue: "🐊🐊", hint: "A large, semi-aquatic reptile with a powerful tail and jaws, native to tropical regions", answer: "Crocodile" },
  { clue: "🐢🐢", hint: "A slow-moving reptile encased in a bony shell, found in various habitats from land to sea", answer: "Turtle" }
];

const SPORTS_QUESTIONS = [
  { clue: "⚽🥅", hint: "A team sport played with a spherical ball between two teams of 11 players; the objective is to score by getting the ball into the opposing goal", answer: "Soccer (Football)" },
  { clue: "🏀⛹️‍♂️", hint: "A team sport in which two teams, most commonly of five players each, opposing one another on a rectangular court, compete with the primary objective of shooting a basketball through the opponent's hoop", answer: "Basketball" },
  { clue: "🏈🏟️", hint: "A team sport played by two teams of eleven players on a rectangular field with goalposts at each end; the offensive team attempts to advance an oval ball down the field", answer: "American Football" },
  { clue: "⚾🧤", hint: "A bat-and-ball game played between two opposing teams who take turns batting and fielding, with the objective of scoring runs by hitting a pitched ball and advancing around a series of bases", answer: "Baseball" },
  { clue: "🎾 court", hint: "A racket sport played between two players or two teams of two players on a rectangular court divided by a net, where players use a racket to hit a ball over the net", answer: "Tennis" },
  { clue: "🏊‍♂️🌊", hint: "The activity of propelling oneself through water using the limbs, either as a sport, recreation, or survival skill", answer: "Swimming" },
  { clue: "🏃‍♂️💨", hint: "A group of sports that involve competitive running, jumping, throwing, and walking, often held on a track and field stadium", answer: "Track and Field" },
  { clue: "🥊👊", hint: "A combat sport in which two people, usually wearing protective gloves, throw punches at each other for a predetermined amount of time in a boxing ring", answer: "Boxing" },
  { clue: "⛳🏌️‍♂️", hint: "A club-and-ball sport in which players use various clubs to hit a small ball into a series of holes on a course in as few strokes as possible", answer: "Golf" },
  { clue: "🏏 wicket", hint: "A bat-and-ball game played between two teams of eleven players on an oval field, with a wicket at each end; popular in countries like India, Australia, and England", answer: "Cricket" },
  { clue: "🥋🥋", hint: "A combat sport and martial art originating from Japan, focusing on throws, grappling, and joint locks", answer: "Judo" },
  { clue: "⛸️❄️", hint: "A winter sport where individuals or pairs perform spins, jumps, and intricate footwork on ice", answer: "Figure Skating" },
  { clue: "🚲🚴‍♀️", hint: "A sport involving riding bicycles, either competitively on roads, tracks, or off-road trails", answer: "Cycling" },
  { clue: "🏹🎯", hint: "The sport, practice, or skill of shooting with a bow and arrows", answer: "Archery" },
  { clue: "⛷️🏔️", hint: "A winter sport involving gliding over snow on skis, either recreationally or competitively", answer: "Skiing" },
  { clue: "🚣‍♂️🌊", hint: "The activity of propelling a boat using oars or paddles, either for sport or recreation", answer: "Rowing" },
  { clue: "🤺🤺", hint: "The sport of fighting with swords (foil, épée, or sabre), conducted according to a set of rules", answer: "Fencing" },
  { clue: "🏐🏐", hint: "A team sport in which two teams of six players are separated by a net, with the objective of grounding a ball on the opposing side's court", answer: "Volleyball" },
  { clue: "🏓🏓", hint: "A racket sport played by two or four players hitting a lightweight ball back and forth across a table divided by a net", answer: "Table Tennis (Ping Pong)" },
  { clue: "🤸‍♀️🤸‍♂️", hint: "A sport involving the performance of exercises requiring physical strength, flexibility, agility, coordination, and balance", answer: "Gymnastics" }
];

// New categories for history and books
const HISTORY_QUESTIONS = [
    { clue: "👑🇬🇧⚔️", hint: "A famous English king who signed the Magna Carta and was involved in the Crusades", answer: "King John" },
    { clue: "🗽📜", hint: "The primary author of the Declaration of Independence and third U.S. President", answer: "Thomas Jefferson" },
    { clue: "🚂💨", hint: "The invention that revolutionized transportation and industry in the 18th and 19th centuries", answer: "Steam Engine" },
    { clue: "⚔️🛡️🐎", hint: "Medieval warriors, often associated with codes of chivalry and loyalty", answer: "Knights" },
    { clue: "🧱🏛️", hint: "An ancient civilization known for its pyramids, pharaohs, and hieroglyphs", answer: "Ancient Egypt" },
    { clue: "🌑👨‍🚀", hint: "The first person to walk on the moon in 1969", answer: "Neil Armstrong" },
    { clue: "🎨🇮🇹", hint: "A famous Italian Renaissance artist, inventor, and scientist, known for the Mona Lisa", answer: "Leonardo da Vinci" },
    { clue: "🗺️🧭", hint: "A period of European global exploration and colonial expansion from the 15th to 18th centuries", answer: "Age of Discovery" },
    { clue: "🏰🇫🇷", hint: "A famous French queen, known for her extravagant lifestyle and eventual execution during the revolution", answer: "Marie Antoinette" },
    { clue: "💡⚡", hint: "An American inventor and businessman who developed the phonograph, motion picture camera, and practical electric light bulb", answer: "Thomas Edison" },
    { clue: "🏛️🏛️", hint: "The ancient civilization that gave us democracy, philosophy, and the Olympic Games", answer: "Ancient Greece" },
    { clue: "🧱🛡️", hint: "A fortified wall built across northern Great Britain by the Roman Empire to defend against barbarian tribes", answer: "Hadrian's Wall" },
    { clue: "📜🖋️", hint: "The year the Declaration of Independence was signed, marking American independence", answer: "1776" },
    { clue: "🚢🧊", hint: "The infamous ocean liner that sank on its maiden voyage in 1912 after hitting an iceberg", answer: "Titanic" },
    { clue: "👩‍🔬☢️", hint: "A pioneering female scientist who conducted groundbreaking research on radioactivity and won two Nobel Prizes", answer: "Marie Curie" },
    { clue: "🔫💥", hint: "The assassination of Archduke Franz Ferdinand sparked the beginning of this global conflict", answer: "World War I" },
    { clue: "👨‍🚀🚀", hint: "The space race between the USA and USSR saw the first human enter orbit; who was it?", answer: "Yuri Gagarin" },
    { clue: "🎭🇬🇷", hint: "Ancient Greek playwright known for tragedies like 'Oedipus Rex'", answer: "Sophocles" },
    { clue: "🌉🌉", hint: "The famous battle in London in 1066 that reshaped English history", answer: "Battle of Hastings" },
    { clue: "🌍🌐", hint: "The historical event of 1492 that marked the arrival of Europeans in the Americas", answer: "Columbus's Voyage" }
];

const GENERAL_BOOKS_QUESTIONS = [
    { clue: "🧙‍♂️📖", hint: "A boy wizard discovers a magical world and battles a dark lord", answer: "Harry Potter series" },
    { clue: "🌳🕰️", hint: "A series about four siblings who discover a magical land through a wardrobe", answer: "The Chronicles of Narnia" },
    { clue: "🐉🔥", hint: "An epic fantasy series about dragons, warring houses, and a quest for power", answer: "A Song of Ice and Fire (Game of Thrones)" },
    { clue: "⛵️🏝️", hint: "The adventures of a sailor shipwrecked on a deserted island for 28 years", answer: "Robinson Crusoe" },
    { clue: "🕰️🕰️", hint: "A classic dystopian novel depicting a totalitarian society where 'Big Brother' is always watching", answer: "Nineteen Eighty-Four" },
    { clue: "🕵️‍♂️🎩", hint: "A famous consulting detective known for his brilliant deductions and living at 221B Baker Street", answer: "Sherlock Holmes series" },
    { clue: "🚀🌌", hint: "A science fiction epic about a spice planet and political intrigue across the galaxy", answer: "Dune" },
    { clue: "👻🔔", hint: "A classic novella about a curmudgeonly miser visited by four spirits on Christmas Eve", answer: "A Christmas Carol" },
    { clue: "🧛‍♂️⚰️", hint: "An epistolary novel about a vampire's attempt to move from Transylvania to England and a small group's attempt to stop him", answer: "Dracula" },
    { clue: "🎩🐇", hint: "A girl falls down a rabbit hole into a fantastical world populated by peculiar creatures", answer: "Alice in Wonderland" },
    { clue: "👧🍎", hint: "A classic children's story about a young orphan girl with red hair and a vivid imagination", answer: "Anne of Green Gables" },
    { clue: "💰🐳", hint: "The obsessive quest of Captain Ahab to hunt a white whale", answer: "Moby Dick" },
    { clue: "🐸👦", hint: "A young prince encounters a stranded aviator and shares his profound observations on life and humanity", answer: "The Little Prince" },
    { clue: "🚢🏝️", hint: "A group of British schoolboys are stranded on an uninhabited island and attempt to govern themselves", answer: "Lord of the Flies" },
    { clue: "👽 invading", hint: "A classic science fiction novel about an alien invasion of Earth from Mars", answer: "The War of the Worlds" },
    { clue: "💊🔴🔵", hint: "A philosophical journey into identity and reality within a simulated world", answer: "The Matrix (though primarily a film, it's inspired by philosophy)" },
    { clue: "🐛🍎", hint: "A very hungry creature eats its way through many foods before transforming into a butterfly", answer: "The Very Hungry Caterpillar" },
    { clue: "⚖️🇺🇸", hint: "A novel set in the American South during the Great Depression, dealing with racial injustice and moral growth", answer: "To Kill a Mockingbird" },
    { clue: "🦊🌾", hint: "A classic children's novel about the friendship between a pig and a spider", answer: "Charlotte's Web" },
    { clue: "📚✨", hint: "A young girl uses her love of reading to escape a difficult home life and finds a magical way to interact with stories", answer: "Matilda" }
];

/* =========================
   CATEGORY STRUCTURE
   ========================= */
const ALL_CATEGORIES = {
  'christian': {
    name: 'Christian / Bible',
    subcategories: {
      'books': { name: '📖 Guess the Book of the Bible', questions: BOOKS_QUESTIONS },
      'characters': { name: '👤 Guess the Bible Character', questions: CHARACTER_QUESTIONS }
    }
  },
  'tech': {
    name: 'Tech',
    subcategories: {
      'tech-terms': { name: '💻 Guess the Tech Term', questions: TECH_QUESTIONS }
    }
  },
  'geography': {
    name: 'Geography',
    subcategories: {
      'countries': { name: '🌍 Guess the Country', questions: COUNTRY_QUESTIONS }
    }
  },
  'popculture': {
    name: 'Pop Culture',
    subcategories: {
      'popculture-general': { name: '🌟 Guess the Pop Culture', questions: POPCULTURE_QUESTIONS }
    }
  },
  'food': {
    name: 'Food & Drink',
    subcategories: {
      'food-general': { name: '🍔 Guess the Food', questions: FOOD_QUESTIONS }
    }
  },
  'movies': {
    name: 'Movies',
    subcategories: {
      'movie-titles': { name: '🎬 Guess the Movie Title', questions: MOVIE_QUESTIONS }
    }
  },
  'animals': {
    name: 'Animals',
    subcategories: {
      'animal-names': { name: '🐾 Guess the Animal', questions: ANIMAL_QUESTIONS }
    }
  },
  'sports': {
    name: 'Sports',
    subcategories: {
      'sport-names': { name: '🏅 Guess the Sport', questions: SPORTS_QUESTIONS }
    }
  },
  'history': {
    name: 'History',
    subcategories: {
      'history-general': { name: '📜 Guess the History Fact', questions: HISTORY_QUESTIONS }
    }
  },
  'books': { // Renamed from 'general-books' to simply 'books' for clarity in the top level dropdown
    name: 'Books',
    subcategories: {
      'general-books-titles': { name: '📚 Guess the Book Title', questions: GENERAL_BOOKS_QUESTIONS }
    }
  }
};


/* =========================
   PERSISTENCE & STATE
   ========================= */
const STORAGE_KEY = 'bible_quiz_player_rounds_v1';
function saveState(s){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }catch(e){console.warn('save failed',e);} }
function loadState(){ try{ const r=localStorage.getItem(STORAGE_KEY); return r?JSON.parse(r):null; }catch(e){return null;} }
function clearState(){ localStorage.removeItem(STORAGE_KEY); }

let state = {
  phase: 'setup',           // 'setup' | 'playing' | 'score'
  players: [],
  scores: {},
  deck: [],                 // remaining questions in category
  usedCountThisPlayer: 0,   // how many asked for current player
  questionsPerPlayer: 6,
  currentPlayerIndex: 0,
  currentQuestion: null,
  countdown: 0,
  mainCategory: 'christian', // New: stores the main category key
  subCategory: 'books',     // New: stores the sub-category key
  timeBeforeHint: 5,
  timeAfterHint: 5
};

const namesInput = document.getElementById('namesInput');
const loadPlayersBtn = document.getElementById('loadPlayersBtn');
const resetNamesBtn = document.getElementById('resetNamesBtn');
const playersList = document.getElementById('playersList');
const numQuestionsInput = document.getElementById('numQuestions');
const startBtn = document.getElementById('startBtn');
const resumeBtn = document.getElementById('resumeBtn');
const mainCategorySelect = document.getElementById('mainCategorySelect'); // Changed ID
const subCategorySelect = document.getElementById('subCategorySelect'); // New element
const timeBeforeHintInput = document.getElementById('timeBeforeHint');
const timeAfterHintInput = document.getElementById('timeAfterHint');
const clearStorageBtn = document.getElementById('clearStorageBtn');
const gameInner = document.getElementById('gameInner');

const tickSound = document.getElementById('tickSound');
const revealSound = document.getElementById('revealSound');
const endSound = document.getElementById('endSound');

let tickInterval = null;

/* =========================
   UTILITIES
   ========================= */
function shuffle(arr){ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
// Function to select the correct question deck based on category and sub-category
function cloneDeckForCategory(mainCatKey, subCatKey){
  const mainCat = ALL_CATEGORIES[mainCatKey];
  if (mainCat && mainCat.subcategories[subCatKey]) {
    return mainCat.subcategories[subCatKey].questions.map(q=>({...q}));
  }
  // Fallback to default if category or subcategory is not found
  return ALL_CATEGORIES['christian'].subcategories['books'].questions.map(q=>({...q}));
}
function persist(){ saveState(state); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }

/* =========================
   PLAYERS & DRAG DROP
   ========================= */
function renderPlayers(){
  playersList.innerHTML = '';
  state.players.forEach((name, idx) => {
    const div = document.createElement('div');
    div.className = 'player';
    div.draggable = true;
    div.dataset.index = idx;
    div.innerHTML = `<div class="name">${escapeHtml(name)}</div><div class="handle muted">≡</div>`;
    playersList.appendChild(div);

    div.addEventListener('dragstart', e => {
      div.classList.add('dragging');
      e.dataTransfer.setData('text/plain', idx);
    });
    div.addEventListener('dragend', () => {
      div.classList.remove('dragging');
      // re-sync order
      const items = Array.from(playersList.querySelectorAll('.player'));
      state.players = items.map(it => it.querySelector('.name').textContent.trim());
      // ensure scores exist
      state.scores = state.scores || {};
      state.players.forEach(p => { if(typeof state.scores[p] === 'undefined') state.scores[p] = 0; });
      persist();
      renderPlayers();
    });
  });

  playersList.ondragover = e => {
    e.preventDefault();
    const dragging = playersList.querySelector('.dragging');
    const after = getDragAfterElement(playersList, e.clientY);
    if(!dragging) return;
    if(after == null) playersList.appendChild(dragging);
    else playersList.insertBefore(dragging, after);
  };
}
function getDragAfterElement(container, y){
  const draggable = [...container.querySelectorAll('.player:not(.dragging)')];
  let closest = {offset: Number.NEGATIVE_INFINITY, element: null};
  for(const child of draggable){
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height/2;
    if(offset < 0 && offset > closest.offset) closest = {offset, element: child};
  }
  return closest.element;
}

/* =========================
   CATEGORY SELECTION LOGIC
   ========================= */
function populateMainCategories() {
  mainCategorySelect.innerHTML = '';
  for (const key in ALL_CATEGORIES) {
    const option = document.createElement('option');
    option.value = key;
    option.textContent = ALL_CATEGORIES[key].name;
    mainCategorySelect.appendChild(option);
  }
  // Set initial selection
  mainCategorySelect.value = state.mainCategory;
  populateSubCategories(); // Populate sub-categories based on initial main category
}

function populateSubCategories() {
  subCategorySelect.innerHTML = '';
  const selectedMainCategoryKey = mainCategorySelect.value;
  const subCats = ALL_CATEGORIES[selectedMainCategoryKey]?.subcategories;

  if (subCats) {
    for (const key in subCats) {
      const option = document.createElement('option');
      option.value = key;
      option.textContent = subCats[key].name;
      subCategorySelect.appendChild(option);
    }
  }
  // Set initial selection, or fallback to first available
  if (state.subCategory && subCats && subCats[state.subCategory]) {
      subCategorySelect.value = state.subCategory;
  } else if (subCats) {
      // If the previously selected subCategory isn't in the new main category, select the first one
      const firstSubCatKey = Object.keys(subCats)[0];
      if (firstSubCatKey) {
          subCategorySelect.value = firstSubCatKey;
          state.subCategory = firstSubCatKey; // Update state
      }
  }
}

mainCategorySelect.addEventListener('change', () => {
  state.mainCategory = mainCategorySelect.value;
  populateSubCategories();
  // Update state.subCategory to the newly selected first sub-category (or whatever is default)
  state.subCategory = subCategorySelect.value;
  persist();
});

subCategorySelect.addEventListener('change', () => {
  state.subCategory = subCategorySelect.value;
  persist();
});


/* =========================
   SETUP HANDLERS
   ========================= */
loadPlayersBtn.addEventListener('click', ()=>{
  const raw = namesInput.value.split('\n').map(s=>s.trim()).filter(Boolean);
  if(raw.length === 0){ alert('Add at least one participant.'); return; }
  state.players = raw.slice();
  state.scores = {};
  state.players.forEach(p => state.scores[p] = 0);
  renderPlayers();
  persist();
});
resetNamesBtn.addEventListener('click', ()=>{ namesInput.value = ''; });

startBtn.addEventListener('click', ()=> {
  if(state.players.length === 0){ alert('Load players first (enter names and click Load Players).'); return; }
  const n = parseInt(numQuestionsInput.value) || 0;
  if(n <= 0){ alert('Enter valid number of questions'); return; }
  state.questionsPerPlayer = n;
  state.mainCategory = mainCategorySelect.value; // Store main category
  state.subCategory = subCategorySelect.value;   // Store sub category
  state.timeBeforeHint = Math.max(1, parseInt(timeBeforeHintInput.value) || 5);
  state.timeAfterHint = Math.max(1, parseInt(timeAfterHintInput.value) || 5);
  // build deck (shuffled)
  state.deck = shuffle(cloneDeckForCategory(state.mainCategory, state.subCategory));
  // reset counters for new round
  state.usedCountThisPlayer = 0;
  state.currentPlayerIndex = 0;
  state.scores = {}; state.players.forEach(p => state.scores[p] = 0);
  state.phase = 'playing';
  state.currentQuestion = null;
  state.countdown = 0;
  persist();
  renderGame();
  startPlayerRound(false);
});

resumeBtn.addEventListener('click', ()=> {
  const saved = loadState();
  if(!saved){ alert('No saved game found.'); return; }
  state = Object.assign(state, saved);
  // update inputs
  namesInput.value = state.players.join('\n');
  numQuestionsInput.value = state.questionsPerPlayer || 6;
  timeBeforeHintInput.value = state.timeBeforeHint || 5;
  timeAfterHintInput.value = state.timeAfterHint || 5;

  // Restore main and sub-category selections
  populateMainCategories();
  mainCategorySelect.value = state.mainCategory;
  populateSubCategories();
  subCategorySelect.value = state.subCategory;

  renderPlayers();
  renderGame();
  if(state.phase === 'playing'){
    // resume current tick if user wants; require user gesture to play sounds
    startTick();
  }
});

clearStorageBtn.addEventListener('click', ()=> {
  if(!confirm('Clear saved game and return to setup?')) return;
  clearState();
  state = {
    phase:'setup', players:[], scores:{}, deck:[], usedCountThisPlayer:0,
    questionsPerPlayer:6, currentPlayerIndex:0, currentQuestion:null, countdown:0,
    mainCategory:'christian', subCategory:'books', timeBeforeHint:5, timeAfterHint:5
  };
  namesInput.value = '';
  numQuestionsInput.value = 6;
  timeBeforeHintInput.value = 5;
  timeAfterHintInput.value = 5;
  // Reset category selectors
  populateMainCategories(); // This will also populate subcategories
  mainCategorySelect.value = 'christian';
  subCategorySelect.value = 'books';
  renderPlayers();
  renderGame();
});

/* =========================
   RENDER / FLOW
   ========================= */
function renderGame(){
  if(state.phase === 'setup' || !state.players.length){
    gameInner.innerHTML = `<div class="muted">No game running. Configure players and click Start Round.</div>`;
    return;
  }
  if(state.phase === 'playing'){
    const cp = state.players[state.currentPlayerIndex] || '—';
    const qIndex = state.usedCountThisPlayer || 0;

    // Get display name for the selected sub-category
    const currentSubCategoryDisplayName = ALL_CATEGORIES[state.mainCategory]
                                          ?.subcategories[state.subCategory]
                                          ?.name || '❓ Unknown Category';

    gameInner.innerHTML = `
      <div class="game-top">
        <div class="banner">
          <div class="category-badge">${currentSubCategoryDisplayName}</div>
          <div style="margin-top:8px;color:var(--muted)">Player</div>
          <div class="current-player">${escapeHtml(cp)}</div>
        </div>
        <div style="text-align:center">
          <div class="muted">Timer</div>
          <div class="timer" id="timerEl">${state.countdown || (state.timeBeforeHint + state.timeAfterHint)}</div>
        </div>
        <div style="text-align:right">
          <div class="muted">Player Progress</div>
          <div class="progress" id="progressEl">${qIndex} / ${state.questionsPerPlayer}</div>
        </div>
      </div>

      <div class="clue-box fade">
        <div class="clue" id="clueEl">${state.currentQuestion ? escapeHtml(state.currentQuestion.clue) : '—'}</div>
        <div class="hint" id="hintEl">${state.currentQuestion && state.countdown <= state.timeAfterHint ? '💡 ' + escapeHtml(state.currentQuestion.hint) : ''}</div>
        <div class="answer" id="answerEl">${state.currentQuestion && state.countdown <= 0 ? '✅ ' + escapeHtml(state.currentQuestion.answer) : ''}</div>
      </div>

      <div class="controls">
        <button class="btn big" id="gotItBtn">Got It!</button>
        <button class="btn big ghost" id="skipBtn">Skip (no point)</button>
        <button class="btn big ghost" id="endPlayerBtn">End This Player's Turn</button>
      </div>

      <div class="small-muted">Press "Got It!" to award the current player 1 point before reveal. Hint shows after ${state.timeBeforeHint}s, answer after ${state.timeAfterHint}s more.</div>

      <div style="margin-top:14px">
        <div class="muted">Scores</div>
        <div id="scoresList" style="margin-top:8px"></div>
      </div>
    `;
    renderScores();
    document.getElementById('gotItBtn').onclick = claimPoint;
    document.getElementById('skipBtn').onclick = ()=> revealAnswer(true);
    document.getElementById('endPlayerBtn').onclick = ()=> { // finish current player's remaining questions
      // advance to next player
      state.currentPlayerIndex = (state.currentPlayerIndex + 1) % state.players.length;
      state.usedCountThisPlayer = 0;
      state.currentQuestion = null;
      state.countdown = 0;
      // if we've completed all players (i.e., wrapped to 0 and deck exhausted?), we check end condition when asking
      persist();
      // if all players have taken a turn (we'll detect end when all players have played full set) — but to keep simple: start next player's round
      renderGame();
      setTimeout(()=> startPlayerRound(false), 600);
    };
    return;
  }

  if(state.phase === 'score'){
    const rows = state.players.map((p,i)=>`<div class="score-row"><div>${i+1}. ${escapeHtml(p)}</div><div>${state.scores[p]||0}</div></div>`).join('');
    gameInner.innerHTML = `
      <h2 style="margin:6px 0 12px;color:var(--accent)">Round Results</h2>
      ${rows}
      <div style="display:flex;gap:10px;margin-top:12px">
        <button class="btn" id="nextFullRoundBtn">Next Round (same players)</button>
        <button class="btn ghost" id="backSetupBtn">Back to Setup</button>
      </div>
    `;
    document.getElementById('nextFullRoundBtn').onclick = ()=> {
      // start a new full round: new deck, reset player index and scores
      state.deck = shuffle(cloneDeckForCategory(state.mainCategory, state.subCategory));
      state.usedCountThisPlayer = 0;
      state.currentPlayerIndex = 0;
      state.scores = {}; state.players.forEach(p=>state.scores[p]=0);
      state.phase = 'playing'; state.currentQuestion=null; state.countdown=0;
      persist(); renderGame(); startPlayerRound(false);
    };
    document.getElementById('backSetupBtn').onclick = ()=> { state.phase='setup'; persist(); renderGame(); };
    return;
  }
}

/* Render scores */
function renderScores(){
  const box = document.getElementById('scoresList');
  if(!box) return;
  box.innerHTML = state.players.map(p=>`<div class="score-row"><div>${escapeHtml(p)}</div><div>${state.scores[p]||0}</div></div>`).join('');
}

/* =========================
   ROUND / PLAYER / QUESTION FLOW
   ========================= */

/* Start a player's round: they will answer questionsPerPlayer questions */
function startPlayerRound(resume=false){
  // if deck empty, refill
  if(!state.deck || state.deck.length === 0) state.deck = shuffle(cloneDeckForCategory(state.mainCategory, state.subCategory));
  // reset used count for player if not resuming
  if(!resume) state.usedCountThisPlayer = 0;
  // if all players have had their rounds already? We'll detect end when we've cycled through all players and they each finished questionsPerPlayer
  state.phase = 'playing';
  persist();
  // start first question for this player
  startQuestion(resume);
}

/* Start a single question for current player */
function startQuestion(resume=false){
  // If current player already completed their allotment, move to next player or end round
  if(state.usedCountThisPlayer >= state.questionsPerPlayer){
    // move to next player
    state.currentPlayerIndex++;
    state.usedCountThisPlayer = 0;
    // if we've gone past last player => end of full round (show score)
    if(state.currentPlayerIndex >= state.players.length){
      endFullRound();
      return;
    } else {
      persist();
      renderGame();
      // small delay between players
      setTimeout(()=> startPlayerRound(false), 350);
      return;
    }
  }

  // ensure deck has questions
  if(!state.deck || state.deck.length === 0) state.deck = shuffle(cloneDeckForCategory(state.mainCategory, state.subCategory));

  // pick random question from deck and remove
  const idx = Math.floor(Math.random() * state.deck.length);
  state.currentQuestion = state.deck.splice(idx,1)[0];
  state.usedCountThisPlayer = (state.usedCountThisPlayer || 0) + 1;

  // set countdown total
  state.countdown = state.timeBeforeHint + state.timeAfterHint;
  persist();
  renderGame();

  // start tick
  stopTick();
  safePlay(tickSound);
  startTick();
}

function startTick(){
  // interval that updates countdown, shows hint at correct moment and reveals at 0
  stopTick();
  tickInterval = setInterval(()=>{
    state.countdown--;
    const timerEl = document.getElementById('timerEl'); if(timerEl) timerEl.textContent = state.countdown;
    if(state.countdown > 0) safePlay(tickSound);
    if(state.countdown === state.timeAfterHint){
      // show hint
      const hintEl = document.getElementById('hintEl'); if(hintEl && state.currentQuestion) hintEl.textContent = '💡 ' + state.currentQuestion.hint;
      safePlay(revealSound);
    }
    if(state.countdown <= 0){
      revealAnswer(false);
    }
    persist();
  }, 1000);
}
function stopTick(){ if(tickInterval){ clearInterval(tickInterval); tickInterval=null; } }

/* Reveal answer for current question; skipped==true means reveal early with no score */
function revealAnswer(skipped){
  stopTick();
  state.countdown = 0;
  const ansEl = document.getElementById('answerEl');
  if(ansEl && state.currentQuestion) ansEl.textContent = '✅ ' + state.currentQuestion.answer + (skipped ? ' — skipped (no point)' : '');
  safePlay(revealSound); safePlay(endSound);
  // disable immediate interactions (by nulling handlers)
  const got = document.getElementById('gotItBtn'); if(got) got.onclick = null;
  const skip = document.getElementById('skipBtn'); if(skip) skip.onclick = null;

  // after a brief pause, proceed:
  setTimeout(()=>{
    // If this player still has more questions, start next question for same player
    if(state.usedCountThisPlayer < state.questionsPerPlayer){
      persist();
      startQuestion(false);
    } else {
      // player's allotment done -> move to next player
      state.currentPlayerIndex++;
      state.usedCountThisPlayer = 0;
      // if every player has had their turn (index >= players.length) => full round done
      if(state.currentPlayerIndex >= state.players.length){
        endFullRound();
      } else {
        persist();
        renderGame();
        // small delay between players
        setTimeout(()=> startPlayerRound(false), 600);
      }
    }
  }, 900);
}

/* Player presses Got It! to claim point */
function claimPoint(){
  if(!state.currentQuestion || state.countdown <= 0) return;
  const player = state.players[state.currentPlayerIndex];
  state.scores[player] = (state.scores[player] || 0) + 1;
  persist();
  revealAnswer(false);
}

/* End of full round (all players completed their questions) */
function endFullRound(){
  stopTick();
  state.phase = 'score';
  persist();
  renderGame();
}

/* Safe audio play */
function safePlay(audioEl){
  if(!audioEl) return;
  try{ audioEl.currentTime = 0; const p = audioEl.play(); if(p && typeof p.then === 'function') p.catch(()=>{}); }catch(e){}
}

/* =========================
   BOOT: load existing state if present
   ========================= */
(function init(){
  const saved = loadState();
  if(saved){
    state = Object.assign(state, saved);
    // repopulate UI inputs
    namesInput.value = state.players.join('\n');
    numQuestionsInput.value = state.questionsPerPlayer || 6;
    timeBeforeHintInput.value = state.timeBeforeHint || 5;
    timeAfterHintInput.value = state.timeAfterHint || 5;
  } else {
    // Set default categories if no saved state
    state.mainCategory = 'christian';
    state.subCategory = 'books';
  }
  populateMainCategories(); // Populate main category dropdown first
  // No need to explicitly set mainCategorySelect.value here, populateMainCategories sets it from state.mainCategory
  populateSubCategories(); // Then populate sub-categories based on the selected main category
  // No need to explicitly set subCategorySelect.value here, populateSubCategories sets it from state.subCategory
  renderPlayers();
  renderGame();
  // don't auto-start ticks — user must press Resume or Start to re-enable sounds and ticking
})();

</script>
</body>
</html>
�