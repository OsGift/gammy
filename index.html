<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bible Quiz — Player Rounds</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#041026; --bg2:#071734; --card:#081226;
    --accent:#06b6d4; --accent-2:#7c3aed; --muted:#94a3b8;
    --glass:rgba(255,255,255,0.03)
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    background: linear-gradient(180deg,var(--bg1),var(--bg2));
    color:#e6eef6; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px;
  }
  .app{width:100%; max-width:1100px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  h1{margin:0;color:var(--accent);font-size:1.4rem}
  .sub{color:var(--muted);font-size:0.9rem}
  .layout{display:grid;grid-template-columns:360px 1fr;gap:18px}
  @media (max-width:900px){.layout{grid-template-columns:1fr}}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:14px;padding:14px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
  label{display:block;font-weight:600;margin:10px 0 6px;color:#dbeafe}
  textarea,input,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:14px}
  .btn{background:linear-gradient(90deg,var(--accent),#06b6b9);border:none;padding:10px 14px;border-radius:10px;color:#021025;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .players-list{margin-top:10px;padding:10px;border-radius:10px;background:var(--glass);min-height:120px;max-height:260px;overflow:auto}
  .player{display:flex;align-items:center;justify-content:space-between;padding:10px;margin-bottom:8px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.008));cursor:grab}
  .player.dragging{opacity:0.5;transform:scale(0.995)}
  .player .name{font-weight:700}
  .muted{color:var(--muted);font-size:0.9rem}
  /* Game area */
  .game-top{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .banner{display:flex;flex-direction:column}
  .category-badge{background:linear-gradient(90deg,var(--accent-2),var(--accent));padding:8px 12px;border-radius:999px;font-weight:800;color:#021025;display:inline-block}
  .current-player{font-weight:800;font-size:1.1rem;color:#dbeafe}
  .timer{font-weight:900;font-size:1.6rem;color:#ffb020}
  .progress{color:var(--muted);font-size:0.9rem}
  .clue-box{margin-top:18px;border-radius:12px;padding:22px;background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.008));box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);min-height:160px;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center}
  .clue{font-size:3.2rem;letter-spacing:6px}
  .hint{margin-top:12px;font-size:1.05rem;color:#fbbf24}
  .answer{margin-top:8px;font-size:1.05rem;color:#22c55e}
  .controls{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap;justify-content:center}
  .btn.big{padding:12px 20px;font-size:1rem;border-radius:12px}
  .btn.danger{background:linear-gradient(90deg,#ef4444,#f97316);color:white}
  .small-muted{font-size:0.9rem;color:var(--muted);margin-top:8px;text-align:center}
  .score-row{display:flex;justify-content:space-between;padding:12px;border-radius:10px;margin-bottom:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.008))}
  footer{margin-top:12px;color:var(--muted);font-size:0.9rem;text-align:center}
  .fade{animation:fade .28s ease}
  @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  .settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media (max-width:520px){.settings-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Bible Quiz — Player Rounds</h1>
        <div class="sub">Per-player rounds · set times for hint & reveal · persistent</div>
      </div>
      <div>
        <button id="clearStorageBtn" class="btn ghost">New Game (clear save)</button>
      </div>
    </header>

    <main class="layout">
      <!-- LEFT: Setup -->
      <section class="panel" id="setupPanel">
        <label>Participants (one per line)</label>
        <textarea id="namesInput" rows="6" placeholder="Alice
Bob
Chike"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="loadPlayersBtn" class="btn">Load Players</button>
          <button id="resetNamesBtn" class="btn ghost">Clear</button>
        </div>

        <label style="margin-top:12px">Starting Order (drag to reorder)</label>
        <div class="players-list" id="playersList" aria-label="Player order"></div>

        <label style="margin-top:10px">Category</label>
        <select id="categorySelect">
          <option value="books">📖 Guess the Book of the Bible</option>
          <option value="characters">👤 Guess the Bible Character</option>
        </select>

        <label style="margin-top:10px">Number of questions per player</label>
        <input id="numQuestions" type="number" min="1" value="6" />

        <label style="margin-top:10px">Timing (seconds)</label>
        <div class="settings-grid">
          <div>
            <label class="muted" style="font-weight:600">Time before hint</label>
            <input id="timeBeforeHint" type="number" min="1" value="5" />
          </div>
          <div>
            <label class="muted" style="font-weight:600">Time after hint (until reveal)</label>
            <input id="timeAfterHint" type="number" min="1" value="5" />
          </div>
        </div>

        <div style="display:flex;gap:10px;margin-top:12px">
          <button id="startBtn" class="btn">Start Round</button>
          <button id="resumeBtn" class="btn ghost">Resume Saved</button>
        </div>

        <div class="small-muted" style="margin-top:10px">Questions come from the selected category. The deck randomizes per category and won't repeat until exhausted. Refreshing doesn't lose progress.</div>
      </section>

      <!-- RIGHT: Game -->
      <section class="panel" id="gamePanel">
        <div id="gameInner"><div class="muted">No game running. Configure players and start a round.</div></div>
      </section>
    </main>

    <footer>Created for you — sounds enabled after first Start/Resume click.</footer>
  </div>

  <!-- Sounds -->
  <audio id="tickSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
  <audio id="revealSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>
  <audio id="endSound" src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" preload="auto"></audio>

<script>
/* =========================
   QUESTION DATA (same full sets)
   ========================= */
const BOOKS_QUESTIONS = [
  // Emoji Puzzles
  { clue: "🐑🕊️", hint: "Psalms (or Psalm 23 specifically)", answer: "Psalms" },
  { clue: "🌾🍞🍷", hint: "Feeding of 5,000 & Last Supper symbolism", answer: "John / Gospels" },
  { clue: "🔥🏔️📜", hint: "Mountain encounter; law received", answer: "Exodus" },
  { clue: "🐺🧒🔵", hint: "Prophet, childlike faith; Jonah fits", answer: "Jonah" },
  { clue: "🐪💰👑", hint: "Magi, gifts, worship", answer: "Matthew" },
  { clue: "⚖️🧑‍⚖️📜", hint: "Judge, law, righteous leader", answer: "Deuteronomy / Judges" },
  { clue: "🐍🍎🧑‍🤝‍🧑", hint: "Beginnings, the first family's trouble", answer: "Genesis" },
  { clue: "🏹🦌🏃‍♂️", hint: "Young hunter becoming king", answer: "1 Samuel" },
  { clue: "🕯️📖✡️", hint: "Temple, prayer, reform", answer: "Ezra" },
  { clue: "🛶🌊😴", hint: "Storm, rest, rebuke (Jesus sleeping)", answer: "Mark / Gospels" },
  { clue: "🕊️🩸⛪", hint: "Peace, sacrifice, new covenant imagery", answer: "Hebrews" },
  { clue: "🏗️🧱🔔", hint: "Rebuild, call to worship", answer: "Nehemiah" },

  // Cryptic
  { clue: "Short letter by fisherman who saw the resurrected", hint: "1 Peter (or 2 Peter)", answer: "1 Peter" },
  { clue: "Its title means 'hidden' — dreams & fiery faith", hint: "Lion's den", answer: "Daniel" },
  { clue: "Courtroom drama where the innocent are tried", hint: "Patience under trial", answer: "Job" },
  { clue: "'Vanity!' — practical advice for living", hint: "Also called 'The Preacher'", answer: "Ecclesiastes" },
  { clue: "Annals of kings — rise and fall", hint: "1 & 2 Chronicles", answer: "1 & 2 Chronicles" },
  { clue: "Named after a sea creature — lament & deliverance", hint: "Nineveh involved", answer: "Jonah" },
  { clue: "Missionary travel log by physician-historian", hint: "Sequel has shipwrecks", answer: "Luke / Acts" },
  { clue: "Short prophetic flash vs a proud northern city", hint: "Judgment on Nineveh", answer: "Nahum" },
  { clue: "Encouragement letter from prison", hint: "Rejoice always", answer: "Philippians" },
  { clue: "A love poem doubling as allegory", hint: "Also Canticles", answer: "Song of Solomon" },
  { clue: "Oracle about a vineyard; image of judgment", hint: "Major prophet", answer: "Isaiah" },
  { clue: "Starts with genealogy; ends with empty tomb", hint: "Tax-collector's gospel", answer: "Matthew" },

  // Riddles
  { clue: "Opens with creation; many families, one ancestor", hint: "First book", answer: "Genesis" },
  { clue: "Poetry for the heart — songs & laments", hint: "150 chapters", answer: "Psalms" },
  { clue: "Laws and wandering; people's second beginning", hint: "Farewell speeches", answer: "Deuteronomy" },
  { clue: "Short prophet naming 'the day of the Lord'", hint: "3 chapters", answer: "Joel" },
  { clue: "Born of exile; rebuilding walls & worship", hint: "Cupbearer turned builder", answer: "Nehemiah" },
  { clue: "Shepherd becomes king; covenant & temple plans", hint: "Samuel's writings", answer: "1 Samuel / 2 Samuel" },
  { clue: "Logical writer tracing Jesus' teachings", hint: "Physician writer", answer: "Luke" },
  { clue: "Courtroom poem & childless couple rejoicing", hint: "Hannah & deliverance", answer: "Judges / 1 Samuel" },
  { clue: "Visions of beasts, horns & a little scroll", hint: "Apocalyptic seer", answer: "Daniel / Revelation" },
  { clue: "Practical maxims; father's short advice", hint: "Wisdom literature", answer: "Proverbs" },

  // Mini-Scenario
  { clue: "You kneel to wash feet at a last supper. Which book?", hint: "Unique foot-washing scene", answer: "John" },
  { clue: "You're told to build an ark; birds prove dryness", hint: "Rainbow promise", answer: "Genesis" },
  { clue: "A prophet is taken in a whirlwind into heaven", hint: "Fiery chariot", answer: "2 Kings" },
  { clue: "Stone rolled away; angels at the tomb", hint: "Resurrection morning", answer: "Gospels" },
  { clue: "Nehemiah planning a city wall — which book?", hint: "Post-exile restoration", answer: "Nehemiah" },
  { clue: "Love letters in an ancient courtship song", hint: "Romantic allegory", answer: "Song of Solomon" },
  { clue: "Valley of dry bones becomes warriors", hint: "Prophet in exile", answer: "Ezekiel" },
  { clue: "A meek tax collector climbs a tree", hint: "Zacchaeus story", answer: "Luke" },
  { clue: "A virgin told she'll bear a son: 'God with us'", hint: "Nativity prophecy", answer: "Matthew / Luke" },
  { clue: "A prophet survives a den of predators", hint: "Royal decree gone wrong", answer: "Daniel" }
];

const CHARACTER_QUESTIONS = [
  { clue: "👨‍🌾🍎", hint: "First man in Eden", answer: "Adam" },
  { clue: "👩‍🌾🍎", hint: "First woman in Eden", answer: "Eve" },
  { clue: "🌧️🕊️🌈", hint: "Built an ark; rainbow promise", answer: "Noah" },
  { clue: "🔥⭐→descendants", hint: "Father of many nations; covenant with God", answer: "Abraham" },
  { clue: "👵➡️🎯 (barrenness then laughter)", hint: "Wife of Abraham who laughed at promise", answer: "Sarah" },
  { clue: "🥖🥩→sacrifice", hint: "Son of Abraham who carries wood for a sacrifice", answer: "Isaac" },
  { clue: "🧵👔🛌→dreams", hint: "Sold by brothers, later in Egypt interpreting dreams", answer: "Joseph" },
  { clue: "🔥🌊→leader", hint: "Led Israelites out of Egypt, parted the sea", answer: "Moses" },
  { clue: "👨‍⚖️📜→priest", hint: "Aaron was the first high priest", answer: "Aaron" },
  { clue: "🗡️🏹→judge & judge-slayer", hint: "Israelite judge known for long hair and great strength", answer: "Samson" },
  { clue: "🛡️👑→first king", hint: "Anointed as Israel's first king", answer: "Saul" },
  { clue: "🏹🎵👑", hint: "Shepherd, harp player, became king after Saul", answer: "David" },
  { clue: "🕊️⚖️👑", hint: "Wisdom, builder of the Temple, very wealthy king", answer: "Solomon" },
  { clue: "🔥🚒—hid in cave", hint: "Challenged prophets of Baal; taken up in whirlwind", answer: "Elijah" },
  { clue: "🧑‍⚕️✍️→historian", hint: "Wrote Gospel and Acts; a physician", answer: "Luke" },
  { clue: "🌊🐳 (swallowed)", hint: "Prophet swallowed by a great fish", answer: "Jonah" },
  { clue: "👰→queen (saved people)", hint: "Clever queen who saved her people in Persia", answer: "Esther" },
  { clue: "👩‍🌾➡️loyal", hint: "Moabite who stayed with Naomi", answer: "Ruth" },
  { clue: "✝️—teacher, miracles", hint: "Central figure of the New Testament", answer: "Jesus" },
  { clue: "🚶‍♂️👣—denied, restored", hint: "Fisherman who denied Jesus three times, later restored", answer: "Peter" },
  { clue: "📜✍️→missionary", hint: "Persecutor turned apostle to the Gentiles", answer: "Paul" },
  { clue: "🧔🔔—forerunner", hint: "Baptized Jesus and called people to repentance", answer: "John the Baptist" },
  { clue: "🪢🏙️—faithful spy", hint: "Rahab, the Canaanite who hid Israelite spies", answer: "Rahab" },
  { clue: "🎻🎼(psalms)", hint: "Wrote many psalms, king of Israel", answer: "David" },
  { clue: "🪓🏛️→rebuild", hint: "Cupbearer who rebuilt Jerusalem's wall", answer: "Nehemiah" },
  { clue: "👵➡️son miracle", hint: "Hannah prayed and bore Samuel", answer: "Hannah" },
  { clue: "⚖️⚔️→judge", hint: "Prophet and judge who anointed David", answer: "Samuel" },
  { clue: "🧱→wisdom writer", hint: "Wrote Proverbs, son of David", answer: "Solomon" },
  { clue: "🕶️➡️vision (apostle)", hint: "Beloved disciple, wrote Gospel and Revelation", answer: "John (the Apostle)" },
  { clue: "🧾➡️tax collector", hint: "Climbed a tree to see Jesus", answer: "Zacchaeus" },
  { clue: "👑➡️wise woman", hint: "Abigail — offered wise counsel", answer: "Abigail" },
  { clue: "🇮🇱→messenger (prophet)", hint: "Weeping prophet from Jerusalem", answer: "Jeremiah" },
  { clue: "📜→visions of dry bones", hint: "Saw the valley of dry bones", answer: "Ezekiel" }
];

/* =========================
   PERSISTENCE & STATE
   ========================= */
const STORAGE_KEY = 'bible_quiz_player_rounds_v1';
function saveState(s){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }catch(e){console.warn('save failed',e);} }
function loadState(){ try{ const r=localStorage.getItem(STORAGE_KEY); return r?JSON.parse(r):null; }catch(e){return null;} }
function clearState(){ localStorage.removeItem(STORAGE_KEY); }

let state = {
  phase: 'setup',           // 'setup' | 'playing' | 'score'
  players: [],
  scores: {},
  deck: [],                 // remaining questions in category
  usedCountThisPlayer: 0,   // how many asked for current player
  questionsPerPlayer: 6,
  currentPlayerIndex: 0,
  currentQuestion: null,
  countdown: 0,
  category: 'books',
  timeBeforeHint: 5,
  timeAfterHint: 5
};

const namesInput = document.getElementById('namesInput');
const loadPlayersBtn = document.getElementById('loadPlayersBtn');
const resetNamesBtn = document.getElementById('resetNamesBtn');
const playersList = document.getElementById('playersList');
const numQuestionsInput = document.getElementById('numQuestions');
const startBtn = document.getElementById('startBtn');
const resumeBtn = document.getElementById('resumeBtn');
const categorySelect = document.getElementById('categorySelect');
const timeBeforeHintInput = document.getElementById('timeBeforeHint');
const timeAfterHintInput = document.getElementById('timeAfterHint');
const clearStorageBtn = document.getElementById('clearStorageBtn');
const gameInner = document.getElementById('gameInner');

const tickSound = document.getElementById('tickSound');
const revealSound = document.getElementById('revealSound');
const endSound = document.getElementById('endSound');

let tickInterval = null;

/* =========================
   UTILITIES
   ========================= */
function shuffle(arr){ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
function cloneDeckForCategory(cat){ return (cat==='books' ? BOOKS_QUESTIONS : CHARACTER_QUESTIONS).map(q=>({...q})); }
function persist(){ saveState(state); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }

/* =========================
   PLAYERS & DRAG DROP
   ========================= */
function renderPlayers(){
  playersList.innerHTML = '';
  state.players.forEach((name, idx) => {
    const div = document.createElement('div');
    div.className = 'player';
    div.draggable = true;
    div.dataset.index = idx;
    div.innerHTML = `<div class="name">${escapeHtml(name)}</div><div class="handle muted">≡</div>`;
    playersList.appendChild(div);

    div.addEventListener('dragstart', e => {
      div.classList.add('dragging');
      e.dataTransfer.setData('text/plain', idx);
    });
    div.addEventListener('dragend', () => {
      div.classList.remove('dragging');
      // re-sync order
      const items = Array.from(playersList.querySelectorAll('.player'));
      state.players = items.map(it => it.querySelector('.name').textContent.trim());
      // ensure scores exist
      state.scores = state.scores || {};
      state.players.forEach(p => { if(typeof state.scores[p] === 'undefined') state.scores[p] = 0; });
      persist();
      renderPlayers();
    });
  });

  playersList.ondragover = e => {
    e.preventDefault();
    const dragging = playersList.querySelector('.dragging');
    const after = getDragAfterElement(playersList, e.clientY);
    if(!dragging) return;
    if(after == null) playersList.appendChild(dragging);
    else playersList.insertBefore(dragging, after);
  };
}
function getDragAfterElement(container, y){
  const draggable = [...container.querySelectorAll('.player:not(.dragging)')];
  let closest = {offset: Number.NEGATIVE_INFINITY, element: null};
  for(const child of draggable){
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height/2;
    if(offset < 0 && offset > closest.offset) closest = {offset, element: child};
  }
  return closest.element;
}

/* =========================
   SETUP HANDLERS
   ========================= */
loadPlayersBtn.addEventListener('click', ()=>{
  const raw = namesInput.value.split('\n').map(s=>s.trim()).filter(Boolean);
  if(raw.length === 0){ alert('Add at least one participant.'); return; }
  state.players = raw.slice();
  state.scores = {};
  state.players.forEach(p => state.scores[p] = 0);
  renderPlayers();
  persist();
});
resetNamesBtn.addEventListener('click', ()=>{ namesInput.value = ''; });

startBtn.addEventListener('click', ()=> {
  if(state.players.length === 0){ alert('Load players first (enter names and click Load Players).'); return; }
  const n = parseInt(numQuestionsInput.value) || 0;
  if(n <= 0){ alert('Enter valid number of questions'); return; }
  state.questionsPerPlayer = n;
  state.category = categorySelect.value;
  state.timeBeforeHint = Math.max(1, parseInt(timeBeforeHintInput.value) || 5);
  state.timeAfterHint = Math.max(1, parseInt(timeAfterHintInput.value) || 5);
  // build deck (shuffled)
  state.deck = shuffle(cloneDeckForCategory(state.category));
  // reset counters for new round
  state.usedCountThisPlayer = 0;
  state.currentPlayerIndex = 0;
  state.scores = {}; state.players.forEach(p => state.scores[p] = 0);
  state.phase = 'playing';
  state.currentQuestion = null;
  state.countdown = 0;
  persist();
  renderGame();
  startPlayerRound(false);
});

resumeBtn.addEventListener('click', ()=> {
  const saved = loadState();
  if(!saved){ alert('No saved game found.'); return; }
  state = Object.assign(state, saved);
  // update inputs
  namesInput.value = state.players.join('\n');
  categorySelect.value = state.category || 'books';
  numQuestionsInput.value = state.questionsPerPlayer || 6;
  timeBeforeHintInput.value = state.timeBeforeHint || 5;
  timeAfterHintInput.value = state.timeAfterHint || 5;
  renderPlayers();
  renderGame();
  if(state.phase === 'playing'){
    // resume current tick if user wants; require user gesture to play sounds
    startTick();
  }
});

clearStorageBtn.addEventListener('click', ()=> {
  if(!confirm('Clear saved game and return to setup?')) return;
  clearState();
  state = {
    phase:'setup', players:[], scores:{}, deck:[], usedCountThisPlayer:0,
    questionsPerPlayer:6, currentPlayerIndex:0, currentQuestion:null, countdown:0,
    category:'books', timeBeforeHint:5, timeAfterHint:5
  };
  namesInput.value = '';
  numQuestionsInput.value = 6;
  timeBeforeHintInput.value = 5;
  timeAfterHintInput.value = 5;
  renderPlayers();
  renderGame();
});

/* =========================
   RENDER / FLOW
   ========================= */
function renderGame(){
  if(state.phase === 'setup' || !state.players.length){
    gameInner.innerHTML = `<div class="muted">No game running. Configure players and click Start Round.</div>`;
    return;
  }
  if(state.phase === 'playing'){
    const cp = state.players[state.currentPlayerIndex] || '—';
    const qIndex = state.usedCountThisPlayer || 0;
    gameInner.innerHTML = `
      <div class="game-top">
        <div class="banner">
          <div class="category-badge">${state.category === 'books' ? '📖 Guess the Book' : '👤 Guess the Character'}</div>
          <div style="margin-top:8px;color:var(--muted)">Player</div>
          <div class="current-player">${escapeHtml(cp)}</div>
        </div>
        <div style="text-align:center">
          <div class="muted">Timer</div>
          <div class="timer" id="timerEl">${state.countdown || (state.timeBeforeHint + state.timeAfterHint)}</div>
        </div>
        <div style="text-align:right">
          <div class="muted">Player Progress</div>
          <div class="progress" id="progressEl">${qIndex} / ${state.questionsPerPlayer}</div>
        </div>
      </div>

      <div class="clue-box fade">
        <div class="clue" id="clueEl">${state.currentQuestion ? escapeHtml(state.currentQuestion.clue) : '—'}</div>
        <div class="hint" id="hintEl">${state.currentQuestion && state.countdown <= state.timeAfterHint ? '💡 ' + escapeHtml(state.currentQuestion.hint) : ''}</div>
        <div class="answer" id="answerEl">${state.currentQuestion && state.countdown <= 0 ? '✅ ' + escapeHtml(state.currentQuestion.answer) : ''}</div>
      </div>

      <div class="controls">
        <button class="btn big" id="gotItBtn">Got It!</button>
        <button class="btn big ghost" id="skipBtn">Skip (no point)</button>
        <button class="btn big ghost" id="endPlayerBtn">End This Player's Turn</button>
      </div>

      <div class="small-muted">Press "Got It!" to award the current player 1 point before reveal. Hint shows after ${state.timeBeforeHint}s, answer after ${state.timeAfterHint}s more.</div>

      <div style="margin-top:14px">
        <div class="muted">Scores</div>
        <div id="scoresList" style="margin-top:8px"></div>
      </div>
    `;
    renderScores();
    document.getElementById('gotItBtn').onclick = claimPoint;
    document.getElementById('skipBtn').onclick = ()=> revealAnswer(true);
    document.getElementById('endPlayerBtn').onclick = ()=> { // finish current player's remaining questions
      // advance to next player
      state.currentPlayerIndex = (state.currentPlayerIndex + 1) % state.players.length;
      state.usedCountThisPlayer = 0;
      state.currentQuestion = null;
      state.countdown = 0;
      // if we've completed all players (i.e., wrapped to 0 and deck exhausted?), we check end condition when asking
      persist();
      // if all players have taken a turn (we'll detect end when all players have played full set) — but to keep simple: start next player's round
      renderGame();
      startPlayerRound(false);
    };
    return;
  }

  if(state.phase === 'score'){
    const rows = state.players.map((p,i)=>`<div class="score-row"><div>${i+1}. ${escapeHtml(p)}</div><div>${state.scores[p]||0}</div></div>`).join('');
    gameInner.innerHTML = `
      <h2 style="margin:6px 0 12px;color:var(--accent)">Round Results</h2>
      ${rows}
      <div style="display:flex;gap:10px;margin-top:12px">
        <button class="btn" id="nextFullRoundBtn">Next Round (same players)</button>
        <button class="btn ghost" id="backSetupBtn">Back to Setup</button>
      </div>
    `;
    document.getElementById('nextFullRoundBtn').onclick = ()=> {
      // start a new full round: new deck, reset player index and scores
      state.deck = shuffle(cloneDeckForCategory(state.category));
      state.usedCountThisPlayer = 0;
      state.currentPlayerIndex = 0;
      state.scores = {}; state.players.forEach(p=>state.scores[p]=0);
      state.phase = 'playing'; state.currentQuestion=null; state.countdown=0;
      persist(); renderGame(); startPlayerRound(false);
    };
    document.getElementById('backSetupBtn').onclick = ()=> { state.phase='setup'; persist(); renderGame(); };
    return;
  }
}

/* Render scores */
function renderScores(){
  const box = document.getElementById('scoresList');
  if(!box) return;
  box.innerHTML = state.players.map(p=>`<div class="score-row"><div>${escapeHtml(p)}</div><div>${state.scores[p]||0}</div></div>`).join('');
}

/* =========================
   ROUND / PLAYER / QUESTION FLOW
   ========================= */

/* Start a player's round: they will answer questionsPerPlayer questions */
function startPlayerRound(resume=false){
  // if deck empty, refill
  if(!state.deck || state.deck.length === 0) state.deck = shuffle(cloneDeckForCategory(state.category));
  // reset used count for player if not resuming
  if(!resume) state.usedCountThisPlayer = 0;
  // if all players have had their rounds already? We'll detect end when we've cycled through all players and they each finished questionsPerPlayer
  state.phase = 'playing';
  persist();
  // start first question for this player
  startQuestion(resume);
}

/* Start a single question for current player */
function startQuestion(resume=false){
  // If current player already completed their allotment, move to next player or end round
  if(state.usedCountThisPlayer >= state.questionsPerPlayer){
    // move to next player
    state.currentPlayerIndex++;
    state.usedCountThisPlayer = 0;
    // if we've gone past last player => end of full round (show score)
    if(state.currentPlayerIndex >= state.players.length){
      endFullRound();
      return;
    } else {
      persist();
      renderGame();
      // start next player's round
      setTimeout(()=> startPlayerRound(false), 350);
      return;
    }
  }

  // ensure deck has questions
  if(!state.deck || state.deck.length === 0) state.deck = shuffle(cloneDeckForCategory(state.category));

  // pick random question from deck and remove
  const idx = Math.floor(Math.random() * state.deck.length);
  state.currentQuestion = state.deck.splice(idx,1)[0];
  state.usedCountThisPlayer = (state.usedCountThisPlayer || 0) + 1;

  // set countdown total
  state.countdown = state.timeBeforeHint + state.timeAfterHint;
  persist();
  renderGame();

  // start tick
  stopTick();
  safePlay(tickSound);
  startTick();
}

function startTick(){
  // interval that updates countdown, shows hint at correct moment and reveals at 0
  stopTick();
  tickInterval = setInterval(()=>{
    state.countdown--;
    const timerEl = document.getElementById('timerEl'); if(timerEl) timerEl.textContent = state.countdown;
    if(state.countdown > 0) safePlay(tickSound);
    if(state.countdown === state.timeAfterHint){
      // show hint
      const hintEl = document.getElementById('hintEl'); if(hintEl && state.currentQuestion) hintEl.textContent = '💡 ' + state.currentQuestion.hint;
      safePlay(revealSound);
    }
    if(state.countdown <= 0){
      revealAnswer(false);
    }
    persist();
  }, 1000);
}
function stopTick(){ if(tickInterval){ clearInterval(tickInterval); tickInterval=null; } }

/* Reveal answer for current question; skipped==true means reveal early with no score */
function revealAnswer(skipped){
  stopTick();
  state.countdown = 0;
  const ansEl = document.getElementById('answerEl');
  if(ansEl && state.currentQuestion) ansEl.textContent = '✅ ' + state.currentQuestion.answer + (skipped ? ' — skipped (no point)' : '');
  safePlay(revealSound); safePlay(endSound);
  // disable immediate interactions (by nulling handlers)
  const got = document.getElementById('gotItBtn'); if(got) got.onclick = null;
  const skip = document.getElementById('skipBtn'); if(skip) skip.onclick = null;

  // after a brief pause, proceed:
  setTimeout(()=>{
    // If this player still has more questions, start next question for same player
    if(state.usedCountThisPlayer < state.questionsPerPlayer){
      persist();
      startQuestion(false);
    } else {
      // player's allotment done -> move to next player
      state.currentPlayerIndex++;
      state.usedCountThisPlayer = 0;
      // if every player has had their turn (index >= players.length) => full round done
      if(state.currentPlayerIndex >= state.players.length){
        endFullRound();
      } else {
        persist();
        renderGame();
        // small delay between players
        setTimeout(()=> startPlayerRound(false), 600);
      }
    }
  }, 900);
}

/* Player presses Got It! to claim point */
function claimPoint(){
  if(!state.currentQuestion || state.countdown <= 0) return;
  const player = state.players[state.currentPlayerIndex];
  state.scores[player] = (state.scores[player] || 0) + 1;
  persist();
  revealAnswer(false);
}

/* End of full round (all players completed their questions) */
function endFullRound(){
  stopTick();
  state.phase = 'score';
  persist();
  renderGame();
}

/* Safe audio play */
function safePlay(audioEl){
  if(!audioEl) return;
  try{ audioEl.currentTime = 0; const p = audioEl.play(); if(p && typeof p.then === 'function') p.catch(()=>{}); }catch(e){}
}

/* =========================
   BOOT: load existing state if present
   ========================= */
(function init(){
  const saved = loadState();
  if(saved){
    state = Object.assign(state, saved);
    // repopulate UI inputs
    namesInput.value = state.players.join('\n');
    categorySelect.value = state.category || 'books';
    numQuestionsInput.value = state.questionsPerPlayer || 6;
    timeBeforeHintInput.value = state.timeBeforeHint || 5;
    timeAfterHintInput.value = state.timeAfterHint || 5;
  }
  renderPlayers();
  renderGame();
  // don't auto-start ticks — user must press Resume or Start to re-enable sounds and ticking
})();

</script>
</body>
</html>
