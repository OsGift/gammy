<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Bible Quiz — Player Rounds</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#041026; --bg2:#071734; --card:#081226;
    --accent:#06b6d4; --accent-2:#7c3aed; --muted:#94a3b8;
    --glass:rgba(255,255,255,0.03)
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
    background: linear-gradient(180deg,var(--bg1),var(--bg2));
    color:#e6eef6; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px;
  }
  .app{width:100%; max-width:1100px}
  header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
  h1{margin:0;color:var(--accent);font-size:1.4rem}
  .sub{color:var(--muted);font-size:0.9rem}
  .layout{display:grid;grid-template-columns:360px 1fr;gap:18px}
  @media (max-width:900px){.layout{grid-template-columns:1fr}}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:14px;padding:14px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
  label{display:block;font-weight:600;margin:10px 0 6px;color:#dbeafe}
  textarea,input,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:14px}
  .btn{background:linear-gradient(90deg,var(--accent),#06b6b9);border:none;padding:10px 14px;border-radius:10px;color:#021025;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
  .players-list{margin-top:10px;padding:10px;border-radius:10px;background:var(--glass);min-height:120px;max-height:260px;overflow:auto}
  .player{display:flex;align-items:center;justify-content:space-between;padding:10px;margin-bottom:8px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.008));cursor:grab}
  .player.dragging{opacity:0.5;transform:scale(0.995)}
  .player .name{font-weight:700}
  .muted{color:var(--muted);font-size:0.9rem}
  /* Game area */
  .game-top{display:flex;justify-content:space-between;align-items:center;gap:12px}
  .banner{display:flex;flex-direction:column}
  .category-badge{background:linear-gradient(90deg,var(--accent-2),var(--accent));padding:8px 12px;border-radius:999px;font-weight:800;color:#021025;display:inline-block}
  .current-player{font-weight:800;font-size:1.1rem;color:#dbeafe}
  .timer{font-weight:900;font-size:1.6rem;color:#ffb020}
  .progress{color:var(--muted);font-size:0.9rem}
  .clue-box{margin-top:18px;border-radius:12px;padding:22px;background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.008));box-shadow:inset 0 1px 0 rgba(255,255,255,0.02);min-height:160px;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center}
  .clue{font-size:3.2rem;letter-spacing:6px}
  .hint{margin-top:12px;font-size:1.05rem;color:#fbbf24}
  .answer{margin-top:8px;font-size:1.05rem;color:#22c55e}
  .controls{display:flex;gap:10px;margin-top:16px;flex-wrap:wrap;justify-content:center}
  .btn.big{padding:12px 20px;font-size:1rem;border-radius:12px}
  .btn.danger{background:linear-gradient(90deg,#ef4444,#f97316);color:white}
  .small-muted{font-size:0.9rem;color:var(--muted);margin-top:8px;text-align:center}
  .score-row{display:flex;justify-content:space-between;padding:12px;border-radius:10px;margin-bottom:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.008))}
  footer{margin-top:12px;color:var(--muted);font-size:0.9rem;text-align:center}
  .fade{animation:fade .28s ease}
  @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  .settings-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media (max-width:520px){.settings-grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Bible Quiz — Player Rounds</h1>
        <div class="sub">Per-player rounds · set times for hint & reveal · persistent</div>
      </div>
      <div>
        <button id="clearStorageBtn" class="btn ghost">New Game (clear save)</button>
      </div>
    </header>

    <main class="layout">
      <!-- LEFT: Setup -->
      <section class="panel" id="setupPanel">
        <label>Participants (one per line)</label>
        <textarea id="namesInput" rows="6" placeholder="Alice
Bob
Chike"></textarea>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="loadPlayersBtn" class="btn">Load Players</button>
          <button id="resetNamesBtn" class="btn ghost">Clear</button>
        </div>

        <label style="margin-top:12px">Starting Order (drag to reorder)</label>
        <div class="players-list" id="playersList" aria-label="Player order"></div>

        <label style="margin-top:10px">Main Category</label>
        <select id="mainCategorySelect">
        </select>

        <label style="margin-top:10px">Sub-Category</label>
        <select id="subCategorySelect">
        </select>

        <label style="margin-top:10px">Number of questions per player</label>
        <input id="numQuestions" type="number" min="1" value="6" />

        <label style="margin-top:10px">Timing (seconds)</label>
        <div class="settings-grid">
          <div>
            <label class="muted" style="font-weight:600">Time before hint</label>
            <input id="timeBeforeHint" type="number" min="1" value="5" />
          </div>
          <div>
            <label class="muted" style="font-weight:600">Time after hint (until reveal)</label>
            <input id="timeAfterHint" type="number" min="1" value="5" />
          </div>
        </div>

        <div style="display:flex;gap:10px;margin-top:12px">
          <button id="startBtn" class="btn">Start Round</button>
          <button id="resumeBtn" class="btn ghost">Resume Saved</button>
        </div>

        <div class="small-muted" style="margin-top:10px">Questions come from the selected category. The deck randomizes per category and won't repeat until exhausted. Refreshing doesn't lose progress.</div>
      </section>

      <!-- RIGHT: Game -->
      <section class="panel" id="gamePanel">
        <div id="gameInner"><div class="muted">No game running. Configure players and start a round.</div></div>
      </section>
    </main>

    <footer>Created for you — sounds enabled after first Start/Resume click.</footer>
  </div>

  <!-- Sounds -->
  <audio id="tickSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>
  <audio id="revealSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>
  <audio id="endSound" src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" preload="auto"></audio>

<script>
/* =========================
   QUESTION DATA
   ========================= */

// --- REVISED BIBLE QUESTIONS ---
const BOOKS_QUESTIONS = [
  { clue: "🐍🍎➡️🌊", hint: "The book of beginnings, from creation to a family's journey to Egypt.", answer: "Genesis" },
  { clue: "📜🔥➡️🏞️", hint: "A nation's escape from slavery, receiving laws on a fiery mountain.", answer: "Exodus" },
  { clue: "👑🐑🎶", hint: "A collection of 150 sacred songs, many penned by a shepherd king.", answer: "Psalms" },
  { clue: "🤔💨❓", hint: "A philosophical exploration of life's meaning, often concluding 'all is vanity'.", answer: "Ecclesiastes" },
  { clue: "⛵️➡️🐳➡️🗣️", hint: "A reluctant messenger's sea voyage takes a dark turn before he delivers a message of repentance to a great city.", answer: "Jonah" },
  { clue: "🦁🔥📜", hint: "A prophet's visions and faithfulness in a foreign court, from fiery furnaces to dens of predators.", answer: "Daniel" },
  { clue: "🧱💪🏗️", hint: "The story of a cupbearer who returned from exile to lead the rebuilding of Jerusalem's walls.", answer: "Nehemiah" },
  { clue: "🐑➡️👑", hint: "The chronicles of Israel's transition from judges to its first kings, including a shepherd boy's rise.", answer: "1 & 2 Samuel" },
  { clue: "💧➡️🍷👣", hint: "This gospel begins with the Word, details many 'I am' statements, and describes Jesus washing feet.", answer: "John" },
  { clue: "🕊️🔥⛪️", hint: "The historical account of the early church's explosive growth, missionary journeys, and the coming of the Holy Spirit.", answer: "Acts" },
  { clue: "⛓️✉️😄", hint: "An epistle of joy and encouragement, written by Paul from a prison cell.", answer: "Philippians" },
  { clue: "🎺📜🐉", hint: "The final book, filled with apocalyptic visions, seals, trumpets, and a new heaven and earth.", answer: "Revelation" },
  { clue: "愛 ❤️", hint: "A letter famous for its chapter defining love in detail.", answer: "1 Corinthians" },
  { clue: "⚖️💪🦸", hint: "A book detailing the cycle of sin, oppression, and deliverance through charismatic leaders.", answer: "Judges" },
  { clue: "📜🤔🙏", hint: "This book tackles the question of suffering through the story of a righteous man who loses everything.", answer: "Job" },
];

const CHARACTER_QUESTIONS = [
  { clue: "🐑🔪⛰️", hint: "This patriarch's faith was tested when asked to sacrifice his promised son.", answer: "Abraham" },
  { clue: "🌈🧥📉📈", hint: "He went from a favorite son in a colorful coat to a powerful ruler in Egypt.", answer: "Joseph" },
  { clue: "💪💇‍♀️💔", hint: "A judge of Israel whose immense strength had a secret, which he tragically revealed.", answer: "Samson" },
  { clue: "🌾🤝💍", hint: "Her loyalty to her mother-in-law led her from gleaning in fields to the lineage of a king.", answer: "Ruth" },
  { clue: " sling 🗿", hint: "A shepherd boy who defeated a giant with a single stone and later became king.", answer: "David" },
  { clue: "智慧 👶 👑", hint: "A king renowned for his wisdom, famously judging a case between two mothers.", answer: "Solomon" },
  { clue: "🔥 chariot", hint: "A prophet who confronted the prophets of Baal and was taken to heaven without dying.", answer: "Elijah" },
  { clue: "👑 courageous 📿", hint: "A Jewish queen in a foreign land who risked her life to save her people.", answer: "Esther" },
  { clue: "🗣️'REPENT!'🦗", hint: "A prophet who lived in the wilderness, ate locusts, and prepared the way for the Messiah.", answer: "John the Baptist" },
  { clue: " denials 🔥", hint: "A lead apostle who boldly declared Jesus as the Messiah, yet denied him three times.", answer: "Peter" },
  { clue: "🐴➡️💡✉️", hint: "Once a fierce persecutor of the church, he became its greatest missionary after a blinding encounter on the road.", answer: "Paul (Saul)" },
  { clue: " tax 🌳", hint: "A short, wealthy tax collector who climbed a tree to see Jesus and had his life transformed.", answer: "Zacchaeus" },
  { clue: "🐍🗣️", hint: "The first woman, whose choice in a garden had consequences for all of humanity.", answer: "Eve" },
  { clue: "🌊🛶🕊️", hint: "He was chosen to build a massive boat to survive a global flood.", answer: "Noah" },
  { clue: "🔥🗣️🌿", hint: "He was called by God from a burning bush to lead his people out of slavery.", answer: "Moses" },
];

// --- NEW BIBLE SUB-CATEGORIES ---
const BIBLICAL_EVENTS_QUESTIONS = [
    { clue: "🔥🗣️🌿", hint: "A divine call from a shrubbery that wasn't consumed.", answer: "The Burning Bush" },
    { clue: "🌊🚶‍♂️🤝", hint: "An apostle attempts to replicate his master's stroll on the water.", answer: "Peter walking on water" },
    { clue: "🍞🍷👥", hint: "A final meal that established a new covenant.", answer: "The Last Supper" },
    { clue: "🗣️🔥🕊️", hint: "The birth of the church, marked by divine gifts of language.", answer: "Pentecost" },
    { clue: "🧱🗣️🤯", hint: "An ambitious construction project halted by linguistic chaos.", answer: "The Tower of Babel" },
    { clue: "🐴💡➡️🙏", hint: "A persecutor's journey to Damascus is interrupted by a blinding vision.", answer: "Saul's Conversion" },
    { clue: "🦁🌃🙏", hint: "A faithful man is thrown into a den of predators for his unwavering prayer life.", answer: "Daniel in the Lion's Den" },
    { clue: "🌊↔️🚶‍♂️", hint: "A sea parts to create a dry path for a nation's escape.", answer: "The Parting of the Red Sea" },
    { clue: "🎺🧱💥", hint: "City walls crumble after seven days of marching and a trumpet blast.", answer: "The Fall of Jericho" },
    { clue: "✨👼👩", hint: "An angelic visit to a young virgin in Nazareth with world-changing news.", answer: "The Annunciation" }
];

const WHO_SAID_IT_QUESTIONS = [
    { clue: '"Am I my brother\'s keeper?"', hint: "A defiant response to God after the first murder.", answer: "Cain" },
    { clue: '"I am who I am."', hint: "God's own name, revealed from a burning bush.", answer: "God (to Moses)" },
    { clue: '"Let my people go!"', hint: "A demand made to a powerful Pharaoh.", answer: "Moses" },
    { clue: '"As for me and my house, we will serve the Lord."', hint: "A leader's declaration of commitment before the tribes of Israel.", answer: "Joshua" },
    { clue: '"Where you go I will go, and where you stay I will stay."', hint: "A pledge of loyalty from a daughter-in-law to her mother-in-law.", answer: "Ruth" },
    { clue: '"The Lord is my shepherd; I shall not want."', hint: "The opening of a famous psalm of comfort and trust.", answer: "David" },
    { clue: '"Here am I. Send me!"', hint: "A prophet's response when seeing a vision of God in the temple.", answer: "Isaiah" },
    { clue: '"Behold, the Lamb of God, who takes away the sin of the world!"', hint: "The proclamation of the forerunner upon seeing Jesus.", answer: "John the Baptist" },
    { clue: '"You are the Christ, the Son of the living God."', hint: "A pivotal declaration of faith from the lead apostle.", answer: "Peter" },
    { clue: '"I am the way, and the truth, and the life."', hint: "Jesus' own declaration of his divine identity and purpose.", answer: "Jesus" },
    { clue: '"For I am not ashamed of the gospel..."', hint: "An apostle's bold statement in a letter to the Roman church.", answer: "Paul" }
];

const BIBLICAL_PLACES_QUESTIONS = [
    { clue: "🌳🐍🍎", hint: "The location of humanity's first home and first disobedience.", answer: "Garden of Eden" },
    { clue: "⛰️📜🔥", hint: "The mountain where the Ten Commandments were given.", answer: "Mount Sinai" },
    { clue: "🍞🥖🏡", hint: "The 'City of David,' prophesied to be the birthplace of the Messiah.", answer: "Bethlehem" },
    { clue: "🕊️💧🏞️", hint: "The river where Jesus was baptized.", answer: "Jordan River" },
    { clue: "🎣⛵️🌊", hint: "A large freshwater lake where Jesus called his first disciples.", answer: "Sea of Galilee" },
    { clue: "🏛️🙏👑", hint: "The holy city, site of the Temple and capital of ancient Israel.", answer: "Jerusalem" },
    { clue: "🍷💧🎉", hint: "The location of Jesus' first recorded miracle at a wedding.", answer: "Cana" },
    { clue: "🪨🪦➡️", hint: "The site of Jesus' crucifixion, also known as 'the place of the skull'.", answer: "Golgotha (Calvary)" },
    { clue: "🛣️👨‍🦯💡", hint: "The road on which a great persecutor was converted.", answer: "The road to Damascus" },
    { clue: "🏝️📜✍️", hint: "The island where the Apostle John received his apocalyptic vision.", answer: "Patmos" }
];

const PARABLES_AND_MIRACLES_QUESTIONS = [
    { clue: "🌱🪨🛣️", hint: "A story about different types of soil representing different hearts.", answer: "The Parable of the Sower" },
    { clue: "🐑➡️💯", hint: "A shepherd leaves his flock to find one that is lost.", answer: "The Parable of the Lost Sheep" },
    { clue: "🤕 Samaritan", hint: "A story that answers the question, 'Who is my neighbor?'", answer: "The Parable of the Good Samaritan" },
    { clue: "🍇👨‍🌾⏰", hint: "Workers hired at different times of the day all receive the same wage.", answer: "The Parable of the Workers in the Vineyard" },
    { clue: "🐟🍞🥖x5000", hint: "A massive crowd is fed with just a boy's lunch.", answer: "The Feeding of the 5,000" },
    { clue: "💧➡️🍷", hint: "Water is transformed at a wedding feast.", answer: "Turning Water into Wine" },
    { clue: "🌊🚶‍♂️", hint: "Jesus defies gravity on a stormy sea.", answer: "Walking on Water" },
    { clue: "🗣️'GET UP!'🪦", hint: "A man dead for four days is called out of his tomb.", answer: "The Raising of Lazarus" },
    { clue: "👨‍🦯➡️👁️", hint: "A man born without sight is given vision.", answer: "Healing the man born blind" },
    { clue: "🐷🌊", hint: "A legion of demons is cast out and sent into a herd of animals.", answer: "Healing the demon-possessed man (Legion)" }
];


// --- OTHER CATEGORIES (UNCHANGED) ---
const TECH_QUESTIONS = [
  { clue: "☁️💾", hint: "Storing data online rather than on a local device, accessible from anywhere", answer: "Cloud Storage" },
  { clue: "🐍💻", hint: "A versatile and popular programming language often used for web development, data analysis, and AI, named after a British comedy troupe", answer: "Python" },
  { clue: "📱🍎", hint: "Apple's flagship smartphone, renowned for its design and ecosystem", answer: "iPhone" },
  { clue: "�📦", hint: "A platform for developers to build, share, and run applications using lightweight, portable units called containers", answer: "Docker" },
  { clue: "👓🌐", hint: "Wearable technology that overlays digital information onto the real world, enhancing perception", answer: "Smart Glasses" },
  { clue: "⚙️📜", hint: "A sequence of instructions designed to automate repetitive tasks or processes on a computer", answer: "Automation Script" },
  { clue: "🔍🌐", hint: "The world's most widely used search engine, an essential tool for finding information online", answer: "Google" },
  { clue: "🛡️🔑", hint: "A security measure that requires users to provide two different forms of identification before gaining access", answer: "Two-Factor Authentication" },
  { clue: "🧠🤖", hint: "The broad field of computer science focused on creating machines that can perform tasks normally requiring human intelligence", answer: "Artificial Intelligence" },
  { clue: "🌐💻", hint: "A global system of interconnected computer networks that uses standard communication protocols to serve billions of users", answer: "Internet" },
  { clue: "🔗🧱", hint: "A decentralized, distributed ledger technology that underlies cryptocurrencies like Bitcoin", answer: "Blockchain" },
  { clue: "🎮👓", hint: "Technology that creates a simulated environment, immersing the user in a virtual world", answer: "Virtual Reality (VR)" },
];

const COUNTRY_QUESTIONS = [
  { clue: "🗼🍣", hint: "An island nation known for its cherry blossoms, sushi, and ancient traditions", answer: "Japan" },
  { clue: "🦘🏄‍♂️", hint: "A vast continent and country famous for its unique wildlife and surfing beaches", answer: "Australia" },
  { clue: "🍕🍝", hint: "A European country shaped like a boot, famous for its pasta, pizza, and historical sites", answer: "Italy" },
  { clue: "🏰🍺", hint: "Known for its historical castles, beer festivals like Oktoberfest, and engineering", answer: "Germany" },
  { clue: "🕌🐪", hint: "A desert kingdom in the Middle East, home to holy cities of Islam", answer: "Saudi Arabia" },
  { clue: "🍁🏒", hint: "North American country famous for maple syrup and ice hockey", answer: "Canada" },
  { clue: " pyramides 🇪🇬", hint: "Ancient civilization known for its pharaohs and massive desert structures", answer: "Egypt" },
  { clue: "🐘🌶️", hint: "A South Asian country known for its vibrant spices, diverse cultures, and large population", answer: "India" },
  { clue: "🍷🥖", hint: "European country famous for its fine wines, cheeses, and the Eiffel Tower", answer: "France" },
  { clue: "🐉万里", hint: "East Asian country with a rich history, known for the Great Wall and dragons", answer: "China" },
];

const POPCULTURE_QUESTIONS = [
  { clue: "⚡🧙‍♂️", hint: "A British orphan discovers he is a wizard and attends Hogwarts School of Witchcraft and Wizardry", answer: "Harry Potter" },
  { clue: "🦸‍♂️🛡️🇺🇸", hint: "A super-soldier from WWII who wields an indestructible shield and fights for justice", answer: "Captain America" },
  { clue: "👽📞🏠", hint: "A gentle alien stranded on Earth befriends a young boy and seeks to return to his home planet", answer: "E.T." },
  { clue: "🎮🍄", hint: "A popular Italian plumber video game character who rescues a princess in the Mushroom Kingdom", answer: "Mario" },
  { clue: "🧊👑", hint: "A Disney queen with magical powers to control ice and snow, whose kingdom is perpetually frozen", answer: "Elsa (Frozen)" },
  { clue: "🦖🏝️", hint: "A theme park where dinosaurs are brought back to life through cloning, leading to disastrous consequences", answer: "Jurassic Park" },
  { clue: "🎤👑", hint: "A legendary British rock band fronted by Freddie Mercury, known for their elaborate stage shows and anthemic songs", answer: "Queen" },
  { clue: "🛡️⚔️🐉", hint: "An epic fantasy television series about noble families battling for control of a fictional continent's Iron Throne", answer: "Game of Thrones" },
];

/* =========================
   CATEGORY STRUCTURE
   ========================= */
const ALL_CATEGORIES = {
  'christian': {
    name: 'Christian / Bible',
    subcategories: {
      'books': { name: '📖 Guess the Book', questions: BOOKS_QUESTIONS },
      'characters': { name: '👤 Guess the Character', questions: CHARACTER_QUESTIONS },
      'events': { name: '🗓️ Guess the Event', questions: BIBLICAL_EVENTS_QUESTIONS },
      'places': { name: '🗺️ Guess the Place', questions: BIBLICAL_PLACES_QUESTIONS },
      'parables': { name: '📖 Guess the Parable/Miracle', questions: PARABLES_AND_MIRACLES_QUESTIONS },
      'quotes': { name: '🗣️ Who Said It?', questions: WHO_SAID_IT_QUESTIONS },
    }
  },
  'tech': {
    name: 'Tech',
    subcategories: {
      'tech-terms': { name: '💻 Guess the Tech Term', questions: TECH_QUESTIONS }
    }
  },
  'geography': {
    name: 'Geography',
    subcategories: {
      'countries': { name: '🌍 Guess the Country', questions: COUNTRY_QUESTIONS }
    }
  },
  'popculture': {
    name: 'Pop Culture',
    subcategories: {
      'popculture-general': { name: '🌟 Guess the Pop Culture', questions: POPCULTURE_QUESTIONS }
    }
  }
};


/* =========================
   PERSISTENCE & STATE
   ========================= */
const STORAGE_KEY = 'bible_quiz_player_rounds_v2'; // Changed key to avoid conflicts with old version
function saveState(s){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }catch(e){console.warn('save failed',e);} }
function loadState(){ try{ const r=localStorage.getItem(STORAGE_KEY); return r?JSON.parse(r):null; }catch(e){return null;} }
function clearState(){ localStorage.removeItem(STORAGE_KEY); }

let state = {
  phase: 'setup',           // 'setup' | 'playing' | 'score'
  players: [],
  scores: {},
  deck: [],                 // remaining questions in category
  usedCountThisPlayer: 0,   // how many asked for current player
  questionsPerPlayer: 6,
  currentPlayerIndex: 0,
  currentQuestion: null,
  countdown: 0,
  mainCategory: 'christian',
  subCategory: 'books',
  timeBeforeHint: 5,
  timeAfterHint: 5
};

const namesInput = document.getElementById('namesInput');
const loadPlayersBtn = document.getElementById('loadPlayersBtn');
const resetNamesBtn = document.getElementById('resetNamesBtn');
const playersList = document.getElementById('playersList');
const numQuestionsInput = document.getElementById('numQuestions');
const startBtn = document.getElementById('startBtn');
const resumeBtn = document.getElementById('resumeBtn');
const mainCategorySelect = document.getElementById('mainCategorySelect');
const subCategorySelect = document.getElementById('subCategorySelect');
const timeBeforeHintInput = document.getElementById('timeBeforeHint');
const timeAfterHintInput = document.getElementById('timeAfterHint');
const clearStorageBtn = document.getElementById('clearStorageBtn');
const gameInner = document.getElementById('gameInner');

const tickSound = document.getElementById('tickSound');
const revealSound = document.getElementById('revealSound');
const endSound = document.getElementById('endSound');

let tickInterval = null;

/* =========================
   UTILITIES
   ========================= */
function shuffle(arr){ const a = arr.slice(); for(let i=a.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
function cloneDeckForCategory(mainCatKey, subCatKey){
  const mainCat = ALL_CATEGORIES[mainCatKey];
  if (mainCat && mainCat.subcategories[subCatKey]) {
    return mainCat.subcategories[subCatKey].questions.map(q=>({...q}));
  }
  // Fallback to default if category or subcategory is not found
  return ALL_CATEGORIES['christian'].subcategories['books'].questions.map(q=>({...q}));
}
function persist(){ saveState(state); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }

/* =========================
   PLAYERS & DRAG DROP
   ========================= */
function renderPlayers(){
  playersList.innerHTML = '';
  state.players.forEach((name, idx) => {
    const div = document.createElement('div');
    div.className = 'player';
    div.draggable = true;
    div.dataset.index = idx;
    div.innerHTML = `<div class="name">${escapeHtml(name)}</div><div class="handle muted">≡</div>`;
    playersList.appendChild(div);

    div.addEventListener('dragstart', e => {
      div.classList.add('dragging');
      e.dataTransfer.setData('text/plain', idx);
    });
    div.addEventListener('dragend', () => {
      div.classList.remove('dragging');
      const items = Array.from(playersList.querySelectorAll('.player'));
      state.players = items.map(it => it.querySelector('.name').textContent.trim());
      state.scores = state.scores || {};
      state.players.forEach(p => { if(typeof state.scores[p] === 'undefined') state.scores[p] = 0; });
      persist();
      renderPlayers();
    });
  });

  playersList.ondragover = e => {
    e.preventDefault();
    const dragging = playersList.querySelector('.dragging');
    const after = getDragAfterElement(playersList, e.clientY);
    if(!dragging) return;
    if(after == null) playersList.appendChild(dragging);
    else playersList.insertBefore(dragging, after);
  };
}
function getDragAfterElement(container, y){
  const draggable = [...container.querySelectorAll('.player:not(.dragging)')];
  let closest = {offset: Number.NEGATIVE_INFINITY, element: null};
  for(const child of draggable){
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height/2;
    if(offset < 0 && offset > closest.offset) closest = {offset, element: child};
  }
  return closest.element;
}

/* =========================
   CATEGORY SELECTION LOGIC
   ========================= */
function populateMainCategories() {
  mainCategorySelect.innerHTML = '';
  for (const key in ALL_CATEGORIES) {
    const option = document.createElement('option');
    option.value = key;
    option.textContent = ALL_CATEGORIES[key].name;
    mainCategorySelect.appendChild(option);
  }
  mainCategorySelect.value = state.mainCategory;
  populateSubCategories();
}

function populateSubCategories() {
  subCategorySelect.innerHTML = '';
  const selectedMainCategoryKey = mainCategorySelect.value;
  const subCats = ALL_CATEGORIES[selectedMainCategoryKey]?.subcategories;

  if (subCats) {
    for (const key in subCats) {
      const option = document.createElement('option');
      option.value = key;
      option.textContent = subCats[key].name;
      subCategorySelect.appendChild(option);
    }
  }
  if (state.subCategory && subCats && subCats[state.subCategory]) {
      subCategorySelect.value = state.subCategory;
  } else if (subCats) {
      const firstSubCatKey = Object.keys(subCats)[0];
      if (firstSubCatKey) {
          subCategorySelect.value = firstSubCatKey;
          state.subCategory = firstSubCatKey;
      }
  }
}

mainCategorySelect.addEventListener('change', () => {
  state.mainCategory = mainCategorySelect.value;
  populateSubCategories();
  state.subCategory = subCategorySelect.value;
  persist();
});

subCategorySelect.addEventListener('change', () => {
  state.subCategory = subCategorySelect.value;
  persist();
});


/* =========================
   SETUP HANDLERS
   ========================= */
loadPlayersBtn.addEventListener('click', ()=>{
  const raw = namesInput.value.split('\n').map(s=>s.trim()).filter(Boolean);
  if(raw.length === 0){ alert('Add at least one participant.'); return; }
  state.players = raw.slice();
  state.scores = {};
  state.players.forEach(p => state.scores[p] = 0);
  renderPlayers();
  persist();
});
resetNamesBtn.addEventListener('click', ()=>{ namesInput.value = ''; });

startBtn.addEventListener('click', ()=> {
  if(state.players.length === 0){ alert('Load players first (enter names and click Load Players).'); return; }
  const n = parseInt(numQuestionsInput.value) || 0;
  if(n <= 0){ alert('Enter valid number of questions'); return; }
  state.questionsPerPlayer = n;
  state.mainCategory = mainCategorySelect.value;
  state.subCategory = subCategorySelect.value;
  state.timeBeforeHint = Math.max(1, parseInt(timeBeforeHintInput.value) || 5);
  state.timeAfterHint = Math.max(1, parseInt(timeAfterHintInput.value) || 5);
  state.deck = shuffle(cloneDeckForCategory(state.mainCategory, state.subCategory));
  state.usedCountThisPlayer = 0;
  state.currentPlayerIndex = 0;
  state.scores = {}; state.players.forEach(p => state.scores[p] = 0);
  state.phase = 'playing';
  state.currentQuestion = null;
  state.countdown = 0;
  persist();
  renderGame();
  startPlayerRound(false);
});

resumeBtn.addEventListener('click', ()=> {
  const saved = loadState();
  if(!saved){ alert('No saved game found.'); return; }
  state = Object.assign(state, saved);
  namesInput.value = state.players.join('\n');
  numQuestionsInput.value = state.questionsPerPlayer || 6;
  timeBeforeHintInput.value = state.timeBeforeHint || 5;
  timeAfterHintInput.value = state.timeAfterHint || 5;
  populateMainCategories();
  mainCategorySelect.value = state.mainCategory;
  populateSubCategories();
  subCategorySelect.value = state.subCategory;
  renderPlayers();
  renderGame();
  if(state.phase === 'playing'){
    startTick();
  }
});

clearStorageBtn.addEventListener('click', ()=> {
  if(!confirm('Clear saved game and return to setup?')) return;
  clearState();
  state = {
    phase:'setup', players:[], scores:{}, deck:[], usedCountThisPlayer:0,
    questionsPerPlayer:6, currentPlayerIndex:0, currentQuestion:null, countdown:0,
    mainCategory:'christian', subCategory:'books', timeBeforeHint:5, timeAfterHint:5
  };
  namesInput.value = '';
  numQuestionsInput.value = 6;
  timeBeforeHintInput.value = 5;
  timeAfterHintInput.value = 5;
  populateMainCategories();
  renderPlayers();
  renderGame();
});

/* =========================
   RENDER / FLOW
   ========================= */
function renderGame(){
  if(state.phase === 'setup' || !state.players.length){
    gameInner.innerHTML = `<div class="muted">No game running. Configure players and click Start Round.</div>`;
    return;
  }
  if(state.phase === 'playing'){
    const cp = state.players[state.currentPlayerIndex] || '—';
    const qIndex = state.usedCountThisPlayer || 0;
    const currentSubCategoryDisplayName = ALL_CATEGORIES[state.mainCategory]
                                          ?.subcategories[state.subCategory]
                                          ?.name || '❓ Unknown Category';
    gameInner.innerHTML = `
      <div class="game-top">
        <div class="banner">
          <div class="category-badge">${currentSubCategoryDisplayName}</div>
          <div style="margin-top:8px;color:var(--muted)">Player</div>
          <div class="current-player">${escapeHtml(cp)}</div>
        </div>
        <div style="text-align:center">
          <div class="muted">Timer</div>
          <div class="timer" id="timerEl">${state.countdown || (state.timeBeforeHint + state.timeAfterHint)}</div>
        </div>
        <div style="text-align:right">
          <div class="muted">Player Progress</div>
          <div class="progress" id="progressEl">${qIndex} / ${state.questionsPerPlayer}</div>
        </div>
      </div>
      <div class="clue-box fade">
        <div class="clue" id="clueEl">${state.currentQuestion ? escapeHtml(state.currentQuestion.clue) : '—'}</div>
        <div class="hint" id="hintEl">${state.currentQuestion && state.countdown <= state.timeAfterHint ? '💡 ' + escapeHtml(state.currentQuestion.hint) : ''}</div>
        <div class="answer" id="answerEl">${state.currentQuestion && state.countdown <= 0 ? '✅ ' + escapeHtml(state.currentQuestion.answer) : ''}</div>
      </div>
      <div class="controls">
        <button class="btn big" id="gotItBtn">Got It!</button>
        <button class="btn big ghost" id="skipBtn">Skip (no point)</button>
        <button class="btn big ghost" id="endPlayerBtn">End This Player's Turn</button>
      </div>
      <div class="small-muted">Press "Got It!" to award the current player 1 point before reveal. Hint shows after ${state.timeBeforeHint}s, answer after ${state.timeAfterHint}s more.</div>
      <div style="margin-top:14px">
        <div class="muted">Scores</div>
        <div id="scoresList" style="margin-top:8px"></div>
      </div>
    `;
    renderScores();
    document.getElementById('gotItBtn').onclick = claimPoint;
    document.getElementById('skipBtn').onclick = ()=> revealAnswer(true);
    document.getElementById('endPlayerBtn').onclick = ()=> {
      state.currentPlayerIndex = (state.currentPlayerIndex + 1) % state.players.length;
      state.usedCountThisPlayer = 0;
      state.currentQuestion = null;
      state.countdown = 0;
      persist();
      renderGame();
      setTimeout(()=> startPlayerRound(false), 600);
    };
    return;
  }

  if(state.phase === 'score'){
    const rows = state.players.map((p,i)=>`<div class="score-row"><div>${i+1}. ${escapeHtml(p)}</div><div>${state.scores[p]||0}</div></div>`).join('');
    gameInner.innerHTML = `
      <h2 style="margin:6px 0 12px;color:var(--accent)">Round Results</h2>
      ${rows}
      <div style="display:flex;gap:10px;margin-top:12px">
        <button class="btn" id="nextFullRoundBtn">Next Round (same players)</button>
        <button class="btn ghost" id="backSetupBtn">Back to Setup</button>
      </div>
    `;
    document.getElementById('nextFullRoundBtn').onclick = ()=> {
      state.deck = shuffle(cloneDeckForCategory(state.mainCategory, state.subCategory));
      state.usedCountThisPlayer = 0;
      state.currentPlayerIndex = 0;
      state.scores = {}; state.players.forEach(p=>state.scores[p]=0);
      state.phase = 'playing'; state.currentQuestion=null; state.countdown=0;
      persist(); renderGame(); startPlayerRound(false);
    };
    document.getElementById('backSetupBtn').onclick = ()=> { state.phase='setup'; persist(); renderGame(); };
    return;
  }
}

function renderScores(){
  const box = document.getElementById('scoresList');
  if(!box) return;
  box.innerHTML = state.players.map(p=>`<div class="score-row"><div>${escapeHtml(p)}</div><div>${state.scores[p]||0}</div></div>`).join('');
}

/* =========================
   ROUND / PLAYER / QUESTION FLOW
   ========================= */
function startPlayerRound(resume=false){
  if(!state.deck || state.deck.length === 0) state.deck = shuffle(cloneDeckForCategory(state.mainCategory, state.subCategory));
  if(!resume) state.usedCountThisPlayer = 0;
  state.phase = 'playing';
  persist();
  startQuestion(resume);
}

function startQuestion(resume=false){
  if(state.usedCountThisPlayer >= state.questionsPerPlayer){
    state.currentPlayerIndex++;
    state.usedCountThisPlayer = 0;
    if(state.currentPlayerIndex >= state.players.length){
      endFullRound();
      return;
    } else {
      persist();
      renderGame();
      setTimeout(()=> startPlayerRound(false), 350);
      return;
    }
  }

  if(!state.deck || state.deck.length === 0) state.deck = shuffle(cloneDeckForCategory(state.mainCategory, state.subCategory));

  const idx = Math.floor(Math.random() * state.deck.length);
  state.currentQuestion = state.deck.splice(idx,1)[0];
  state.usedCountThisPlayer = (state.usedCountThisPlayer || 0) + 1;
  state.countdown = state.timeBeforeHint + state.timeAfterHint;
  persist();
  renderGame();
  stopTick();
  safePlay(tickSound);
  startTick();
}

function startTick(){
  stopTick();
  tickInterval = setInterval(()=>{
    state.countdown--;
    const timerEl = document.getElementById('timerEl'); if(timerEl) timerEl.textContent = state.countdown;
    if(state.countdown > 0) safePlay(tickSound);
    if(state.countdown === state.timeAfterHint){
      const hintEl = document.getElementById('hintEl'); if(hintEl && state.currentQuestion) hintEl.textContent = '💡 ' + state.currentQuestion.hint;
      safePlay(revealSound);
    }
    if(state.countdown <= 0){
      revealAnswer(false);
    }
    persist();
  }, 1000);
}
function stopTick(){ if(tickInterval){ clearInterval(tickInterval); tickInterval=null; } }

function revealAnswer(skipped){
  stopTick();
  state.countdown = 0;
  const ansEl = document.getElementById('answerEl');
  if(ansEl && state.currentQuestion) ansEl.textContent = '✅ ' + state.currentQuestion.answer + (skipped ? ' — skipped (no point)' : '');
  safePlay(revealSound); safePlay(endSound);
  const got = document.getElementById('gotItBtn'); if(got) got.onclick = null;
  const skip = document.getElementById('skipBtn'); if(skip) skip.onclick = null;

  setTimeout(()=>{
    if(state.usedCountThisPlayer < state.questionsPerPlayer){
      persist();
      startQuestion(false);
    } else {
      state.currentPlayerIndex++;
      state.usedCountThisPlayer = 0;
      if(state.currentPlayerIndex >= state.players.length){
        endFullRound();
      } else {
        persist();
        renderGame();
        setTimeout(()=> startPlayerRound(false), 600);
      }
    }
  }, 900);
}

function claimPoint(){
  if(!state.currentQuestion || state.countdown <= 0) return;
  const player = state.players[state.currentPlayerIndex];
  state.scores[player] = (state.scores[player] || 0) + 1;
  persist();
  revealAnswer(false);
}

function endFullRound(){
  stopTick();
  state.phase = 'score';
  persist();
  renderGame();
}

function safePlay(audioEl){
  if(!audioEl) return;
  try{ audioEl.currentTime = 0; const p = audioEl.play(); if(p && typeof p.then === 'function') p.catch(()=>{}); }catch(e){}
}

/* =========================
   BOOT: load existing state if present
   ========================= */
(function init(){
  const saved = loadState();
  if(saved){
    state = Object.assign(state, saved);
    namesInput.value = state.players.join('\n');
    numQuestionsInput.value = state.questionsPerPlayer || 6;
    timeBeforeHintInput.value = state.timeBeforeHint || 5;
    timeAfterHintInput.value = state.timeAfterHint || 5;
  } else {
    state.mainCategory = 'christian';
    state.subCategory = 'books';
  }
  populateMainCategories();
  renderPlayers();
  renderGame();
})();

</script>
</body>
</html>
